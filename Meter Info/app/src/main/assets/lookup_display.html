<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßÅ‡¶ï‡¶Ü‡¶™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 0;
            border: 2px solid #3498db;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .search-section {
            background: #2c3e50;
            padding: 20px;
            border-radius: 0;
            margin-bottom: 20px;
            border: 1px solid #34495e;
        }

        .type-selector {
            display: flex;
            margin-bottom: 15px;
            border: 1px solid #34495e;
            border-radius: 0;
            overflow: hidden;
        }

        .type-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: #34495e;
            border: none;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            color: #bdc3c7;
            transition: all 0.3s ease;
        }

        .type-btn.active {
            background: #3498db;
            color: white;
            font-weight: bold;
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #34495e;
            border-radius: 0;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: #2c3e50;
            color: #e0e0e0;
        }

        .search-btn {
            padding: 12px 24px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .search-btn:hover {
            background: #219a52;
        }

        .search-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            color: #3498db;
            padding: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        .error {
            display: none;
            color: #e74c3c;
            background: #c0392b;
            padding: 12px;
            border-radius: 0;
            margin-top: 10px;
            border: 1px solid #e74c3c;
            font-family: 'Courier New', monospace;
        }

        .data-section {
            display: none;
            background: #1a1a1a;
            border-radius: 0;
            padding: 0;
            margin-bottom: 20px;
        }

        .section-title {
            background: #2c3e50;
            color: #3498db;
            padding: 12px 15px;
            margin: 20px 0 15px 0;
            border-radius: 0;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid #3498db;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .subsection-title {
            background: #34495e;
            color: #bdc3c7;
            padding: 10px 15px;
            margin: 15px 0 10px 0;
            border-radius: 0;
            font-weight: bold;
            border-left: 4px solid #3498db;
            font-family: 'Courier New', monospace;
        }

        .info-grid {
            display: block;
            margin: 10px 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid #34495e;
            font-family: 'Courier New', monospace;
        }

        .info-label {
            font-weight: bold;
            color: #3498db;
            min-width: 200px;
        }

        .info-value {
            color: #e0e0e0;
            text-align: right;
            flex: 1;
        }

        .table-container {
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #34495e;
            border-radius: 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }

        .data-table th {
            background: #2c3e50;
            color: #3498db;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #34495e;
        }

        .data-table td {
            padding: 10px 8px;
            border: 1px solid #34495e;
            text-align: left;
            color: #e0e0e0;
        }

        .data-table tr:nth-child(even) {
            background: #2c3e50;
        }

        .data-table tr:hover {
            background: #34495e;
        }

        .amount-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .amount-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            flex: 1;
            min-width: 120px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: bold;
        }

        .btn-print {
            background: #2980b9;
            color: white;
        }

        .btn-print:hover {
            background: #2471a3;
        }

        .btn-pdf {
            background: #27ae60;
            color: white;
        }

        .btn-pdf:hover {
            background: #219a52;
        }

        .btn-new-search {
            background: #7f8c8d;
            color: white;
        }

        .btn-new-search:hover {
            background: #707b7c;
        }

        .btn-close {
            background: #c0392b;
            color: white;
        }

        .btn-close:hover {
            background: #a93226;
        }

        .emoji {
            font-size: 16px;
        }

        .summary-card {
            background: #2c3e50;
            border: 1px solid #3498db;
            border-radius: 0;
            padding: 15px;
            margin: 15px 0;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            text-align: center;
            padding: 10px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin: 5px 0;
        }

        .summary-label {
            color: #bdc3c7;
            font-size: 12px;
        }

        /* Terminal-like styles */
        .terminal-line {
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }

        .terminal-section {
            border-top: 2px solid #3498db;
            border-bottom: 2px solid #3498db;
            margin: 20px 0;
            padding: 15px 0;
        }

        .token-section {
            background: #2c3e50;
            border: 1px solid #34495e;
            padding: 15px;
            margin: 10px 0;
        }

        .token-order {
            margin: 15px 0;
            padding: 10px;
            background: #34495e;
            border-left: 4px solid #e74c3c;
        }

        .balance-section {
            background: #c0392b;
            border: 2px solid #e74c3c;
            padding: 15px;
            margin: 15px 0;
        }

        .divider {
            border-top: 2px solid #3498db;
            margin: 20px 0;
            text-align: center;
            color: #3498db;
            font-weight: bold;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .search-row {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .info-item {
                flex-direction: column;
                text-align: left;
            }

            .info-value {
                text-align: left;
                margin-top: 5px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            .search-section,
            .action-buttons {
                display: none !important;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
                color: black;
            }

            .data-section {
                display: block !important;
                box-shadow: none;
                padding: 0;
            }

            .section-title {
                background: #333 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>üìä ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßÅ‡¶ï‡¶Ü‡¶™ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</h1>
            <p>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</p>
        </div>

        <!-- Search Section -->
        <div class="search-section" id="searchSection">
            <div class="type-selector">
                <button class="type-btn active" id="prepaidBtn" onclick="selectType('prepaid')">
                    ‚ö° ‡¶™‡ßç‡¶∞‡¶ø‡¶™‡ßá‡¶á‡¶° ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞
                </button>
                <button class="type-btn" id="postpaidBtn" onclick="selectType('postpaid')">
                    üí≥ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶™‡ßá‡¶á‡¶° ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞
                </button>
                </div>

<!-- ADD POSTPAID OPTIONS HERE -->
<div class="postpaid-options" id="postpaidOptions" style="display: none; margin-bottom: 15px;">
    <div class="type-selector">
        <button class="type-btn active" id="consumerNoOption" onclick="selectPostpaidType('consumer_no')">
            üë§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç
        </button>
        <button class="type-btn" id="meterNoOption" onclick="selectPostpaidType('meter_no')">
            üî¢ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç
        </button>
    </div>
</div>

<div class="search-row">
            </div>

            <div class="search-row">
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="‡ßß‡ß® ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" autofocus>
                <button onclick="fetchData()" id="searchBtn" class="search-btn">
                    üîç ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
                </button>
            </div>

            <div class="loading" id="loading">
                ‚è≥ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...
            </div>

            <div class="error" id="error"></div>
        </div>

        <!-- Data Display Section -->
        <div class="data-section" id="dataSection">
            <div id="dataContent">
                <!-- Data will be populated by JavaScript -->
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-print" onclick="window.print()">
                    üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
                </button>
                <button class="btn btn-pdf" onclick="saveAsPDF()">
                    üìÑ PDF ‡¶∏‡ßá‡¶≠
                </button>
                <button class="btn btn-new-search" onclick="showSearchSection()">
                    üîÑ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡ßã‡¶Å‡¶ú
                </button>
                <button class="btn btn-close" onclick="closeLookup()">
                    ‚úï ‡¶¨‡¶®‡ßç‡¶ß
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentType = 'prepaid';

// ADD THESE LINES HERE
let postpaidSubType = 'consumer_no';

function selectPostpaidType(subType) {
    postpaidSubType = subType;
    document.getElementById('consumerNoOption').classList.toggle('active', subType === 'consumer_no');
    document.getElementById('meterNoOption').classList.toggle('active', subType === 'meter_no');
    updateInputPlaceholder();
}

function updateInputPlaceholder() {
    const input = document.getElementById('searchInput');
    if (currentType === 'prepaid') {
        input.placeholder = '‡ßß‡ß® ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
    } else {
        input.placeholder = postpaidSubType === 'consumer_no' ? '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®' : '‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
    }
}

        function selectType(type) {
    currentType = type;

    // Update button states
    document.getElementById('prepaidBtn').classList.toggle('active', type === 'prepaid');
    document.getElementById('postpaidBtn').classList.toggle('active', type === 'postpaid');

    // NEW: Show/hide postpaid options
    document.getElementById('postpaidOptions').style.display = type === 'postpaid' ? 'block' : 'none';
    
    // NEW: Update placeholder
    updateInputPlaceholder();

    // Clear previous results
    clearResults();
}


        function fetchData() {
            const input = document.getElementById('searchInput').value.trim();
            if (!input) {
                showError('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!');
                return;
            }

            showLoading();

            // Call Android interface
            if (window.AndroidInterface) {
                try {
                    const result = AndroidInterface.fetchLookupData(input, currentType);
                    const data = JSON.parse(result);
                    console.log("üìä Received data from Android:", data);
                    displayData(data);
                } catch (err) {
                    showError('‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + err.message);
                }
            } else {
                showError('AndroidInterface ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø');
            }
        }

        function displayData(data) {
            hideLoading();

            if (data.error) {
                showError(data.error);
                return;
            }

            // Show data section and hide search
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('dataSection').style.display = 'block';

            // Generate and display formatted data
            const dataContent = document.getElementById('dataContent');
            dataContent.innerHTML = generateFormattedHTML(data);
        }

        function generateFormattedHTML(data) {
            let html = '';

            console.log("üîç Generating HTML for data:", data);

            // METER INFO SECTION
            html += `<div class="terminal-section">
                        <div class="section-title">
                            üìä ${(data.type || 'UNKNOWN').toUpperCase()} METER INFO
                        </div>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">üî¢ Meter Number:</span>
                                <span class="info-value">${data.meter_number || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üë§ Consumer Number:</span>
                                <span class="info-value">${data.consumer_number || data.customer_number || 'N/A'}</span>
                            </div>
                        </div>
                    </div>`;

            // PREPAID CUSTOMER DETAILS
            if (data.prepaid_customer_details && Object.keys(data.prepaid_customer_details).length > 0) {
                html += `<div class="terminal-section">
                            <div class="section-title">
                                üìã PREPAID CUSTOMER DETAILS
                            </div>
                            <div class="subsection-title">üë§ CUSTOMER INFORMATION</div>
                            <div class="info-grid">`;

                const prepaidFields = [
                    'Address', 'Installation Date', 'Sanctioned Load', 'Sub Division', 
                    'Lock Status', 'Name', 'Tariff Category', 'Total Recharge This Month',
                    'Consumer Number', 'Phone', 'Meter Type', 'Connection Category', 
                    'Division', 'Meter Number', 'Last Recharge Time', 'Account Type', 
                    'Last Recharge Amount'
                ];

                prepaidFields.forEach(field => {
                    if (data.prepaid_customer_details[field] && data.prepaid_customer_details[field] !== 'N/A') {
                        html += `<div class="info-item">
                                    <span class="info-label">‚Ä¢ ${field}:</span>
                                    <span class="info-value">${data.prepaid_customer_details[field]}</span>
                                 </div>`;
                    }
                });

                html += `</div></div>`;
            }

            // RECHARGE TOKENS
            if (data.recharge_history && data.recharge_history.length > 0) {
                html += `<div class="terminal-section">
                            <div class="subsection-title">üîë LAST 3 RECHARGE TOKENS</div>`;

                data.recharge_history.forEach((transaction, index) => {
                    html += `<div class="token-order">
                                <div class="terminal-line"><strong>Order ${index + 1}:</strong></div>
                                <div class="terminal-line">  üìÖ Date: ${transaction.Date || 'N/A'}</div>
                                <div class="terminal-line">  üßæ Order: ${transaction['Order Number'] || 'N/A'}</div>
                                <div class="terminal-line">  üë§ Operator: ${transaction.Operator || 'N/A'}</div>
                                <div class="terminal-line">  üî¢ Sequence: ${transaction.Sequence || 'N/A'}</div>
                                <div class="terminal-line">  üí∞ Amount: ${transaction.Amount || '‡ß¶'}</div>
                                <div class="terminal-line">  ‚ö° Energy: ${transaction['Energy Cost'] || '‡ß¶'}</div>
                                <div class="terminal-line" style="color: #e74c3c; font-weight: bold;">  üîë TOKENS: ${transaction.Tokens || 'N/A'}</div>
                             </div>`;
                });

                html += `</div>`;
            }

            // CUSTOMER INFORMATION FROM SERVER
            if (data.customer_info && Object.keys(data.customer_info).length > 0) {
                html += `<div class="terminal-section">
                            <div class="section-title">üë§ CUSTOMER INFORMATION</div>`;

                // Personal Information
                const personalFields = ['Customer Name', 'Father Name', 'Customer Address'];
                const hasPersonalInfo = personalFields.some(field => 
                    data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null'
                );

                if (hasPersonalInfo) {
                    html += `<div class="subsection-title">üìã PERSONAL INFORMATION</div>
                             <div class="info-grid">`;
                    
                    personalFields.forEach(field => {
                        if (data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null') {
                            html += `<div class="info-item">
                                        <span class="info-label">‚Ä¢ ${field}:</span>
                                        <span class="info-value">${data.customer_info[field]}</span>
                                     </div>`;
                        }
                    });
                    html += `</div>`;
                }

                // Meter Information
                const meterFields = ['Meter Number', 'Meter Status', 'Connection Date'];
                const hasMeterInfo = meterFields.some(field => 
                    data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null'
                );

                if (hasMeterInfo) {
                    html += `<div class="subsection-title">üîß METER INFORMATION</div>
                             <div class="info-grid">`;
                    
                    meterFields.forEach(field => {
                        if (data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null') {
                            html += `<div class="info-item">
                                        <span class="info-label">‚Ä¢ ${field}:</span>
                                        <span class="info-value">${data.customer_info[field]}</span>
                                     </div>`;
                        }
                    });
                    html += `</div>`;
                }

                // Billing Information
                const billingFields = ['Customer Number', 'Location Code', 'Bill Group', 'Account_Number'];
                const hasBillingInfo = billingFields.some(field => 
                    data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null'
                );

                if (hasBillingInfo) {
                    html += `<div class="subsection-title">üí≥ BILLING INFORMATION</div>
                             <div class="info-grid">`;
                    
                    billingFields.forEach(field => {
                        if (data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null') {
                            html += `<div class="info-item">
                                        <span class="info-label">‚Ä¢ ${field}:</span>
                                        <span class="info-value">${data.customer_info[field]}</span>
                                     </div>`;
                        }
                    });
                    html += `</div>`;
                }

                // Technical Information
                const technicalFields = ['Usage Type', 'Description', 'Start Bill Cycle'];
                const hasTechnicalInfo = technicalFields.some(field => 
                    data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null'
                );

                if (hasTechnicalInfo) {
                    html += `<div class="subsection-title">‚öôÔ∏è TECHNICAL INFORMATION</div>
                             <div class="info-grid">`;
                    
                    technicalFields.forEach(field => {
                        if (data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null') {
                            html += `<div class="info-item">
                                        <span class="info-label">‚Ä¢ ${field}:</span>
                                        <span class="info-value">${data.customer_info[field]}</span>
                                     </div>`;
                        }
                    });
                    html += `</div>`;
                }

                // Meter Readings
                const readingFields = ['Current Reading SR', 'Last Bill Reading SR', 'Last Bill Reading OF PK', 'Last Bill Reading PK'];
                const hasReadings = readingFields.some(field => 
                    data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null'
                );

                if (hasReadings) {
                    html += `<div class="subsection-title">üìä METER READINGS</div>
                             <div class="info-grid">`;
                    
                    readingFields.forEach(field => {
                        if (data.customer_info[field] && data.customer_info[field] !== 'N/A' && data.customer_info[field] !== 'null') {
                            html += `<div class="info-item">
                                        <span class="info-label">‚Ä¢ ${field}:</span>
                                        <span class="info-value">${data.customer_info[field]}</span>
                                     </div>`;
                        }
                    });
                    html += `</div>`;
                }

                html += `</div>`;
            }

            // BILL SUMMARY
            if (data.bill_summary) {
                html += `<div class="terminal-section">
                            <div class="section-title">üìä BILL SUMMARY</div>
                            <div class="info-grid">`;

                const summary = data.bill_summary;
                const firstBill = data.bill_info && data.bill_info.length > 0 ? data.bill_info[data.bill_info.length - 1] : null;
                const lastBill = data.bill_info && data.bill_info.length > 0 ? data.bill_info[0] : null;

                if (firstBill && firstBill.BILL_MONTH) {
                    html += `<div class="info-item">
                                <span class="info-label">First Bill Period</span>
                                <span class="info-value">${formatBillMonth(firstBill.BILL_MONTH)}</span>
                             </div>`;
                }

                if (lastBill && lastBill.BILL_MONTH) {
                    html += `<div class="info-item">
                                <span class="info-label">Last Bill Period</span>
                                <span class="info-value">${formatBillMonth(lastBill.BILL_MONTH)}</span>
                             </div>`;
                }

                html += `<div class="info-item">
                            <span class="info-label">Total Bills</span>
                            <span class="info-value">${summary.total_bills || (data.bill_info ? data.bill_info.length : 0)}</span>
                         </div>
                         <div class="info-item">
                            <span class="info-label">Total Amount</span>
                            <span class="info-value">‡ß≥${((summary.total_amount || 0)).toFixed(0)}</span>
                         </div>
                         <div class="info-item">
                            <span class="info-label">Total Paid</span>
                            <span class="info-value">‡ß≥${((summary.total_paid || 0)).toFixed(0)}</span>
                         </div>
                         <div class="info-item">
                            <span class="info-label">Arrears</span>
                            <span class="info-value">‡ß≥${((summary.arrears || 0)).toFixed(0)}</span>
                         </div>
                         </div></div>`;
            }

            // BALANCE INFORMATION
            if (data.balance_info && Object.keys(data.balance_info).length > 0) {
                html += `<div class="terminal-section">
                            <div class="subsection-title">üí∞ FINAL BALANCE DETAILS</div>
                            <div class="info-grid">`;

                const balanceOrder = ['Total Balance', 'Arrear Amount', 'PRN', 'LPS', 'VAT'];
                
                balanceOrder.forEach(key => {
                    if (data.balance_info[key] && data.balance_info[key] !== 'N/A' && data.balance_info[key] !== '') {
                        html += `<div class="info-item">
                                    <span class="info-label">‚Ä¢ ${key}:</span>
                                    <span class="info-value">${data.balance_info[key]}</span>
                                 </div>`;
                    }
                });

                html += `</div></div>`;
            }

            // BILL TABLE
            if (data.bill_info && data.bill_info.length > 0) {
                html += `<div class="terminal-section">
                            <div class="section-title">üìã BILL DETAILS</div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Bill Month</th>
                                            <th>Bill No</th>
                                            <th>Consumption</th>
                                            <th>Current Bill</th>
                                            <th>Due Date</th>
                                            <th>Paid</th>
                                            <th>Pay Date</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;

                // Show only last 5 bills for better readability
                const displayBills = data.bill_info.slice(0, 5);
                
                displayBills.forEach(bill => {
                    const balance = parseFloat(bill.BALANCE) || 0;
                    const balanceClass = balance === 0 ? 'amount-positive' : 'amount-negative';
                    const balanceDisplay = balance === 0 ? '‚Äî' : `‡ß≥${Math.abs(balance).toFixed(0)}`;

                    html += `<tr>
                                <td>${formatBillMonth(bill.BILL_MONTH)}</td>
                                <td>${bill.BILL_NO || '‚Äî'}</td>
                                <td>${bill.CONS_KWH_SR || bill.consumption || '‚Äî'}</td>
                                <td>‡ß≥${((bill.CURRENT_BILL || bill.TOTAL_BILL || 0)).toFixed(0)}</td>
                                <td>${formatDate(bill.INVOICE_DUE_DATE)}</td>
                                <td>‡ß≥${((bill.PAID_AMT || 0)).toFixed(0)}</td>
                                <td>${formatDate(bill.RECEIPT_DATE)}</td>
                                <td class="${balanceClass}">${balanceDisplay}</td>
                            </tr>`;
                });

                html += `</tbody></table></div>`;
                
                if (data.bill_info.length > 5) {
                    html += `<div class="terminal-line" style="text-align: center; color: #bdc3c7; margin-top: 10px;">
                                ... and ${data.bill_info.length - 5} more bills
                             </div>`;
                }
                
                html += `</div>`;
            }

            return html;
        }

        function formatBillMonth(dateStr) {
            if (!dateStr || dateStr === 'N/A') return 'N/A';

            try {
                if (dateStr.includes('-')) {
                    const [year, month] = dateStr.split('-');
                    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

                    if (month && year) {
                        const monthIndex = parseInt(month) - 1;
                        if (monthIndex >= 0 && monthIndex < 12) {
                            return `${monthNames[monthIndex]}-${year}`;
                        }
                    }
                }
                return dateStr;
            } catch (e) {
                return dateStr;
            }
        }

        function formatDate(dateString) {
            if (!dateString || dateString === 'N/A' || dateString === 'null') return '‚Äî';
            try {
                return dateString.contains("T") ? dateString.split("T")[0] : dateString;
            } catch (e) {
                return dateString;
            }
        }

        function showLoading() {
            document.getElementById("loading").style.display = "block";
            document.getElementById("error").style.display = "none";
            document.getElementById("searchBtn").disabled = true;
            document.getElementById("searchBtn").textContent = "‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...";
        }

        function hideLoading() {
            document.getElementById("loading").style.display = "none";
            document.getElementById("searchBtn").disabled = false;
            document.getElementById("searchBtn").textContent = "‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®";
        }

        function showError(message) {
            const errorDiv = document.getElementById("error");
            errorDiv.textContent = message;
            errorDiv.style.display = "block";
            hideLoading();
        }

        function clearResults() {
            document.getElementById("dataContent").innerHTML = "";
            document.getElementById("error").style.display = "none";
        }

        function showSearchSection() {
            document.getElementById("dataSection").style.display = "none";
            document.getElementById("searchSection").style.display = "block";
            document.getElementById("searchInput").value = "";
            document.getElementById("searchInput").focus();
            clearResults();
        }

        function closeLookup() {
            if (window.AndroidInterface) {
                AndroidInterface.closeLookup();
            } else {
                window.close();
            }
        }

        function saveAsPDF() {
            if (window.AndroidInterface) {
                AndroidInterface.saveAsPDF();
            } else {
                window.print();
            }
        }

        // Handle Enter key press
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchData();
            }
        });

        // Initialize
        document.getElementById('searchInput').focus();
    </script>
</body>
</html>
