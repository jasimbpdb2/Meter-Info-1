<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßÅ‡¶ï‡¶Ü‡¶™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #ffffff;
            color: #333333;
            line-height: 1.6;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px 15px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #000000;
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 8px rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 8px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .header p {
            font-size: 14px;
            color: #000000;
            text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .type-selector {
            display: flex;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            overflow: hidden;
            background: #ffffff;
        }

        .type-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: #ffffff;
            border: none;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            color: #6c757d;
            transition: all 0.3s ease;
            border-right: 1px solid #ced4da;
        }

        .type-btn:last-child {
            border-right: none;
        }

        .type-btn.active {
            background: #3498db;
            color: white;
            font-weight: bold;
        }

        .postpaid-options {
            margin-bottom: 15px;
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: #ffffff;
            color: #333333;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .search-btn {
            padding: 12px 24px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .search-btn:hover {
            background: #219a52;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .search-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            color: #3498db;
            padding: 15px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: #e8f4fd;
            border-radius: 6px;
            margin-top: 10px;
        }

        .error {
            display: none;
            color: #721c24;
            background: #f8d7da;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #f5c6cb;
            font-family: 'Courier New', monospace;
        }

        .data-section {
            display: none;
            background: #ffffff;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #000000;
            padding: 15px 20px;
            margin: 0 0 20px 0;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 18px;
            border: none;
            text-align: center;
            font-family: 'Courier New', monospace;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .subsection-title {
            background: #e9ecef;
            color: #2c3e50;
            padding: 12px 20px;
            margin: 20px 0 15px 0;
            border-radius: 6px;
            font-weight: bold;
            border-left: 4px solid #27ae60;
            font-family: 'Courier New', monospace;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .info-grid {
            display: block;
            margin: 10px 0;
            background: #ffffff;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            font-family: 'Courier New', monospace;
            transition: background-color 0.2s ease;
        }

        .info-item:hover {
            background: #f8f9fa;
        }

        .info-label {
            font-weight: bold;
            color: #2c3e50;
            min-width: 200px;
        }

        .info-value {
            color: #34495e;
            text-align: right;
            flex: 1;
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            background: #ffffff;
        }

        .data-table th {
            background: #27ae60;
            color: #000000;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #dee2e6;
            text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.6);
        }

        .data-table td {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            text-align: left;
            color: #2c3e50;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e8f4fd;
        }

        .amount-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .amount-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            flex: 1;
            min-width: 120px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn-print {
            background: #2980b9;
            color: white;
        }

        .btn-print:hover {
            background: #2471a3;
        }

        .btn-pdf {
            background: #27ae60;
            color: white;
        }

        .btn-pdf:hover {
            background: #219a52;
        }

        .btn-new-search {
            background: #7f8c8d;
            color: white;
        }

        .btn-new-search:hover {
            background: #707b7c;
        }

        .btn-close {
            background: #c0392b;
            color: white;
        }

        .btn-close:hover {
            background: #a93226;
        }

        .emoji {
            font-size: 16px;
        }

        .summary-card {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            text-align: center;
            padding: 10px;
            background: #ffffff;
            border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
            margin: 5px 0;
        }

        .summary-label {
            color: #6c757d;
            font-size: 12px;
            font-weight: 500;
        }

        /* Terminal-like styles */
        .terminal-line {
            margin: 5px 0;
            font-family: 'Courier New', monospace;
            color: #333333;
        }

        .terminal-section {
            border-top: 2px solid #27ae60;
            border-bottom: 2px solid #27ae60;
            margin: 20px 0;
            padding: 15px 0;
            background: #ffffff;
        }

        .token-section {
            background: #e8f4fd;
            border: 1px solid #3498db;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
        }

        .token-order {
            margin: 15px 0;
            padding: 12px;
            background: #ffffff;
            border-left: 4px solid #e74c3c;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .balance-section {
            background: #f8d7da;
            border: 2px solid #e74c3c;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            color: #721c24;
        }

        .divider {
            border-top: 2px solid #27ae60;
            margin: 20px 0;
            text-align: center;
            color: #27ae60;
            font-weight: bold;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .search-row {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .info-item {
                flex-direction: column;
                text-align: left;
            }

            .info-value {
                text-align: left;
                margin-top: 5px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 12px;
            }
        }

        @media print {
            .search-section,
            .action-buttons {
                display: none !important;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
                color: black;
            }

            .data-section {
                display: block !important;
                box-shadow: none;
                padding: 0;
                background: white;
            }

            .section-title {
                background: #27ae60 !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
            }

            .info-item {
                border-bottom: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header Section -->
    <div class="header">
        <h1>BANGLADESH POWER DEVELOPMENT BOARD (BPDB)</h1>
        <p>Customer/Meter Information</p>
    </div>

    <!-- Search Section -->
    <div class="search-section" id="searchSection">
        <div class="type-selector">
            <button class="type-btn active" id="prepaidBtn" onclick="selectType('prepaid')">
                ‚ö° ‡¶™‡ßç‡¶∞‡¶ø‡¶™‡ßá‡¶á‡¶° ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞
            </button>
            <button class="type-btn" id="postpaidBtn" onclick="selectType('postpaid')">
                üí≥ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶™‡ßá‡¶á‡¶° ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞
            </button>
        </div>

        <!-- Postpaid Options -->
        <div class="postpaid-options" id="postpaidOptions" style="display: none; margin-bottom: 15px;">
            <div class="type-selector">
                <button class="type-btn active" id="consumerNoOption" onclick="selectPostpaidType('consumer_no')">
                    üë§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç
                </button>
                <button class="type-btn" id="meterNoOption" onclick="selectPostpaidType('meter_no')">
                    üî¢ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç
                </button>
            </div>
        </div>

        <!-- Search Input Row -->
        <div class="search-row">
            <input type="text" id="searchInput" class="search-input"
                   placeholder="‡ßß‡ß® ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" autofocus>
            <button onclick="fetchData()" id="searchBtn" class="search-btn">
                üîç ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
            </button>
        </div>

        <div class="loading" id="loading">
            ‚è≥ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...
        </div>

        <div class="error" id="error"></div>
    </div>

    <!-- Data Display Section -->
    <div class="data-section" id="dataSection">
        <div id="dataContent">
            <!-- Data will be populated by JavaScript -->
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-print" onclick="window.print()">
                üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
            </button>
            <button class="btn btn-pdf" onclick="saveAsPDF()">
                üìÑ PDF ‡¶∏‡ßá‡¶≠
            </button>
            <button class="btn btn-new-search" onclick="showSearchSection()">
                üîÑ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡ßã‡¶Å‡¶ú
            </button>
            <button class="btn btn-close" onclick="closeLookup()">
                ‚úï ‡¶¨‡¶®‡ßç‡¶ß
            </button>
        </div>
    </div>
</div>

<script>
        let currentType = 'prepaid';
        let postpaidSubType = 'consumer_no';

        function selectPostpaidType(subType) {
            postpaidSubType = subType;
            document.getElementById('consumerNoOption').classList.toggle('active', subType === 'consumer_no');
            document.getElementById('meterNoOption').classList.toggle('active', subType === 'meter_no');
            updateInputPlaceholder();
        }

        function updateInputPlaceholder() {
            const input = document.getElementById('searchInput');
            if (currentType === 'prepaid') {
                input.placeholder = '‡ßß‡ß® ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
            } else {
                input.placeholder = postpaidSubType === 'consumer_no' ? '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®' : '‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
            }
        }

        function selectType(type) {
            currentType = type;

            // Update button states
            document.getElementById('prepaidBtn').classList.toggle('active', type === 'prepaid');
            document.getElementById('postpaidBtn').classList.toggle('active', type === 'postpaid');

            // Show/hide postpaid options
            document.getElementById('postpaidOptions').style.display = type === 'postpaid' ? 'block' : 'none';

            // Update placeholder
            updateInputPlaceholder();

            // Clear previous results
            clearResults();
        }

        function fetchData() {
            const input = document.getElementById('searchInput').value.trim();
            if (!input) {
                showError('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!');
                return;
            }

            // Validation
            if (currentType === 'prepaid' && input.length !== 12) {
                showError('‡¶™‡ßç‡¶∞‡¶ø‡¶™‡ßá‡¶á‡¶° ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡ßß‡ß® ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!');
                return;
            }
            document.getElementById('searchInput').blur();

            showLoading();

            // Call Android interface
            if (window.AndroidInterface) {
                try {
                    // Pass subType parameter for postpaid
                    const result = currentType === 'postpaid'
                        ? AndroidInterface.fetchLookupData(input, currentType, postpaidSubType)
                        : AndroidInterface.fetchLookupData(input, currentType, "none");

                    const data = JSON.parse(result);
                    console.log("üìä Received data from Android:", data);
                    displayData(data);
                } catch (err) {
                    showError('‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + err.message);
                }
            } else {
                showError('AndroidInterface ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø');
            }
        }

        function displayData(data) {
            hideLoading();

            // SIMPLE CONSOLE LOGS - These will show in PowerShell
            console.log("=== FULL DATA DUMP ===");
            console.log(JSON.stringify(data, null, 2));
            console.log("=== METER READINGS CHECK ===");
            console.log("meter_readings exists:", !!data.meter_readings);
            if (data.meter_readings) {
                console.log("meter_readings content:", JSON.stringify(data.meter_readings, null, 2));
            }
            console.log("=== ALL KEYS ===");
            console.log(Object.keys(data).join(', '));

            if (data.error) {
                showError(data.error);
                return;
            }

            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('dataSection').style.display = 'block';

            const dataContent = document.getElementById('dataContent');
            dataContent.innerHTML = generateFormattedHTML(data);
        }

        function generateFormattedHTML(data) {
            let html = '';

            console.log("üîç Generating HTML for data:", data);

            // PREPAID CUSTOMER DETAILS
            if (data.prepaid_customer_details && Object.keys(data.prepaid_customer_details).length > 0) {
                html += `<div class="terminal-section">
                            <div class="section-title">
                                üìã PREPAID CUSTOMER DETAILS
                            </div>
                            <div class="subsection-title">üë§ CUSTOMER INFORMATION</div>
                            <div class="info-grid">`;

                const prepaidFields = [
                    'Name', 'Address', 'Sanctioned Load', 'Sub Division',
                    'Tariff Category','Consumer Number', 'Phone', 'Meter Type', 'Connection Category',
                    'Division', 'Meter Number','Lock Status', 'Installation Date', 'Last Recharge Time', 'Account Type',
                    'Last Recharge Amount', 'Total Recharge This Month'
                ];

                prepaidFields.forEach(field => {
                    if (data.prepaid_customer_details[field] && data.prepaid_customer_details[field] !== 'N/A') {
                        html += `<div class="info-item">
                                    <span class="info-label">‚Ä¢ ${field}:</span>
                                    <span class="info-value">${data.prepaid_customer_details[field]}</span>
                                 </div>`;
                    }
                });

                html += `</div></div>`;
            }

            // RECHARGE TOKENS
            if (data.recharge_history && data.recharge_history.length > 0) {
                html += `<div class="terminal-section">
                            <div class="subsection-title">üîë LAST 3 RECHARGE TOKENS</div>`;

                data.recharge_history.forEach((transaction, index) => {
                    html += `<div class="token-order">
                                <div class="terminal-line"><strong>Order ${index + 1}:</strong></div>
                                <div class="terminal-line">  üìÖ Date: ${transaction.Date || 'N/A'}</div>
                                <div class="terminal-line">  üßæ Order: ${transaction['Order Number'] || 'N/A'}</div>
                                <div class="terminal-line">  üë§ Operator: ${transaction.Operator || 'N/A'}</div>
                                <div class="terminal-line">  üî¢ Sequence: ${transaction.Sequence || 'N/A'}</div>
                                <div class="terminal-line">  üí∞ Amount: ${transaction.Amount || '‡ß¶'}</div>
                                <div class="terminal-line">  ‚ö° Energy: ${transaction['Energy Cost'] || '‡ß¶'}</div>
                                <div class="terminal-line" style="color: #e74c3c; font-weight: bold;">  üîë TOKENS: ${transaction.Tokens || 'N/A'}</div>
                             </div>`;
                });

                html += `</div>`;
            }

             // CUSTOMER INFORMATION - SINGLE FLAT VIEW
 // CUSTOMER INFORMATION - SINGLE FLAT VIEW
if (data.customer_info && Object.keys(data.customer_info).length > 0) {
    html += `<div class="terminal-section">
                <div class="section-title">üë§ POSTPAID CUSTOMER INFORMATION</div>
                <div class="info-grid">`;

    const allFields = [
        // Core Identification
        'Customer Number', 'Customer Name', 'Father Name', 
        
        // Contact & Location
        'Customer Address', 'Phone', 'Division', 'Sub Division',
        
        // Meter Details
        'Meter Number', 'Meter Condition', 'Meter Status',
        // 'Connection Date' - REMOVE THIS FROM THE ARRAY
        
        // Billing Details  
        'Location Code', 'Area Code', 'Bill Group', 'Book Number',
        'Account_Number', 'Walk Order',
        
        // Tariff & Technical
        'Tariff', 'Sanctioned Load', 'Connection Category', 'Account Type',
        'Usage Type', 'Description', 'Start Bill Cycle',
        
        // Readings & Balance
        'Current Reading SR', 'Last Bill Reading SR',
        'Last Bill Reading OF PK', 'Last Bill Reading PK',
        'Arrear Amount', 'Total Balance'
    ];

    // Display all valid fields in single list
    allFields.forEach(field => {
        if (data.customer_info[field] && 
            data.customer_info[field] !== 'N/A' && 
            data.customer_info[field] !== 'null' &&
            data.customer_info[field] !== '') {

            html += `<div class="info-item">
                        <span class="info-label">‚Ä¢ ${field}:</span>
                        <span class="info-value">${data.customer_info[field]}</span>
                     </div>`;
        }
    });

    // SPECIAL HANDLING FOR CONNECTION DATE ONLY
    if (data.customer_info['Connection Date'] && data.customer_info['Connection Date'] !== 'N/A') {
        const connectionDate = data.customer_info['Connection Date'];
        const formattedDate = connectionDate.includes('T') ? connectionDate.split('T')[0] : connectionDate;
        
        html += `<div class="info-item">
                    <span class="info-label">‚Ä¢ Connection Date:</span>
                    <span class="info-value">${formattedDate}</span>
                 </div>`;
    }

    html += `</div></div>`;
}

 // METER READING DETAILS FROM API
 if (data.meter_readings && Object.keys(data.meter_readings).length > 0) {
     html += `<div class="terminal-section">
                 <div class="subsection-title">üî¢ DETAILED METER READINGS</div>
                 <div class="info-grid">`;

     const readings = data.meter_readings;

     // Current Readings
     if (readings.CLS_KWH_SR_RDNG && readings.CLS_KWH_SR_RDNG > 0) {
         html += `<div class="info-item">
                     <span class="info-label">‚Ä¢ Current SR Reading:</span>
                     <span class="info-value">${readings.CLS_KWH_SR_RDNG} kWh</span>
                  </div>`;
     }

     if (readings.CLS_KWH_PK_RDNG && readings.CLS_KWH_PK_RDNG > 0) {
         html += `<div class="info-item">
                     <span class="info-label">‚Ä¢ Current PK Reading:</span>
                     <span class="info-value">${readings.CLS_KWH_PK_RDNG} kWh</span>
                  </div>`;
     }

     if (readings.CLS_KWH_OFPK_RDNG && readings.CLS_KWH_OFPK_RDNG > 0) {
         html += `<div class="info-item">
                     <span class="info-label">‚Ä¢ Current OFPK Reading:</span>
                     <span class="info-value">${readings.CLS_KWH_OFPK_RDNG} kWh</span>
                  </div>`;
     }

     // Reading Dates
     if (readings.PREV_READING_DATE && readings.PREV_READING_DATE !== 'N/A') {
         html += `<div class="info-item">
                     <span class="info-label">‚Ä¢ Previous Reading Date:</span>
                     <span class="info-value">${formatDate(readings.PREV_READING_DATE)}</span>
                  </div>`;
     }

     if (readings.CURR_READING_DATE && readings.CURR_READING_DATE !== 'N/A') {
         html += `<div class="info-item">
                     <span class="info-label">‚Ä¢ Current Reading Date:</span>
                     <span class="info-value">${formatDate(readings.CURR_READING_DATE)}</span>
                  </div>`;
     }

     html += `</div></div>`;
 }

 // ‚úÖ NEW: Show data status for prepaid customers
 if (data.data_status) {
     html += `<div class="subsection-title">‚ÑπÔ∏è DATA STATUS</div>
              <div class="info-grid">
                 <div class="info-item">
                     <span class="info-label">‚Ä¢ Data Source:</span>
                     <span class="info-value">`;

     if (data.data_status === 'complete') {
         html += `‚úÖ Complete (Prepaid + Postpaid History)`;
     } else if (data.data_status === 'prepaid_only') {
         html += `üì± Prepaid Only (No Postpaid History)`;
     } else {
         html += `${data.data_status}`;
     }

     html += `</span>
                 </div>
              </div>`;
 }

// BILL SUMMARY - Simplified to match desired format
 if (data.bill_summary) {
     html += `<div class="terminal-section">
                 <div class="section-title">üìä BILL SUMMARY</div>
                 <div class="info-grid">`;

     const summary = data.bill_summary;

     html += `<div class="info-item">
                 <span class="info-label">Last Bill Period</span>
                 <span class="info-value">${formatBillMonth(summary.latest_bill_date) || 'N/A'}</span>
              </div>
              <div class="info-item">
                 <span class="info-label">First Bill Period</span>
                 <span class="info-value">${formatBillMonth(summary.first_bill_date) || 'N/A'}</span>
              </div>
              <div class="info-item">
                 <span class="info-label">Total Bills</span>
                 <span class="info-value">${summary.total_bills || 0}</span>
              </div>
              <div class="info-item">
                 <span class="info-label">Total Amount</span>
                 <span class="info-value">‡ß≥${((summary.total_amount || 0)).toFixed(0)}</span>
              </div>
              <div class="info-item">
                 <span class="info-label">Total Paid</span>
                 <span class="info-value">‡ß≥${((summary.total_paid || 0)).toFixed(0)}</span>
              </div>
              <div class="info-item">
                 <span class="info-label">Latest Consumption</span>
                 <span class="info-value">${(summary.latest_consumption || 0).toFixed(2)} kWh</span>
              </div>
              <div class="info-item">
                 <span class="info-label">Latest Bill Amount</span>
                 <span class="info-value">‡ß≥${((summary.latest_total_amount || 0)).toFixed(0)}</span>
              </div>`;

     html += `</div></div>`;
 }
// BALANCE INFORMATION - Show only one line
if (data.balance_info && Object.keys(data.balance_info).length > 0) {
    html += `<div class="terminal-section">
                <div class="subsection-title">üí∞ FINAL BALANCE DETAILS</div>
                <div class="info-grid">`;

    // Show only Total Balance with details
    if (data.balance_info['Total Balance']) {
        html += `<div class="info-item">
                    <span class="info-label">‚Ä¢ Total Balance:</span>
                    <span class="info-value">${data.balance_info['Total Balance']}</span>
                 </div>`;
    }

    html += `</div></div>`;
}

 // BILL TABLE
 if (data.bill_info && data.bill_info.length > 0) {
     html += `<div class="terminal-section">
                 <div class="section-title">üìã BILL DETAILS</div>
                 <div class="table-container">
                     <table class="data-table">
                         <thead>
                             <tr>
                                 <th>Bill Month</th>
                                 <th>Bill No</th>
                                 <th>Consumption</th>
                                 <th>Current Bill</th>
                                 <th>Due Date</th>
                                 <th>Paid</th>
                                 <th>Pay Date</th>
                                 <th>Balance</th>
                             </tr>
                         </thead>
                         <tbody>`;

     // Show only last 5 bills for better readability
     const displayBills = data.bill_info.slice(0, 5);

     displayBills.forEach(bill => {
         const balance = parseFloat(bill.BALANCE) || 0;
         const balanceClass = balance === 0 ? 'amount-positive' : 'amount-negative';
         const balanceDisplay = balance === 0 ? '‚Äî' : `‡ß≥${Math.abs(balance).toFixed(0)}`;

         html += `<tr>
                     <td>${formatBillMonth(bill.BILL_MONTH)}</td>
                     <td>${bill.BILL_NO || '‚Äî'}</td>
                     <td>${bill.CONS_KWH_SR || bill.consumption || '‚Äî'}</td>
                     <td>‡ß≥${((bill.CURRENT_BILL || bill.TOTAL_BILL || 0)).toFixed(0)}</td>
                     <td>${formatDate(bill.INVOICE_DUE_DATE)}</td>
                     <td>‡ß≥${((bill.PAID_AMT || 0)).toFixed(0)}</td>
                     <td>${formatDate(bill.RECEIPT_DATE)}</td>
                     <td class="${balanceClass}">${balanceDisplay}</td>
                 </tr>`;
     });

     html += `</tbody></table></div>`;

     if (data.bill_info.length > 5) {
         html += `<div class="terminal-line" style="text-align: center; color: #bdc3c7; margin-top: 10px;">
                     ... and ${data.bill_info.length - 5} more bills
                  </div>`;
     }

     html += `</div>`;
 }

 return html;
}

        function formatBillMonth(dateStr) {
    if (!dateStr || dateStr === 'N/A') return 'N/A';

    try {
        // Handle "2025-10-01T00:00:00" format
        if (dateStr.includes('T')) {
            dateStr = dateStr.split('T')[0];
        }
        
        if (dateStr.includes('-')) {
            const [year, month] = dateStr.split('-');
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            if (month && year) {
                const monthIndex = parseInt(month) - 1;
                if (monthIndex >= 0 && monthIndex < 12) {
                    // For older dates, show full year. For recent dates, show short year
                    const displayYear = parseInt(year) > 2000 ? year.substring(2) : year;
                    return `${monthNames[monthIndex]}-${displayYear}`;
                }
            }
        }
        return dateStr;
    } catch (e) {
        return dateStr;
    }
}

function formatDate(dateString) {
    if (!dateString || dateString === 'N/A' || dateString === 'null') return '‚Äî';
    try {
        // Remove time part if present
        return dateString.includes("T") ? dateString.split("T")[0] : dateString;
    } catch (e) {
        return dateString;
    }
}

        function showLoading() {
            document.getElementById("loading").style.display = "block";
            document.getElementById("error").style.display = "none";
            document.getElementById("searchBtn").disabled = true;
            document.getElementById("searchBtn").textContent = "‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...";
        }

        function hideLoading() {
            document.getElementById("loading").style.display = "none";
            document.getElementById("searchBtn").disabled = false;
            document.getElementById("searchBtn").textContent = "‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®";
        }

        function showError(message) {
            const errorDiv = document.getElementById("error");
            errorDiv.textContent = message;
            errorDiv.style.display = "block";
            hideLoading();
        }

        function clearResults() {
            document.getElementById("dataContent").innerHTML = "";
            document.getElementById("error").style.display = "none";
        }

        function showSearchSection() {
            document.getElementById("dataSection").style.display = "none";
            document.getElementById("searchSection").style.display = "block";
            document.getElementById("searchInput").value = "";
            document.getElementById("searchInput").focus();
            clearResults();
        }

        function closeLookup() {
            if (window.AndroidInterface) {
                AndroidInterface.closeLookup();
            } else {
                window.close();
            }
        }

        function saveAsPDF() {
            if (window.AndroidInterface) {
                AndroidInterface.saveAsPDF();
            } else {
                window.print();
            }
        }

        // Handle Enter key press
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchData();
            }
        });

        // Initialize
        document.getElementById('searchInput').focus();
    </script>
</body>
</html>
