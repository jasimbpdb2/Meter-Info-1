<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application List</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 15px;
            background: #f5f5f5;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .controls {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }

        .filter-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }

        .action-btn {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn.export {
            background: #28a745;
        }

        .action-btn.print {
            background: #6c757d;
        }

        .action-btn.back {
            background: #dc3545;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 0 0 8px 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
        }

        th:hover {
            background: #e9ecef;
        }

        th.sort-asc::after {
            content: " ‚Üë";
        }

        th.sort-desc::after {
            content: " ‚Üì";
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .status-created { background: #fff3cd; color: #856404; }
        .status-assigned { background: #d1ecf1; color: #0c5460; }
        .status-verified { background: #d4edda; color: #155724; }
        .status-approved { background: #d1e7dd; color: #0f5132; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-completed { background: #cce5ff; color: #004085; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #007bff;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .pagination {
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 5px;
            background: white;
            border-top: 1px solid #ddd;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .page-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .mobile-only {
            display: none;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }

            .mobile-only {
                display: block;
            }

            .desktop-only {
                display: none;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <h2 style="margin: 0;">üìä Application List</h2>
    <div style="display: flex; gap: 10px;">
        <span id="appCount">0 Application</span>
        <span id="lastUpdated">Loading...</span>
    </div>
</div>

<div class="controls">
    <input type="text"
           id="searchInput"
           class="search-box"
           placeholder="üîç ‡¶®‡¶æ‡¶Æ, ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç, ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..."
           onkeyup="filterTable()">

    <select id="statusFilter" class="filter-select" onchange="filterTable()">
        <option value="">All Workflow</option>
        <option value="created">New Application</option>
        <option value="assigned_to_ae">Assigned to AE</option>
        <option value="assigned_to_sae">Assigned to SAE</option>
        <option value="field_survey_completed">Field Survey Completed</option>
        <option value="verified_by_ae">AE Verified</option>
        <option value="approved_by_xen">XEN Approved</option>
        <option value="rejected">Rejected</option>
        <option value="completed">Completed</option>
    </select>

    <select id="feederFilter" class="filter-select" onchange="filterTable()">
        <option value="">‡¶∏‡¶ï‡¶≤ ‡¶´‡¶ø‡¶°‡¶æ‡¶∞</option>
        <option value="amb">AMBARI - amb</option>
        <option value="bor">BOROPARA - bor</option>
        <option value="amb">Hasannogor - Han</option>
        <option value="bor">Mollikpur - mlkpur</option>
        <option value="amb">Derai - Der</option>
        <option value="bor">Shologor - Shol</option>
        <option value="amb">Betgonj - Bet</option>
        <option value="bor">Thana - Tha</option>
    </select>
    <select id="dateFilter" class="filter-select" onchange="toggleDateRange()">
        <option value="">‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</option>
        <option value="range">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶∞‡ßá‡¶û‡ßç‡¶ú</option>
    </select>

    <div id="dateRangeContainer" style="display: none; margin-top: 10px;">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <div>
                <label style="font-size: 12px; color: #666;">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                <input type="date" id="startDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="hidden" id="startTime" value="00:01"> <!-- HIDDEN -->
            </div>
            <div>
                <label style="font-size: 12px; color: #666;">‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                <input type="date" id="endDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="hidden" id="endTime"> <!-- HIDDEN -->
            </div>
            <button onclick="applyDateRange()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Search
            </button>
        </div>
    </div>

    <button class="action-btn export" onclick="exportToExcel()">
        üì• ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü
    </button>

    <button class="action-btn print" onclick="printTable()">
        üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
    </button>

    <button class="action-btn back" onclick="goBack()">
        ‚Üê ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°
    </button>
</div>

<div class="table-container">
    <table id="applicationsTable">
        <thead>
        <tr>
            <th onclick="sortTable(0)">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç</th>
            <th onclick="sortTable(1)">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
            <th onclick="sortTable(2)">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</th>
            <th onclick="sortTable(3)">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
            <th onclick="sortTable(4)">‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç</th>
            <th onclick="sortTable(5)">‡¶´‡¶ø‡¶°‡¶æ‡¶∞</th>
            <th onclick="sortTable(6)">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
            <th onclick="sortTable(7)">‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
            <th onclick="sortTable(8)">‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</th>
            <th class="desktop-only" onclick="sortTable(9)">‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ</th>
        </tr>
        </thead>
        <tbody id="tableBody">
        <tr id="loadingRow">
            <td colspan="10" class="loading">
                ‚è≥ Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="pagination" id="pagination" style="display: none;">
    <!-- Pagination buttons will be added here -->
</div>

<script>
        // Global variables
        let allApplications = [];
        let filteredApplications = [];
        let currentSortColumn = -1;
        let sortDirection = 1; // 1 = asc, -1 = desc
        let currentPage = 1;
        const pageSize = 50;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Load applications from Firebase
            loadApplicationsFromFirebase();

            // Update last updated time
            updateLastUpdated();

            // Auto-refresh every 30 seconds
            setInterval(updateLastUpdated, 30000);
        });

        // ==================== FIREBASE DATA LOADING ====================
        function loadApplicationsFromFirebase() {
            try {
                // Check if AndroidInterface is available
                if (window.AndroidInterface && AndroidInterface.loadApplications) {
                    AndroidInterface.loadApplications();
                    document.getElementById('lastUpdated').textContent = "‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
                } else {
                    // Fallback: Load from localStorage
                    const apps = JSON.parse(localStorage.getItem('allApplications')) || [];
                    displayApplications(apps);
                    document.getElementById('lastUpdated').textContent = "‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶°";
                }
            } catch (error) {
                console.error("Firebase load error:", error);
                showError("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ");
            }
        }

        // Callback function for Android to send data
        window.handleLoadedApplications = function(applications) {
            try {
                console.log("Excel View: Received", applications.length, "applications");

                if (applications && applications.length > 0) {
                    allApplications = applications;
                    displayApplications(allApplications);

                    // Update counts
                    document.getElementById('appCount').textContent =
                        applications.length + " ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®";

                    document.getElementById('lastUpdated').textContent =
                        "‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: " + new Date().toLocaleTimeString('bn-BD');

                    showSuccess(applications.length + " ‡¶ü‡¶ø ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá");
                } else {
                    showInfo("‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø");
                    document.getElementById('appCount').textContent = "0 ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®";
                }
            } catch (error) {
                console.error("Data processing error:", error);
                showError("‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ");
            }
        };

        // ==================== TABLE DISPLAY ====================
        function displayApplications(apps) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            if (apps.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-state">
                            üì≠ ‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø
                        </td>
                    </tr>
                `;
                return;
            }

            filteredApplications = [...apps];

            // Apply initial sorting
            sortTable(7); // Sort by creation date descending by default

            // Show first page
            showPage(1);
        }

        function showPage(page) {
            currentPage = page;
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = filteredApplications.slice(startIndex, endIndex);

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            pageData.forEach(app => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${app.application_no || 'N/A'}</strong></td>
                    <td>${app.customer_name || 'N/A'}</td>
                    <td>${app.address || 'N/A'}</td>
                    <td>${app.mobile_no || 'N/A'}</td>
                    <td>${app.meter_no || 'N/A'}</td>
                    <td>${app.feeder || 'N/A'}</td>
                    <td><span class="status-badge ${getStatusClass(app.status)}">
                        ${getStatusText(app.status)}
                    </span></td>
                    <td>${getCreatedDate(app)}</td>
					<td>${getUpdatedDate(app)}</td>
                    <td class="desktop-only">
                        <button onclick="viewDetails('${app.application_no}')"
                                style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            üëÅÔ∏è ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updatePagination();
        }

        // ==================== SORTING ====================
        function sortTable(columnIndex) {
            const headers = document.querySelectorAll('th');

            // Remove sort indicators from all headers
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });

            // If clicking the same column, reverse direction
            if (currentSortColumn === columnIndex) {
                sortDirection = -sortDirection;
            } else {
                currentSortColumn = columnIndex;
                sortDirection = 1;
            }

            // Add sort indicator to current header
            const currentHeader = headers[columnIndex];
            currentHeader.classList.add(sortDirection === 1 ? 'sort-asc' : 'sort-desc');

            // Sort the data
            filteredApplications.sort((a, b) => {
                let valueA = getCellValue(a, columnIndex);
                let valueB = getCellValue(b, columnIndex);

                // Handle dates
                if (columnIndex === 7 || columnIndex === 8) {
                    valueA = new Date(valueA || 0);
                    valueB = new Date(valueB || 0);
                }

                // Handle numbers (application numbers)
                if (columnIndex === 0 && valueA && valueB) {
                    const numA = extractNumber(valueA);
                    const numB = extractNumber(valueB);
                    if (numA !== null && numB !== null) {
                        return (numA - numB) * sortDirection;
                    }
                }

                // Default string comparison
                if (valueA < valueB) return -1 * sortDirection;
                if (valueA > valueB) return 1 * sortDirection;
                return 0;
            });

            showPage(1);
        }

        function getCellValue(app, columnIndex) {
            switch(columnIndex) {
                case 0: return app.application_no;
                case 1: return app.customer_name;
                case 2: return app.address;
                case 3: return app.mobile_no;
                case 4: return app.meter_no;
                case 5: return app.feeder;
                case 6: return app.status;
                case 7: return app.createdAt;
                case 8: return app.updatedAt;
                default: return '';
            }
        }

       function filterTable() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const feederFilter = document.getElementById('feederFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;

    filteredApplications = allApplications.filter(app => {
        // Search filter
        if (searchText) {
            const searchable = [
                app.application_no,
                app.customer_name,
                app.address,
                app.mobile_no,
                app.meter_no,
                app.consumer_no
            ].join(' ').toLowerCase();

            if (!searchable.includes(searchText)) {
                return false;
            }
        }

        // Status filter
        if (statusFilter && app.status !== statusFilter) {
            return false;
        }

        // Feeder filter
        if (feederFilter && app.feeder !== feederFilter) {
            return false;
        }

        // Date range filter - FIXED
if (dateFilter === 'range') {
    const startDateStr = document.getElementById('startDate').value;
    const startTimeStr = document.getElementById('startTime').value || '00:01'; // Default 00:01
    const endDateStr = document.getElementById('endDate').value;
    const endTimeStr = document.getElementById('endTime').value; // Will have current time

    if (!startDateStr || !endDateStr) return false;

    // Create dates with actual times
    const startDate = new Date(startDateStr + 'T' + startTimeStr + ':00');
    const endDate = new Date(endDateStr + 'T' + endTimeStr + ':00');

    // Get application date
    const appDate = getApplicationDate(app);

    // Compare dates
    if (appDate < startDate || appDate > endDate) {
        return false;
    }
}

        return true;
    });

    document.getElementById('appCount').textContent =
        filteredApplications.length + " ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® (‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ï‡ßÉ‡¶§)";

    showPage(1);
}
function toggleDateRange() {
    const dateFilter = document.getElementById('dateFilter').value;
    const container = document.getElementById('dateRangeContainer');
    
    if (dateFilter === 'range') {
        container.style.display = 'block';

        // Default to today if not set
        const today = new Date();
        const formatDate = (date) => date.toISOString().split('T')[0];

        // Set default dates to today if empty
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        if (!startDateInput.value) {
            startDateInput.value = formatDate(today);
        }
        if (!endDateInput.value) {
            endDateInput.value = formatDate(today);
        }

        // Auto-set times
        updateDateTimeFields();

        // Auto-apply filter
        setTimeout(() => filterTable(), 100);
    } else {
        container.style.display = 'none';
        filterTable();
    }
}

function updateDateTimeFields() {
    const now = new Date();

    // Always set start time to 00:01 (hidden field)
    document.getElementById('startTime').value = '00:01';

    // Always set end time to current time (hidden field)
    document.getElementById('endTime').value =
        String(now.getHours()).padStart(2, '0') + ':' +
        String(now.getMinutes()).padStart(2, '0');
}

// Add event listeners to auto-update times when dates change
document.addEventListener('DOMContentLoaded', function() {
    // Listen for date changes
    document.getElementById('startDate').addEventListener('change', updateDateTimeFields);
    document.getElementById('endDate').addEventListener('change', updateDateTimeFields);

    // Also call updateDateTimeFields when page loads if range is selected
    setTimeout(() => {
        if (document.getElementById('dateFilter').value === 'range') {
            updateDateTimeFields();
        }
    }, 500);
});

// Update applyDateRange function
function applyDateRange() {
    // Ensure times are updated before filtering
    updateDateTimeFields();

    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (!startDate || !endDate) {
        showError("‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®");
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        showError("‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá");
        return;
    }

    filterTable();
    showSuccess("‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
}

// Add this helper function to get application date
function getApplicationDate(app) {
    if (app.workflowHistory && app.workflowHistory.length > 0) {
        return new Date(app.workflowHistory[0].date);
    }
    return new Date(app.createdAt || 0);
}

        // ==================== PAGINATION ====================
        function updatePagination() {
            const totalPages = Math.ceil(filteredApplications.length / pageSize);
            const paginationDiv = document.getElementById('pagination');

            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }

            paginationDiv.style.display = 'flex';
            paginationDiv.innerHTML = '';

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.innerHTML = '‚Üê';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => showPage(currentPage - 1);
            paginationDiv.appendChild(prevBtn);

            // Page buttons
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => showPage(i);
                paginationDiv.appendChild(pageBtn);
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.innerHTML = '‚Üí';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => showPage(currentPage + 1);
            paginationDiv.appendChild(nextBtn);
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportToExcel() {
            try {
                if (filteredApplications.length === 0) {
                    showError("‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶§ ‡¶ï‡ßã‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á");
                    return;
                }

                if (window.AndroidInterface && AndroidInterface.exportToExcel) {
                    AndroidInterface.exportToExcel(JSON.stringify(filteredApplications));
                    showSuccess("‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
                } else {
                    // Fallback: Download as CSV
                    downloadAsCSV();
                }
            } catch (error) {
                console.error("Export error:", error);
                showError("‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message);
            }
        }

        function downloadAsCSV() {
            const csvRows = [];

            // Headers
            const headers = [
                '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç',
                '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ',
                '‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ',
                '‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ',
                '‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Ç',
                '‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç',
                '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç',
                '‡¶´‡¶ø‡¶°‡¶æ‡¶∞',
                '‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏',
                '‡¶¨‡¶ï‡ßá‡ßü‡¶æ',
                '‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ',
                '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ'
            ];
            csvRows.push(headers.join(','));

            // Data rows
            filteredApplications.forEach(app => {
                const row = [
                    `"${app.application_no || ''}"`,
                    `"${app.customer_name || ''}"`,
                    `"${app.father_name || ''}"`,
                    `"${app.address || ''}"`,
                    `"${app.mobile_no || ''}"`,
                    `"${app.meter_no || ''}"`,
                    `"${app.consumer_no || ''}"`,
                    `"${app.feeder || ''}"`,
                    `"${getStatusText(app.status)}"`,
                    `"${app.arrear || '0'}"`,
                    `"${getCreatedDate(app) || ''}"`,
                    `"${getUpdatedDate(app) || ''}"`
                ];
                csvRows.push(row.join(','));
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `applications_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();

            showSuccess("CSV ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
        }

        function printTable() {
            window.print();
        }

      // ==================== WORKFLOW STATUS CONSTANTS ====================
const WORKFLOW_STATUS = {
    CREATED: 'created',
    ASSIGNED_TO_AE: 'assigned_to_ae',
    ASSIGNED_TO_SAE: 'assigned_to_sae',
    FIELD_SURVEY_COMPLETED: 'field_survey_completed',
    VERIFIED_BY_AE: 'verified_by_ae',
    APPROVED_BY_XEN: 'approved_by_xen',
    REJECTED: 'rejected',
    ACTION_TAKEN: 'action_taken',
    COMPLETED: 'completed'
};

// Update filter options to match
const statusFilter = document.getElementById('statusFilter');
if (statusFilter) {
    statusFilter.innerHTML = `
        <option value="">All Workflow</option>
        <option value="${WORKFLOW_STATUS.CREATED}">New Application</option>
        <option value="${WORKFLOW_STATUS.ASSIGNED_TO_AE}">Assigned to AE</option>
        <option value="${WORKFLOW_STATUS.ASSIGNED_TO_SAE}">Assigned to SAE</option>
        <option value="${WORKFLOW_STATUS.FIELD_SURVEY_COMPLETED}">Field Survey Completed</option>
        <option value="${WORKFLOW_STATUS.VERIFIED_BY_AE}">AE Verified</option>
        <option value="${WORKFLOW_STATUS.APPROVED_BY_XEN}">XEN Approved</option>
        <option value="${WORKFLOW_STATUS.REJECTED}">Rejected</option>
        <option value="${WORKFLOW_STATUS.ACTION_TAKEN}">Action Taken</option>
        <option value="${WORKFLOW_STATUS.COMPLETED}">Completed</option>
    `;
}

// Update getStatusText to use constants
function getStatusText(status) {
    switch(status) {
        case WORKFLOW_STATUS.CREATED: return '‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®';
        case WORKFLOW_STATUS.ASSIGNED_TO_AE: return 'AE ‡¶§‡ßá Assign';
        case WORKFLOW_STATUS.ASSIGNED_TO_SAE: return 'SAE ‡¶§‡ßá Assign';
        case WORKFLOW_STATUS.FIELD_SURVEY_COMPLETED: return '‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®';
        case WORKFLOW_STATUS.VERIFIED_BY_AE: return 'AE Verify ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®';
        case WORKFLOW_STATUS.APPROVED_BY_XEN: return 'XEN ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®';
        case WORKFLOW_STATUS.REJECTED: return '‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®';
        case WORKFLOW_STATUS.ACTION_TAKEN: return '‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™';
        case WORKFLOW_STATUS.COMPLETED: return '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®';
        default: return status || '‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®';
    }
}

// Update getStatusClass to use constants
function getStatusClass(status) {
    switch(status) {
        case WORKFLOW_STATUS.CREATED: return 'status-created';
        case WORKFLOW_STATUS.ASSIGNED_TO_AE:
        case WORKFLOW_STATUS.ASSIGNED_TO_SAE:
            return 'status-assigned';
        case WORKFLOW_STATUS.FIELD_SURVEY_COMPLETED:
        case WORKFLOW_STATUS.VERIFIED_BY_AE:
            return 'status-verified';
        case WORKFLOW_STATUS.APPROVED_BY_XEN:
            return 'status-approved';
        case WORKFLOW_STATUS.REJECTED:
            return 'status-rejected';
        case WORKFLOW_STATUS.ACTION_TAKEN:
        case WORKFLOW_STATUS.COMPLETED:
            return 'status-completed';
        default: return 'status-created';
    }
}
         function getCreatedDate(app) {
    if (app.workflowHistory && app.workflowHistory.length > 0) {
        return app.workflowHistory[0].date;
    }
    return 'N/A';
}

function getUpdatedDate(app) {
    if (app.workflowHistory && app.workflowHistory.length > 0) {
        let last = app.workflowHistory.length - 1;
        return app.workflowHistory[last].date;
    }
    return 'N/A';
}


        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }

        function extractNumber(text) {
            const match = text.match(/\d+/);
            return match ? parseInt(match[0]) : null;
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent =
                "‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: " + now.toLocaleTimeString('bn-BD');
        }

        function viewDetails(appNo) {
            if (window.AndroidInterface && AndroidInterface.showToast) {
                AndroidInterface.showToast("‡¶ñ‡ßã‡¶≤‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: " + appNo);
                // You can open detailed view here
            }
        }

        function goBack() {
    // Simply load the main dashboard HTML file
    window.location.href = "file:///android_asset/application_form.html";

    // Optional: Show toast if available
    if (window.AndroidInterface && AndroidInterface.showToast) {
        AndroidInterface.showToast("‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡¶ø...");
    }
}

        function showSuccess(message) {
            if (window.AndroidInterface && AndroidInterface.showToast) {
                AndroidInterface.showToast(message);
            } else {
                alert(message);
            }
        }

        function showError(message) {
            if (window.AndroidInterface && AndroidInterface.showToast) {
                AndroidInterface.showToast("‚ùå " + message);
            } else {
                alert("‚ùå " + message);
            }
        }

        function showInfo(message) {
            if (window.AndroidInterface && AndroidInterface.showToast) {
                AndroidInterface.showToast("‚ÑπÔ∏è " + message);
            }
        }
    </script>
</body>

</html>

