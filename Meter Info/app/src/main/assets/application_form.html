<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶™‡¶§‡ßç‡¶∞</title>

    <style>
        body {
            font-family: "Shonar Bangla", serif;
            margin: 0;
            padding: 15px 25px;
            font-size: 16px;
            line-height: 1.6;
        }

        /* Left-aligned office header */
        .header {
            text-align: left;
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 18px;
        }

        /* Applicant info */
        .info-line {
            font-size: 17px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
        }
        .info-label {
            font-weight: normal;
            min-width: 180px;
        }
        .info-value {
            font-weight: bold;
        }

        /* Editable fields */
        .editable-field {
            border: 1px dashed #ccc;
            background: #f9f9f9;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 16px;
            width: 250px;
            font-family: "Shonar Bangla", serif;
            font-weight: bold;
        }

        .editable-field:focus {
            border-color: #3498db;
            background: #fff;
            outline: none;
        }

        .static-value {
            font-weight: bold;
        }

        /* Title */
        .title {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Complaint title box */
        .complain-box {
            border: 1px solid #000;
            padding: 6px;
            width: 50%;
            margin: 6px auto 12px auto;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        /* Two-column area: complaints left, recharge table right */
        .content-grid {
            display: grid;
            grid-template-columns: 65% 35%;
            grid-gap: 6px;
        }

        /* Complaints list */
        .complaints p {
            margin: 1px 0;
            font-size: 17px;
            font-weight: bold;
            page-break-inside: avoid;
        }

        /* Fix for "‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø" line specifically */
        .complaints p:last-child {
            white-space: nowrap;
        }

        /* Recharge section title */
        .recharge-title {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
        }

        /* Recharge Table */
        .recharge-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 17px;
        }
        .recharge-table th, .recharge-table td {
            border: 1px solid #000;
            padding: 5px 8px;
            text-align: center;
            height: 26px;
        }

        /* Signature */
        .signature {
            text-align: right;
            margin-top: 40px;
            font-size: 18px;
            font-weight: bold;
            page-break-inside: avoid;
        }

        /* Search Section Styles */
        .search-section {
            margin-bottom: 20px;
        }

        .type-selector {
            display: flex;
            margin-bottom: 10px;
        }

        .type-btn {
            padding: 8px 16px;
            border: 1px solid #ccc;
            cursor: pointer;
            margin-right: 5px;
        }

        .type-btn.active {
            background-color: #007bff;
            color: white;
        }

        .search-row {
            display: flex;
            margin-bottom: 10px;
        }

        .search-input {
            flex: 1;
            padding: 8px;
            font-size: 16px;
        }

        .search-btn {
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }

        .loading {
            display: none;
            color: #007bff;
        }

        .error {
            display: none;
            color: #dc3545;
        }

        .action-buttons {
            margin-top: 20px;
            text-align: center;
        }

        .btn {
            padding: 8px 16px;
            margin: 5px;
            background-color: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }

        .form-section {
            display: none;
        }

        .hidden {
            display: none;
        }
        @media print {

            /* Hide search UI */
            #searchSection,
            .search-section,
            .search-row,
            .type-selector,
            .type-btn,
            #searchBtn,
            #searchInput,
            .loading,
            .error,
            .debug-info {
                display: none !important;
            }

            /* Hide action buttons under form */
            .action-buttons {
                display: none !important;
            }

            /* Prevent unwanted background shading */
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Ensure page margins are tight like official form */
            @page {
                margin: 8mm;
            }
        }
    </style>
</head>

<body>
<div class="application-container">

    <div class="search-section" id="searchSection">
        <h2 style="font-size:16px;margin-bottom:8px;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</h2>

        <div class="debug-info" id="debugInfo" style="display:none;">
            <strong>‡¶°‡¶ø‡¶¨‡¶æ‡¶ó ‡¶§‡¶•‡ßç‡¶Ø:</strong>
            <div id="debugLog"></div>
        </div>

        <div class="type-selector">
            <div class="type-btn active" id="prepaidBtn" onclick="selectType('prepaid')">‡¶™‡ßç‡¶∞‡¶ø‡¶™‡ßá‡¶á‡¶°</div>
            <div class="type-btn" id="postpaidBtn" onclick="selectType('postpaid')">‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶™‡ßá‡¶á‡¶°</div>
        </div>

        <div class="search-row">
            <input type="text" id="searchInput" class="search-input" placeholder="‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"
                   autofocus autocapitalize="none" autocorrect="off" inputmode="numeric">
            <button onclick="fetchData()" id="searchBtn" class="search-btn">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
        </div>

        <div class="loading" id="loading">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        <div class="error" id="error"></div>
    </div>

    <div class="form-section hidden" id="dataCollectionSection" style="padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <div class="title" style="font-size: 20px;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á</div>

        <div style="background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
            <div class="info-line">
                <span class="info-label">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É</span>
                <span class="info-value" id="previewCustomerName"></span>
            </div>
            <div class="info-line">
                <span class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡¶É</span>
                <span class="info-value" id="previewAddress"></span>
            </div>
            <div class="info-line">
                <span class="info-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Ç‡¶É</span>
                <span class="info-value" id="previewMobileNo"></span>
            </div>
        </div>

        <div class="info-line" style="display: block;">
            <span class="info-label" style="min-width: unset;">‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡¶É</span>
            <select class="editable-field" id="feederSelect" style="width: 100%; margin-top: 5px; padding: 8px;" onchange="generateApplicationNo()">
                <option value="">-- ‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
                <option value="amb">AMBARI - amb</option>
                <option value="bor">BOROPARA - bor</option>
            </select>
        </div>

        <div class="info-line" style="display: block; margin-top: 15px;">
            <span class="info-label" style="min-width: unset;">‡¶è‡¶®‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç‡¶É</span>
            <input type="text" class="editable-field" id="nidInput" placeholder="‡¶è‡¶®‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" style="width: 100%; margin-top: 5px;">
        </div>

        <div class="info-line" style="display: block; margin-top: 15px;">
            <span class="info-label" style="min-width: unset;">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Ç (‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®)‡¶É</span>
            <input type="tel" class="editable-field" id="mobileInput" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" style="width: 100%; margin-top: 5px;">
        </div>

        <div class="info-line" style="display: block; margin-top: 15px; background: #e6f7ff; padding: 10px; border-radius: 4px;">
            <span class="info-label" style="min-width: unset; font-weight: bold;">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç‡¶É</span>
            <span class="info-value" id="generatedAppNo" style="color: #007bff;">‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span>
        </div>

        <div class="action-buttons" style="margin-top: 25px;">
            <button class="btn" style="background-color: #28a745;" onclick="generateApplication()">‚úÖ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶™‡¶§‡ßç‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn" style="background-color: #6c757d;" onclick="showSearchSection()">‚Üê ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡ßã‡¶Å‡¶ú</button>
        </div>
    </div>

    <div class="form-section hidden" id="formSection">

        <div class="title">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡¶§‡ßç‡¶∞</div>
        <div class="info-line" style="justify-content: flex-end; font-size: 14px;">
            ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç: <span id="applicationNoDisplay">________</span>
        </div>

        <div class="header">
            ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶π‡ßÄ ‡¶™‡ßç‡¶∞‡¶ï‡ßå‡¶∂‡¶≤‡ßÄ<br>
            ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ì ‡¶¨‡¶ø‡¶§‡¶∞‡¶£ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó<br>
            ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶â‡¶®‡ßç‡¶®‡ßü‡¶® ‡¶¨‡ßã‡¶∞‡ßç‡¶°<br>
            ‡¶∏‡ßÅ‡¶®‡¶æ‡¶Æ‡¶ó‡¶û‡ßç‡¶ú
        </div>

        <div class="info-line">
            <span class="info-label">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï/‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É </span>
            <span class="static-value" id="staticCustomerName">_____________</span>
        </div>

        <div class="info-line">
            <span class="info-label">‡¶™‡¶ø‡¶§‡¶æ/‡¶∏‡ßç‡¶¨‡¶æ‡¶Æ‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É </span>
            <span class="static-value" id="staticFatherName">_____________</span>
        </div>

        <div class="info-line">
            <span class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡¶É </span>
            <span class="static-value" id="staticAddress">_____________</span>
        </div>

        <div class="info-line">
            <span class="info-label">‡¶ü‡ßá‡¶≤‡¶ø‡¶´‡ßã‡¶® ‡¶®‡¶Ç‡¶É </span>
            <span class="static-value" id="staticMobileNo">_____________</span>
        </div>

        <div class="info-line">
            <span class="info-label">‡¶è‡¶®‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç‡¶É </span>
            <span class="static-value" id="staticNid">_____________</span>
        </div>

        <div class="info-line">
            <span class="info-label">‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç‡¶É </span>
            <span class="static-value" id="staticMeterNo">_____________</span>
        </div>

        <div class="info-line">
            <span class="info-label">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç‡¶É </span>
            <span class="static-value" id="staticConsumerNo">_____________</span>
            <span style="margin-left: 20px;"><b>‡¶¨‡¶ï‡ßá‡ßü‡¶æ‡¶É</b> <b><span id="arrear">________</span></b></span>
        </div>

        <div class="complain-box">‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó</div>

        <div class="content-grid">

            <div class="complaints">
                <p>‡ßß.  ‡¶≤‡ßã‡¶° ‡¶õ‡¶æ‡ßú‡¶æ‡¶ì ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡ßá / ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡ßá ‡¶®‡¶æ</p>
                <p>‡ß®.  ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶ü‡ßÅ‡¶á‡¶∏‡ßç‡¶ü ‡¶∏‡ßÄ‡¶≤/‡¶≤‡ßÄ‡¶°/‡¶™‡ßç‡¶Ø‡¶æ‡¶°‡¶≤‡¶ï ‡¶∏‡ßÄ‡¶≤ ‡¶≠‡¶æ‡¶ô‡ßç‡¶ó‡¶æ / ‡¶ö‡ßÅ‡¶∞‡¶ø</p>
                <p>‡ß©.  ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶≠‡ßá‡¶ô‡ßç‡¶ó‡ßá / ‡¶π‡¶æ‡¶∞‡¶ø‡ßü‡ßá / ‡¶™‡ßÅ‡ßú‡ßá ‡¶ó‡ßá‡¶õ‡ßá</p>
                <p>‡ß™.  ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶®‡ßç‡¶§‡¶∞ / ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶ó‡ßç‡¶∞‡¶π‡ßÄ</p>
                <p>‡ß´.  ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá‡¶§‡ßá ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶è‡¶≤‡ßã‡¶Æ‡ßá‡¶≤‡ßã</p>
                <p>‡ß¨.  ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶ü‡¶ø/‡¶™‡¶ø‡¶ü‡¶ø ‡¶®‡¶∑‡ßç‡¶ü</p>
                <p>‡ß≠.  ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶π‡¶æ‡¶∞‡¶ø‡ßü‡ßá‡¶õ‡ßá</p>
                <p>‡ßÆ.  ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ</p>
                <p>‡ßØ.  ‡¶ü‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶®‡¶æ‡¶≤ ‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá</p>
                <p>‡ßß‡ß¶. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶®‡ßá‡¶á</p>
                <p>‡ßß‡ßß. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶°‡ßá‡¶ü/‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ</p>
                <p>‡ßß‡ß®. ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</p>
                <p>‡ßß‡ß©. ‡¶≤‡ßã‡¶° ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</p>
                <p>‡ßß‡ß™. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø/‡¶≤‡ßã-‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡ßá‡¶ú ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ</p>
                <p>‡ßß‡ß´. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶®‡ßá‡¶á</p>
                <p>‡ßß‡ß¨. ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø __________________________________________</p>
            </div>

            <div id="rechargeSection">
                <div class="recharge-title">‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶∞‡¶ø‡¶ö‡¶æ‡¶∞‡ßç‡¶ú‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</div>

                <table class="recharge-table" id="rechargeTable">
                    <tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th></tr>
                    <tr><td id="rechargeDate1">&nbsp;</td><td id="rechargeAmount1">&nbsp;</td></tr>
                    <tr><td id="rechargeDate2">&nbsp;</td><td id="rechargeAmount2">&nbsp;</td></tr>
                    <tr><td id="rechargeDate3">&nbsp;</td><td id="rechargeAmount3">&nbsp;</td></tr>
                </table>
            </div>

        </div>

        <div class="signature">
            ...........................<br>
            ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶∏‡¶æ‡¶ï‡ßç‡¶∑‡¶∞
        </div>

        <div class="action-buttons">
            <button class="btn" onclick="window.print()">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
            <button class="btn" onclick="saveAsPDF()">üìÑ PDF ‡¶∏‡ßá‡¶≠</button>
            <button class="btn" style="background-color: #007bff;" onclick="showSAESection()">üìã SAE ‡¶§‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
            <button class="btn" onclick="showSearchSection()">‚Üê ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡ßã‡¶Å‡¶ú</button>
            <button class="btn" onclick="closeForm()">‚úï ‡¶¨‡¶®‡ßç‡¶ß</button>
        </div>

    </div>

    <div class="form-section hidden" id="saeSection" style="padding: 15px; border: 1px solid #007bff; border-radius: 5px;">
        <div class="title" style="font-size: 20px; color: #007bff;">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶ì ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡¶æ‡ßü‡¶® (SAE)</div>

        <div style="background: #e6f7ff; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 15px;">
            <div><strong>‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç:</strong> <span id="saeAppNo"></span></div>
            <div><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="saeCustomerName"></span></div>
        </div>

        <div style="margin-bottom: 15px;">
            <span class="info-label" style="display: block;">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶É</span>
            <textarea id="saeReport" placeholder="‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;"></textarea>
        </div>

        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 8px;"><input type="radio" name="saeAction" value="verify" onclick="toggleSaeRejectReason(false)"> ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶® (Verify)</label>
            <label style="display: block;"><input type="radio" name="saeAction" value="reject" onclick="toggleSaeRejectReason(true)"> ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (Reject)</label>
        </div>

        <div id="saeRejectReason" class="hidden" style="margin-top: 15px;">
            <span class="info-label" style="display: block;">‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶æ‡¶∞‡¶£‡¶É</span>
            <input type="text" class="editable-field" id="saeRejectText" placeholder="‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="width: 100%;">
        </div>

        <div class="action-buttons" style="margin-top: 25px;">
            <button class="btn" style="background-color: #28a745;" onclick="saveSaeReport()">üíæ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn" style="background-color: #007bff;" onclick="showFinalApprovalSection()">‚û°Ô∏è ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
            <button class="btn" style="background-color: #6c757d;" onclick="backToApplication()">‚Üê ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <div class="form-section hidden" id="finalApprovalSection" style="padding: 15px; border: 1px solid #28a745; border-radius: 5px;">
        <div class="title" style="font-size: 20px; color: #28a745;">‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</div>

        <div style="background: #e3ffe6; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 15px;">
            <div><strong>‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç:</strong> <span id="finalAppNo"></span></div>
            <div><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="finalCustomerName"></span></div>
            <div><strong>‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü:</strong> <span id="finalReport">N/A</span></div>
        </div>

        <div style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 8px;"><input type="radio" name="finalAction" value="approve" onclick="toggleFinalRejectReason(false)"> ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (Approve)</label>
            <label style="display: block;"><input type="radio" name="finalAction" value="reject" onclick="toggleFinalRejectReason(true)"> ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (Reject)</label>
        </div>

        <div id="finalRejectReason" class="hidden" style="margin-top: 15px;">
            <span class="info-label" style="display: block;">‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶æ‡¶∞‡¶£‡¶É</span>
            <input type="text" class="editable-field" id="finalRejectText" placeholder="‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="width: 100%;">
        </div>

        <div class="action-buttons" style="margin-top: 25px;">
            <button class="btn" style="background-color: #28a745;" onclick="saveFinalApproval()">‚úÖ ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn" style="background-color: #6c757d;" onclick="backToSae()">‚Üê SAE ‡¶§‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

</div>

<script>
// Global variables
let selectedType = 'prepaid';
let currentCustomerType = 'prepaid';
let currentInputNumber = ''; 
let applicationData = {}; // Global object to hold all data

// --- Utility Functions ---
function debugLog(msg){
    const d=document.getElementById("debugLog");
    if(d){ d.innerHTML+=msg+"<br>"; d.scrollTop=d.scrollHeight; }
}

function showLoading(){
    document.getElementById("loading").style.display="block";
    document.getElementById("searchBtn").disabled=true;
    document.getElementById("searchBtn").textContent="‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...";
}

function hideLoading(){
    document.getElementById("loading").style.display="none";
    document.getElementById("searchBtn").disabled=false;
    document.getElementById("searchBtn").textContent="‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®";
}

function showError(m){
    const err = document.getElementById("error");
    if(err){ err.textContent=m; err.style.display="block"; }
    hideLoading();
}

function hideError(){ const e=document.getElementById("error"); if(e) e.style.display="none"; }


// --- State Management ---
function hideAllSections() {
    document.getElementById("searchSection").style.display = "none";
    document.getElementById("formSection").style.display = "none";
    document.getElementById("dataCollectionSection").style.display = "none";
    document.getElementById("saeSection").style.display = "none";
    document.getElementById("finalApprovalSection").style.display = "none";
}

function showSearchSection(){
    hideAllSections();
    document.getElementById("searchSection").style.display="block";
    document.getElementById("searchInput").value = '';
    document.getElementById("feederSelect").value = '';
    document.getElementById("nidInput").value = '';
    document.getElementById("mobileInput").value = '';
    document.getElementById("generatedAppNo").textContent = '‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
    currentInputNumber = '';
}

function showDataCollectionSection(){
    hideAllSections();
    document.getElementById("dataCollectionSection").style.display="block";
}

function showFormSection(){
    hideAllSections();
    document.getElementById("formSection").style.display="block";
    document.getElementById("rechargeSection").style.display = 'block'; 
}

function showSAESection(){
    hideAllSections();
    document.getElementById("saeSection").style.display="block";

    // Populate SAE section info
    document.getElementById("saeAppNo").textContent = applicationData.application_no || '_________ (N/A)';
    document.getElementById("saeCustomerName").textContent = applicationData.customer_name || 'N/A';
}

function showFinalApprovalSection(){
    hideAllSections();
    document.getElementById("finalApprovalSection").style.display="block";

    // Populate Final Approval section info
    document.getElementById("finalAppNo").textContent = applicationData.application_no || '_________ (N/A)';
    document.getElementById("finalCustomerName").textContent = applicationData.customer_name || 'N/A';
    document.getElementById("finalReport").textContent = applicationData.saeReport || document.getElementById("saeReport").value || 'No Report';
}

function backToApplication(){
    showFormSection();
}

function backToSae(){
    showSAESection();
}

function closeForm(){
    if(window.AndroidInterface && AndroidInterface.closeApplication){ 
        AndroidInterface.closeApplication(); 
    }
}


// --- Search and Data Fetching ---
function selectType(t){
    selectedType=t;
    document.getElementById("prepaidBtn").classList.toggle("active",t==="prepaid");
    document.getElementById("postpaidBtn").classList.toggle("active",t==="postpaid");

    const input = document.getElementById("searchInput");
    if (t === 'prepaid') {
        input.placeholder = '‡ßß‡ß® ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
    } else {
        input.placeholder = '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
    }
}

function fetchData(){
    const input=document.getElementById("searchInput").value.trim();
    if(!input){ showError("‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!"); return; }

    currentInputNumber = input;
    showLoading();

    if(window.AndroidInterface && AndroidInterface.fetchDataForApplication){
        try{
            const result=AndroidInterface.fetchDataForApplication(input,selectedType);
            const data=JSON.parse(result);
            currentCustomerType = selectedType;

            if(data.error){ showError(data.error); return; }

            applicationData = data; // Store data globally

            // Populate Data Collection screen fields
            document.getElementById("previewCustomerName").textContent = data.customer_name || 'N/A';
            document.getElementById("previewAddress").textContent = data.address || 'N/A';
            document.getElementById("previewMobileNo").textContent = data.mobile_no || 'N/A';
            document.getElementById("mobileInput").value = data.mobile_no || '';

            showDataCollectionSection();

        }catch(err){ 
            showError("App error: ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ "+err); 
        } finally {
            hideLoading();
        }
    } else {
        showError("AndroidInterface.fetchDataForApplication ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡•§");
        hideLoading();
    }
}


// --- Application Number Generation ---
function generateApplicationNo() {
    const feeder = document.getElementById("feederSelect").value;
    if (!feeder) {
        document.getElementById("generatedAppNo").textContent = "‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®";
        return;
    }

    const now = new Date();
    const dateStr = now.toLocaleDateString('en-GB').replace(/\//g, '.');
    const timeStr = now.toLocaleTimeString('en-GB', { hour12: false }).replace(/:/g, '-');
    const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    
    const appNo = `${feeder}-${dateStr}-${timeStr}-${randomNum}`;
    document.getElementById("generatedAppNo").textContent = appNo;
}


// --- Data Collection and Form Filling ---
function generateApplication() {
    const feeder = document.getElementById("feederSelect").value;
    const nid = document.getElementById("nidInput").value.trim();
    const mobileNo = document.getElementById("mobileInput").value.trim();

    if (!feeder) {
        if(window.AndroidInterface && AndroidInterface.showToast) {
            AndroidInterface.showToast("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        } else { alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"); }
        return;
    }

    // Update mobile number in application data
    applicationData.mobile_no = mobileNo || applicationData.mobile_no;
    
    // Store collected data
    applicationData.feeder = feeder;
    applicationData.nid = nid;
    applicationData.application_no = document.getElementById("generatedAppNo").textContent;

    fillFormWithData(applicationData);
    showFormSection();
}

function fillFormWithData(data){
    document.getElementById("applicationNoDisplay").textContent = data.application_no || '_________';

    // Fill all static fields
    document.getElementById("staticCustomerName").textContent = data.customer_name || '_____________';
    document.getElementById("staticFatherName").textContent = data.father_name || '_____________';
    document.getElementById("staticAddress").textContent = data.address || '_____________';
    document.getElementById("staticMobileNo").textContent = data.mobile_no || '_____________';
    document.getElementById("staticNid").textContent = data.nid || '_____________';

    if (currentCustomerType === 'prepaid') {
        document.getElementById("staticMeterNo").textContent = currentInputNumber || "_____________";
        document.getElementById("staticConsumerNo").textContent = data.consumer_no || "_____________";
    } else {
        document.getElementById("staticMeterNo").textContent = data.meter_no || "_____________";
        document.getElementById("staticConsumerNo").textContent = currentInputNumber || "_____________";
    }

    document.getElementById("arrear").textContent = (data.arrear && data.arrear!=="0") ? data.arrear : "‡¶ï‡ßã‡¶®‡¶ì ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á";

    const rechargeSection = document.getElementById("rechargeSection");
    if (currentCustomerType === 'prepaid' && data.recharges) {
        rechargeSection.style.display = 'block';
        const rechargeData = data.recharges || [];

        for (let i = 1; i <= 3; i++) {
            const r = rechargeData[i - 1];
            document.getElementById(`rechargeDate${i}`).textContent = r ? (r.Date || "-") : "";
            document.getElementById(`rechargeAmount${i}`).textContent = r ? (r.Amount || "-") : "";
        }
    } else {
        rechargeSection.style.display = 'none';
    }
}


// --- Approval Logic ---
function toggleSaeRejectReason(show) {
    document.getElementById("saeRejectReason").classList.toggle("hidden", !show);
}

function saveSaeReport() {
    const action = document.querySelector('input[name="saeAction"]:checked');
    const report = document.getElementById("saeReport").value;
    const rejectReason = document.getElementById("saeRejectText").value;

    if (!action) {
         if(window.AndroidInterface && AndroidInterface.showToast) AndroidInterface.showToast('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
         return;
    }

    const reportData = {
        application_no: applicationData.application_no,
        action: action.value,
        report: report,
        rejectReason: action.value === 'reject' ? rejectReason : null
    };

    // Store the report text globally (used for the next screen preview)
    applicationData.saeReport = report;

    // TODO: Call AndroidInterface.saveSaeReport(JSON.stringify(reportData));
    if(window.AndroidInterface && AndroidInterface.showToast) AndroidInterface.showToast(`SAE ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${reportData.action}`);

    backToApplication();
}

function toggleFinalRejectReason(show) {
    document.getElementById("finalRejectReason").classList.toggle("hidden", !show);
}

function saveFinalApproval() {
    const action = document.querySelector('input[name="finalAction"]:checked');
    const rejectReason = document.getElementById("finalRejectText").value;

    if (!action) {
         if(window.AndroidInterface && AndroidInterface.showToast) AndroidInterface.showToast('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
         return;
    }

    const finalData = {
        application_no: applicationData.application_no,
        action: action.value,
        rejectReason: action.value === 'reject' ? rejectReason : null
    };

    // TODO: Call AndroidInterface.saveFinalApproval(JSON.stringify(finalData));
    if(window.AndroidInterface && AndroidInterface.showToast) AndroidInterface.showToast(`‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${finalData.action}`);

    showSearchSection(); // Go back to start after final decision
}


// --- Initialization and Events ---
function saveAsPDF() {
    if (window.AndroidInterface && AndroidInterface.saveAsPDF) {
        AndroidInterface.saveAsPDF();
    } else {
        alert('PDF ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®');
        window.print();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    showSearchSection(); 
    selectType(selectedType);
});

// Allow Enter key to search
document.getElementById("searchInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        fetchData();
    }
});
</script>
</body>
</html>