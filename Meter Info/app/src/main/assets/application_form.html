<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶™‡¶§‡ßç‡¶∞</title>
    <style>
        /* --- General Styles --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            font-size: 14px;
            line-height: 1.4;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 100%;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none !important;
        }

        /* --- Header Section --- */
        .title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .application-no {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }

        .header {
            text-align: left;
            font-weight: 500;
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.4;
        }

        /* --- Data Collection Screen --- */
        .data-collection-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .preview-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .info-line {
            margin-bottom: 12px;
        }

        .info-label {
            font-weight: 500;
            display: block;
            margin-bottom: 4px;
            color: #555;
        }

        .static-value {
            font-weight: bold;
            color: #111;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 4px;
        }

        .feeder-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        /* --- Main Form Section --- */
        .complain-box {
            background: #e9ecef;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            margin: 15px 0;
            border-radius: 6px;
            font-size: 16px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .content-grid {
                grid-template-columns: 60% 40%;
            }
        }

        .complaints {
            line-height: 1.6;
        }

        .complaint-item {
            margin: 6px 0;
            font-size: 13px;
            display: flex;
            align-items: flex-start;
        }

        .complaint-checkbox {
            margin-right: 8px;
            margin-top: 2px;
        }

        .complaint-label {
            flex: 1;
        }

        #otherComplaintInput {
            border: none;
            border-bottom: 1px dashed #000;
            background: transparent;
            margin-left: 5px;
            flex: 1;
            font-size: 13px;
            padding: 2px 4px;
        }

        .recharge-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
        }

        .recharge-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .recharge-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .recharge-table th, .recharge-table td {
            border: 1px solid #000;
            padding: 6px 8px;
            text-align: center;
        }

        .recharge-table th {
            background: #e9ecef;
            font-weight: bold;
        }

        /* --- Signature --- */
        .signature {
            text-align: right;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
            font-weight: bold;
        }

        /* --- Buttons --- */
        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* --- Search Section --- */
        .search-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .type-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
        }

        .type-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .search-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- Status Messages --- */
        .loading, .error {
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            margin: 10px 0;
        }

        .loading {
            background: #d1ecf1;
            color: #0c5460;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        /* --- Approval Sections --- */
        .approval-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .application-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .radio-group {
            margin: 15px 0;
        }

        .radio-label {
            display: block;
            margin: 8px 0;
            cursor: pointer;
        }

        .report-textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
        }

        /* --- Print Styles --- */
        @media print {
            body {
                padding: 0;
                background: white;
                font-size: 12px;
            }
            
            .container {
                box-shadow: none;
                padding: 10px;
            }
            
            .no-print, .action-buttons, .search-section, .edit-controls {
                display: none !important;
            }
            
            .content-grid {
                display: grid !important;
                grid-template-columns: 60% 40% !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- Search Section -->
        <div class="search-section" id="searchSection">
            <h2 style="text-align:center; margin-bottom:15px;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</h2>
            
            <div class="type-selector">
                <div class="type-btn active" id="prepaidBtn" onclick="selectType('prepaid')">‡¶™‡ßç‡¶∞‡¶ø‡¶™‡ßá‡¶á‡¶°</div>
                <div class="type-btn" id="postpaidBtn" onclick="selectType('postpaid')">‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶™‡ßá‡¶á‡¶°</div>
            </div>

            <div class="search-row">
                <input type="text" id="searchInput" class="search-input" placeholder="‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" autofocus>
                <button id="searchBtn" class="search-btn" onclick="fetchData()">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
            </div>

            <div class="loading hidden" id="loading">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
            <div class="error hidden" id="error"></div>
        </div>

        <!-- Data Collection Screen (Shown First After Search) -->
        <div class="data-collection-section hidden" id="dataCollectionSection">
            <div class="title">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á</div>
            
            <div class="preview-info">
                <div class="info-line">
                    <span class="info-label">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É</span>
                    <span class="static-value" id="previewCustomerName"></span>
                </div>
                <div class="info-line">
                    <span class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡¶É</span>
                    <span class="static-value" id="previewAddress"></span>
                </div>
            </div>

            <div class="info-line">
                <span class="info-label">‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡¶É</span>
                <select class="feeder-select" id="feederSelect">
                    <option value="">-- ‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
                    <option value="amb">AMBARI - amb</option>
                    <option value="bor">BOROPARA - bor</option>
                    <option value="der">DERAI - der</option>
                    <option value="mo">MOLLIKOUR - mo</option>
                    <option value="han">HASANNOGOR - han</option>
                    <option value="bet">BETGONJ - bet</option>
                    <option value="sho">SHOLOGOR - sho</option>
                    <option value="tha">THANA - tha</option>
                </select>
            </div>

            <div class="info-line">
                <span class="info-label">‡¶è‡¶®‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç‡¶É</span>
                <input type="text" class="form-input" id="nidInput" placeholder="‡¶è‡¶®‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="generateApplication()">‚úÖ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶™‡¶§‡ßç‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-secondary" onclick="showSearchSection()">‚Üê ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡ßã‡¶Å‡¶ú</button>
            </div>
        </div>

        <!-- Main Application Form -->
        <div class="form-section hidden" id="formSection">
            <div class="title">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡¶§‡ßç‡¶∞</div>
            <div class="application-no" id="applicationNoDisplay">Application no: ________</div>

            <div class="header">
                ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶π‡ßÄ ‡¶™‡ßç‡¶∞‡¶ï‡ßå‡¶∂‡¶≤‡ßÄ<br>
                ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ì ‡¶¨‡¶ø‡¶§‡¶∞‡¶£ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó<br>
                ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶â‡¶®‡ßç‡¶®‡ßü‡¶® ‡¶¨‡ßã‡¶∞‡ßç‡¶°<br>
                ‡¶∏‡ßÅ‡¶®‡¶æ‡¶Æ‡¶ó‡¶û‡ßç‡¶ú
            </div>

            <div class="edit-controls no-print">
                <button class="btn btn-warning" onclick="toggleEditMode()" id="editToggleBtn">‚úèÔ∏è ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <!-- Customer Information -->
            <div class="info-line">
                <span class="info-label">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï/‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É</span>
                <span class="static-value" id="staticCustomerName"></span>
                <input type="text" class="form-input hidden editable-field" id="editableCustomerName">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶™‡¶ø‡¶§‡¶æ/‡¶∏‡ßç‡¶¨‡¶æ‡¶Æ‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É</span>
                <span class="static-value" id="staticFatherName"></span>
                <input type="text" class="form-input hidden editable-field" id="editableFatherName">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡¶É</span>
                <span class="static-value" id="staticAddress"></span>
                <input type="text" class="form-input hidden editable-field" id="editableAddress">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶ü‡ßá‡¶≤‡¶ø‡¶´‡ßã‡¶® ‡¶®‡¶Ç‡¶É</span>
                <span class="static-value" id="staticMobileNo"></span>
                <input type="tel" class="form-input hidden editable-field" id="editableMobileNo">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç‡¶É</span>
                <span class="static-value" id="staticMeterNo"></span>
                <input type="text" class="form-input hidden editable-field" id="editableMeterNo">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç‡¶É</span>
                <span class="static-value" id="staticConsumerNo"></span>
                <input type="text" class="form-input hidden editable-field" id="editableConsumerNo">
                <span style="margin-left:15px;"><b>‡¶¨‡¶ï‡ßá‡ßü‡¶æ‡¶É</b> <span id="arrear"></span></span>
            </div>

            <div class="complain-box">‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó</div>

            <div class="content-grid">
                <!-- Complaints List -->
                <div class="complaints">
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint1">
                        <label class="complaint-label" for="complaint1">‡ßß. ‡¶≤‡ßã‡¶° ‡¶õ‡¶æ‡ßú‡¶æ‡¶ì ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡ßá / ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡ßá ‡¶®‡¶æ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint2">
                        <label class="complaint-label" for="complaint2">‡ß®. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶ü‡ßÅ‡¶á‡¶∏‡ßç‡¶ü ‡¶∏‡ßÄ‡¶≤/‡¶≤‡ßÄ‡¶°/‡¶™‡ßç‡¶Ø‡¶æ‡¶°‡¶≤‡¶ï ‡¶∏‡ßÄ‡¶≤ ‡¶≠‡¶æ‡¶ô‡ßç‡¶ó‡¶æ / ‡¶ö‡ßÅ‡¶∞‡¶ø</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint3">
                        <label class="complaint-label" for="complaint3">‡ß©. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶≠‡ßá‡¶ô‡ßç‡¶ó‡ßá / ‡¶π‡¶æ‡¶∞‡¶ø‡ßü‡ßá / ‡¶™‡ßÅ‡ßú‡ßá ‡¶ó‡ßá‡¶õ‡ßá</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint4">
                        <label class="complaint-label" for="complaint4">‡ß™. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶®‡ßç‡¶§‡¶∞ / ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶ó‡ßç‡¶∞‡¶π‡ßÄ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint5">
                        <label class="complaint-label" for="complaint5">‡ß´. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá‡¶§‡ßá ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶è‡¶≤‡ßã‡¶Æ‡ßá‡¶≤‡ßã</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint6">
                        <label class="complaint-label" for="complaint6">‡ß¨. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶π‡¶æ‡¶∞‡¶ø‡ßü‡ßá‡¶õ‡ßá</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint7">
                        <label class="complaint-label" for="complaint7">‡ß≠. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint8">
                        <label class="complaint-label" for="complaint8">‡ßÆ. ‡¶ü‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶®‡¶æ‡¶≤ ‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint9">
                        <label class="complaint-label" for="complaint9">‡ßØ. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶®‡ßá‡¶á</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint10">
                        <label class="complaint-label" for="complaint10">‡ßß‡ß¶. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶°‡ßá‡¶ü/‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint11">
                        <label class="complaint-label" for="complaint11">‡ßß‡ßß. ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint12">
                        <label class="complaint-label" for="complaint12">‡ßß‡ß®. ‡¶≤‡ßã‡¶° ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint13">
                        <label class="complaint-label" for="complaint13">‡ßß‡ß©. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø/‡¶≤‡ßã-‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡ßá‡¶ú ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint14">
                        <label class="complaint-label" for="complaint14">‡ßß‡ß™. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶®‡ßá‡¶á</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint15">
                        <label class="complaint-label" for="complaint15">‡ßß‡ß´. ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</label>
                        <input type="text" id="otherComplaintInput" placeholder="------------------------">
                    </div>
                </div>

                <!-- Recharge Section -->
                <div class="recharge-section" id="rechargeSection">
                    <div class="recharge-title">‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶∞‡¶ø‡¶ö‡¶æ‡¶∞‡ßç‡¶ú‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</div>
                    <table class="recharge-table">
                        <tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th></tr>
                        <tr><td id="rechargeDate1">&nbsp;</td><td id="rechargeAmount1">&nbsp;</td></tr>
                        <tr><td id="rechargeDate2">&nbsp;</td><td id="rechargeAmount2">&nbsp;</td></tr>
                        <tr><td id="rechargeDate3">&nbsp;</td><td id="rechargeAmount3">&nbsp;</td></tr>
                    </table>
                </div>
            </div>

            <div class="signature">
                ...........................<br>
                ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶∏‡¶æ‡¶ï‡ßç‡¶∑‡¶∞
            </div>

            <div class="action-buttons no-print">
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                <button class="btn btn-success" onclick="saveAsPDF()">üìÑ PDF ‡¶∏‡ßá‡¶≠</button>
                <button class="btn btn-warning" onclick="showSAESection()">üìã SAE ‡¶§‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
                <button class="btn btn-secondary" onclick="showSearchSection()">‚Üê ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡ßã‡¶Å‡¶ú</button>
            </div>
        </div>

        <!-- SAE Section -->
        <div class="approval-section hidden" id="saeSection">
            <div class="title">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶ì ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡¶æ‡ßü‡¶® (SAE)</div>
            
            <div class="application-info">
                <div><strong>‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç:</strong> <span id="saeAppNo"></span></div>
                <div><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="saeCustomerName"></span></div>
            </div>

            <div class="info-line">
                <span class="info-label">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶É</span>
                <textarea class="report-textarea" id="saeReport" placeholder="‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
            </div>

            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="saeAction" value="verify" onclick="toggleSaeRejectReason(false)">
                    ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®
                </label>
                <label class="radio-label">
                    <input type="radio" name="saeAction" value="reject" onclick="toggleSaeRejectReason(true)">
                    ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </label>
            </div>

            <div class="info-line hidden" id="saeRejectReason">
                <span class="info-label">‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶æ‡¶∞‡¶£‡¶É</span>
                <input type="text" class="form-input" id="saeRejectText" placeholder="‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveSaeReport()">üíæ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-secondary" onclick="backToApplication()">‚Üê ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>

        <!-- Final Approval Section -->
        <div class="approval-section hidden" id="finalApprovalSection">
            <div class="title">‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</div>
            
            <div class="application-info">
                <div><strong>‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç:</strong> <span id="finalAppNo"></span></div>
                <div><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="finalCustomerName"></span></div>
                <div><strong>‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü:</strong> <span id="finalReport"></span></div>
            </div>

            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="finalAction" value="approve" onclick="toggleFinalRejectReason(false)">
                    ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </label>
                <label class="radio-label">
                    <input type="radio" name="finalAction" value="reject" onclick="toggleFinalRejectReason(true)">
                    ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
                </label>
            </div>

            <div class="info-line hidden" id="finalRejectReason">
                <span class="info-label">‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶æ‡¶∞‡¶£‡¶É</span>
                <input type="text" class="form-input" id="finalRejectText" placeholder="‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveFinalApproval()">‚úÖ ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-secondary" onclick="backToSae()">‚Üê SAE ‡¶§‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>

    </div>

 <script>
    // Global variables
    let selectedType = 'prepaid';
    let currentCustomerType = 'prepaid';
    let currentInputNumber = '';
    let isEditMode = false;
    let applicationData = {}; // Global object to hold fetched data

    // Initialize the page
    function initializePage() {
        selectType('prepaid');
        showSearchSection();
    }

    // --- State Management ---
    function showSearchSection() {
        document.getElementById("searchSection").style.display = "block";
        document.getElementById("formSection").style.display = "none";
        document.getElementById("dataCollectionSection").style.display = "none";
        document.getElementById("saeSection").style.display = "none";
        document.getElementById("finalApprovalSection").style.display = "none";
        document.getElementById("searchInput").value = ""; // Clear input

        if (isEditMode) {
            toggleEditMode(); // Reset to view mode
        }
        hideError();
    }

    function showDataCollectionSection() {
        document.getElementById("searchSection").style.display = "none";
        document.getElementById("dataCollectionSection").style.display = "block";
    }
    
    function showFormSection() {
        document.getElementById("dataCollectionSection").style.display = "none";
        document.getElementById("formSection").style.display = "block";
    }

    // --- Search & Fetching (Synchronous Call) ---

    function selectType(type) {
        selectedType = type;
        document.getElementById("prepaidBtn").classList.toggle("active", type === "prepaid");
        document.getElementById("postpaidBtn").classList.toggle("active", type === "postpaid");

        const input = document.getElementById("searchInput");
        if (type === 'prepaid') {
            input.placeholder = '‡ßß‡ß® ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
        } else {
            input.placeholder = '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
        }
    }

    /**
     * Calls the Android method fetchDataForApplication() synchronously 
     * and handles the returned JSON string.
     */
    function fetchData() {
        const input = document.getElementById("searchInput").value.trim();
        if (!input) { 
            showError("‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!"); 
            return; 
        }

        currentInputNumber = input;
        currentCustomerType = selectedType;
        showLoading();
        hideError();

        try {
            if (window.AndroidInterface && AndroidInterface.fetchDataForApplication) {
                // **KEY CHANGE:** Call Android synchronously and receive JSON string immediately
                const dataJson = AndroidInterface.fetchDataForApplication(currentInputNumber, currentCustomerType);
                
                // Process the returned data
                processFetchedData(dataJson);
                
            } else {
                // Fallback for missing Android Interface
                console.error("AndroidInterface.fetchDataForApplication is missing.");
                showError("‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡ßá‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ (Android ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶´‡ßá‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§)");
            }
        } catch (e) {
            console.error("JS Error during fetchData:", e);
            showError("‡¶ú‡¶æ‡¶≠‡¶æ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
        } finally {
            hideLoading();
        }
    }

    /**
     * Processes the JSON string returned from Android.
     */
    function processFetchedData(dataJson) {
        try {
            const data = JSON.parse(dataJson);

            if (data.error || !data.customer_name) { 
                showError(data.error || "‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§"); 
                return; 
            }
            
            applicationData = data; // Store data globally
            
            // Populate Data Collection screen for verification
            document.getElementById("previewCustomerName").textContent = data.customer_name || 'N/A';
            document.getElementById("previewAddress").textContent = data.address || 'N/A';
            
            showDataCollectionSection();

        } catch (e) {
            console.error("Error parsing received data:", e);
            showError("‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§");
        }
    }


    // --- Data Collection Screen & Form Population ---

    function generateApplication() {
        const feeder = document.getElementById("feederSelect").value;
        const nid = document.getElementById("nidInput").value.trim();

        if (!feeder) {
            AndroidInterface.showToast("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            return;
        }

        // NID is optional or can be validated later, proceeding for now.

        // Add collected data to the main object
        applicationData.feeder = feeder;
        applicationData.nid = nid;

        // Now, populate and show the main form
        fillFormWithData(applicationData);
        showFormSection();
    }

    function fillFormWithData(data) {
        // APPLICATION NO.
        document.getElementById("applicationNoDisplay").textContent = `Application no: ${data.application_no || '_________ (N/A)'}`;
        
        // STATIC DISPLAY FIELDS
        document.getElementById("staticCustomerName").textContent = data.customer_name || '_____________';
        document.getElementById("staticFatherName").textContent = data.father_name || '_____________';
        document.getElementById("staticAddress").textContent = data.address || '_____________';
        document.getElementById("staticMobileNo").textContent = data.mobile_no || '_____________';
        document.getElementById("staticMeterNo").textContent = data.meter_no || "_____________";
        document.getElementById("staticConsumerNo").textContent = data.consumer_no || "_____________";
        document.getElementById("arrear").textContent = (data.arrear && data.arrear !== "0") ? data.arrear : "‡¶ï‡ßã‡¶®‡¶ì ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶®‡ßá‡¶á";

        // EDITABLE INPUTS (Pre-fill for edit mode)
        document.getElementById("editableCustomerName").value = data.customer_name || '';
        document.getElementById("editableFatherName").value = data.father_name || '';
        document.getElementById("editableAddress").value = data.address || '';
        document.getElementById("editableMobileNo").value = data.mobile_no || '';
        document.getElementById("editableMeterNo").value = data.meter_no || '';
        document.getElementById("editableConsumerNo").value = data.consumer_no || '';
        
        // Handle recharge data
        const rechargeSection = document.getElementById("rechargeSection");
        if (currentCustomerType === 'prepaid' && data.recharges && data.recharges.length > 0) {
            rechargeSection.style.display = "block";
            const rechargeData = data.recharges;
            for (let i = 1; i <= 3; i++) {
                const recharge = rechargeData[i - 1];
                if (recharge) {
                    document.getElementById(`rechargeDate${i}`).textContent = recharge.Date || "-";
                    document.getElementById(`rechargeAmount${i}`).textContent = recharge.Amount || "-";
                } else {
                    document.getElementById(`rechargeDate${i}`).innerHTML = "&nbsp;";
                    document.getElementById(`rechargeAmount${i}`).innerHTML = "&nbsp;";
                }
            }
        } else {
             rechargeSection.style.display = "none";
        }
    }


    // --- Core Action Functions (Linked to Android) ---

    // **NEW** Function to call Android's PDF saving logic
    function saveAsPDF() {
        if (window.AndroidInterface && AndroidInterface.saveAsPDF) {
            AndroidInterface.saveAsPDF();
        } else {
            // Fallback for web testing
            alert('PDF ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®');
            window.print();
        }
    }

    // **NEW** Function to close the Android Activity
    function closeApp() {
        if (window.AndroidInterface && AndroidInterface.closeApplication) {
            AndroidInterface.closeApplication();
        }
    }

    // --- Utility Functions (Loading, Error, Edit Mode, etc.) ---

    function toggleEditMode() {
        isEditMode = !isEditMode;
        const editBtn = document.getElementById("editToggleBtn");

        if (isEditMode) {
            document.querySelectorAll('.static-value').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.editable-field').forEach(el => el.classList.remove('hidden'));
            editBtn.textContent = 'üíæ ‡¶è‡¶°‡¶ø‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®';
            editBtn.style.backgroundColor = '#28a745';
        } else {
            document.querySelectorAll('.static-value').forEach(el => {
                const fieldId = el.id.replace('static', 'editable');
                const inputElement = document.getElementById(fieldId);
                if (inputElement) {
                    const inputValue = inputElement.value;
                    el.textContent = inputValue || '_____________';
                    el.classList.remove('hidden');
                }
            });
            document.querySelectorAll('.editable-field').forEach(el => el.classList.add('hidden'));
            editBtn.textContent = '‚úèÔ∏è ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
            editBtn.style.backgroundColor = '#ffc107';

            saveEditedData();
        }
    }

    function saveEditedData() {
        const editedData = {
            customerName: document.getElementById('editableCustomerName').value,
            fatherName: document.getElementById('editableFatherName').value,
            address: document.getElementById('editableAddress').value,
            mobileNo: document.getElementById('editableMobileNo').value,
            meterNo: document.getElementById('editableMeterNo').value,
            consumerNo: document.getElementById('editableConsumerNo').value
        };

        // Update the global data object after saving
        applicationData = {...applicationData, ...editedData};
        
        // You would typically call a native method here to save edits
        // Example: AndroidInterface.saveEditedData(JSON.stringify(editedData));
        if (window.AndroidInterface && AndroidInterface.showToast) {
            AndroidInterface.showToast("‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
        }
    }

    function showLoading() {
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("searchBtn").disabled = true;
        document.getElementById("searchBtn").textContent = "‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...";
    }

    function hideLoading() {
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("searchBtn").disabled = false;
        document.getElementById("searchBtn").textContent = "‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®";
    }

    function showError(message) {
        const errorElement = document.getElementById("error");
        errorElement.textContent = message;
        errorElement.classList.remove("hidden");
        hideLoading();
    }

    function hideError() {
        document.getElementById("error").classList.add("hidden");
    }


    // --- Approval Sections (SAE and Final Approval - Simplified Stubs) ---
    
    // In a production app, saveSaeReport() would call a native method
    function saveSaeReport() {
        // ... (SAE logic to gather reportData) ...
        if (window.AndroidInterface && AndroidInterface.showToast) {
            AndroidInterface.showToast('SAE ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
        }
        backToApplication();
    }

    // In a production app, saveFinalApproval() would call a native method
    function saveFinalApproval() {
        // ... (Final approval logic) ...
        if (window.AndroidInterface && AndroidInterface.showToast) {
            AndroidInterface.showToast('‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá');
        }
        backToSae();
    }
    
    // Remaining approval functions (showSAESection, toggleSaeRejectReason, backToApplication, etc.) remain as they were.

    function showSAESection() {
        document.getElementById("formSection").style.display = "none";
        document.getElementById("saeSection").style.display = "block";
        document.getElementById("saeAppNo").textContent = applicationData.application_no || '_________ (N/A)';
        document.getElementById("saeCustomerName").textContent = applicationData.customerName || applicationData.customer_name;
    }

    function toggleSaeRejectReason(show) {
        document.getElementById("saeRejectReason").classList.toggle("hidden", !show);
    }

    function backToApplication() {
        document.getElementById("saeSection").style.display = "none";
        document.getElementById("formSection").style.display = "block";
    }

    function toggleFinalRejectReason(show) {
        document.getElementById("finalRejectReason").classList.toggle("hidden", !show);
    }

    function backToSae() {
        document.getElementById("finalApprovalSection").style.display = "none";
        document.getElementById("saeSection").style.display = "block";
    }


    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();

        // Enter key support for search
        document.getElementById("searchInput").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                fetchData();
            }
        });
    });
</script>
</body>
</html>