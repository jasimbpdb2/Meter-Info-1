<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶™‡¶§‡ßç‡¶∞</title>

    <style>
        /* ---------------------------------------------------
           MOBILE FIRST STYLING
        ----------------------------------------------------*/
        body {
            font-family: "Shonar Bangla", serif;
            margin: 0;
            padding: 15px 25px;
            font-size: 16px;
            line-height: 1.6;
        }

        /* ** FIX: Robust hiding of elements ** */
        .hidden {
            display: none !important;
        }

        /* --- Login Section --- */
        .login-section {
            width: 100%;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .login-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* --- Dashboard Section --- */
        .dashboard-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .user-info {
            background: #e3f2fd;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
        }

        .dashboard-title {
            text-align: center;
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .action-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .action-card:active {
            border-color: #007bff;
            background: #e3f2fd;
            transform: scale(0.98);
        }

        .action-card h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .action-card p {
            margin: 0;
            color: #666;
            font-size: 13px;
        }

        /* --- Status Badges --- */
        .status-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-assigned { background: #d1ecf1; color: #0c5460; }
        .status-verified { background: #d4edda; color: #155724; }
        .status-approved { background: #d1e7dd; color: #0f5132; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .status-completed { background: #d1e7dd; color: #0f5132; }
        .status-action-taken { background: #e2e3e5; color: #383d41; }

        /* --- Header Section --- */
        .title {
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .APPLICATION_NO {
            text-align: right;
            font-size: 13px;
            margin-bottom: 8px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .header {
            text-align: left;
            font-weight: 500;
            margin-bottom: 12px;
            font-size: 13px;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd;
        }

        /* --- Customer Information Section --- */
        /* Applicant info */
        .info-line {
            font-size: 17px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
        }
        .info-label {
            font-weight: normal;
            min-width: 180px;
        }
        .info-value {
            font-weight: bold;
        }

        /* Editable fields */
        .editable-field {
            border: 1px dashed #ccc;
            background: #f9f9f9;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 16px;
            width: 250px;
            font-family: "Shonar Bangla", serif;
            font-weight: bold;
        }

        .editable-field:focus {
            border-color: #3498db;
            background: #fff;
            outline: none;
        }

        .static-value {
            font-weight: bold;
        }

        /* Title */
        .title {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* --- Complaint Section --- */
        .complain-box {
            border: none;
            background: #f0f0f0;
            padding: 8px;
            width: 100%;
            margin: 10px 0 6px 0;
            text-align: center;
            font-size: 16px;
            font-weight: 700;
        }
        .content-grid {
            display: block;
            margin-top: 8px;
        }
         /* Two-column area: complaints left, recharge table right */
        .content-grid {
            display: grid;
            grid-template-columns: 65% 35%;
            grid-gap: 6px;
        }
        .complaints {
            line-height: 1.5;
            margin-bottom: 15px;
        }

        /* FIX: Checkbox styles for mobile */
        .complaint-item {
            display: flex;
            align-items: flex-start;
            margin: 4px 0;
            font-size: 12px;
            font-weight: normal;
            page-break-inside: avoid;
        }
        .complaint-checkbox {
            margin-right: 8px;
            margin-top: 2px;
            transform: scale(1.2);
            min-width: 18px;
        }
        .complaint-label {
            flex: 1;
            line-height: 1.3;
        }
        #otherComplaintInput {
            border: none;
            border-bottom: 1px dashed #000;
            background: transparent;
            margin-left: 5px;
            width: 150px;
            font-size: 12px;
            padding: 0 4px;
        }

        /* Recharge section title */
        .recharge-title {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
        }

        /* Recharge Table */
        .recharge-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 17px;
        }
        .recharge-table th, .recharge-table td {
            border: 1px solid #000;
            padding: 5px 8px;
            text-align: center;
            height: 26px;
        }


        /* --- Workflow Actions --- */
        .workflow-actions {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
        }

        .workflow-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        /* --- Footer and Buttons --- */
        .signature {
            text-align: right;
            margin-top: 20px;
            padding-top: 6px;
            font-size: 14px;
            font-weight: bold;
        }
        .action-buttons {
            margin-top: 15px;
            text-align: center;
        }
        .btn {
            padding: 10px 14px;
            margin: 4px;
            background: #6c757d;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-height: 44px;
            min-width: 44px;
        }
        .edit-btn {
            padding: 10px 14px;
            background: #ffc107;
            color: #000;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 10px;
        }

        /* Search Section Styles - Mobile Optimized */
        .search-section {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .type-selector {
            display: flex;
            margin-bottom: 10px;
            gap: 5px;
        }
        .type-btn {
            padding: 10px 12px;
            border: 1px solid #ccc;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            flex: 1;
            text-align: center;
        }
        .type-btn.active {
            background: #007bff;
            color: #fff;
        }
        .search-row {
            display: block;
            margin-bottom: 10px;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .search-btn {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            min-height: 44px;
        }
        .loading, .error {
            display: none;
            text-align: center;
            padding: 8px;
            font-size: 14px;
        }
        .loading { color: #007bff; }
        .error { color: #dc3545; background: #f8d7da; }

        /* --- Data Collection Section --- */
        .data-collection-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        /* --- SAE and Final Approval Sections --- */
        .sae-section, .final-approval-section, .action-taken-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid;
        }
        .sae-section { border-color: #007bff; }
        .final-approval-section { border-color: #28a745; }
        .action-taken-section { border-color: #6c757d; }

        /* --- Assignment Section --- */
        .assignment-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #ffc107;
        }

        /* --- Workflow History Section --- */
        .workflow-history {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #007bff;
        }

        .workflow-history-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .workflow-step {
            padding: 6px;
            margin: 4px 0;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #007bff;
            font-size: 12px;
        }

        .workflow-step.completed {
            border-left-color: #28a745;
            background: #f8fff8;
        }

        .workflow-step.rejected {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        /* Mobile specific improvements */
        .mobile-full-width {
            width: 100%;
        }

        .mobile-stack {
            display: block;
        }

        .mobile-padding {
            padding: 8px;
        }

        .mobile-margin {
            margin: 5px 0;
        }

       /* Print Optimization */
@media print {
    body {
        padding: 5mm !important;
        line-height: 1.2;
        font-size: 10px !important;
        margin: 0 !important;
        background: white !important;
    }

    .login-section,
    .dashboard-section,
    .search-section,
    .workflow-actions,
    .data-collection-section,
    .sae-section,
    .final-approval-section,
    .action-taken-section,
    .assignment-section,
    .no-print,
    .edit-controls,
    .editable-field,
    .action-buttons {
        display: none !important;
    }

    .workflow-history {
        display: block !important;
        background: white !important;
        border: 1px solid #ddd !important;
    }

    .content-grid {
        page-break-inside: avoid !important;
        break-inside: avoid !important;
    }

    /* +++ ADD THESE NEW LINES +++ */
    .page-break {
        page-break-after: always;
        break-after: page;
        display: block;
    }

    .workflow-page {
        page-break-before: always;
        margin-top: 0;
        border-top: none;
    }

    .signature {
        margin-bottom: 20mm;
    }
    /* +++ END NEW LINES +++ */
}

        /* Dropdown styles for mobile */
        .assignee-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin: 8px 0;
        }

        /* Textarea mobile optimization */
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-height: 100px;
        }

        /* Radio button mobile optimization */
input[type="radio"] {
    transform: scale(1.2);
    margin-right: 8px;
}

/* ==================== PAGE BREAK STRUCTURE ==================== */
/* Minimal styles for new page structure */
.page-break {
    height: 0;
    margin: 0;
    padding: 0;
    border: none;
}

/* SAE recommendations display */
#billInfoSection {
    background: #fff;
    border: 2px solid #28a745;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}

/* Workflow page styling */
.workflow-page {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 2px dashed #ddd;
}

/* Scrollable workflow steps */
#workflowSteps {

    padding-right: 5px;
}

/* Mobile view adjustments */
@media screen and (max-width: 768px) {
    .workflow-page {
        margin-top: 15px;
        padding-top: 15px;
    }
}

/* Print-specific adjustments */
@media print {
    .page-break {
        page-break-after: always;
        break-after: page;
        display: block;
    }

    .workflow-page {
        page-break-before: always;
        margin-top: 0;
        border-top: none;
        padding-top: 0;
    }

    /* Keep workflow history visible in print */
    .workflow-history {
        display: block !important;
        background: white !important;
        border: 1px solid #ddd !important;
        page-break-inside: avoid;
    }

    /* Hide workflow actions in print (already in your code) */
    .workflow-actions {
        display: none !important;
    }

    /* Hide action buttons in print (already in your code) */
    .action-buttons {
        display: none !important;
    }

    /* Add space before page break */
    .signature {
        margin-bottom: 20mm;
    }
}

/* Mobile view adjustments */
@media screen and (max-width: 768px) {
    .workflow-page {
        margin-top: 15px;
        padding-top: 15px;
    }
}

    </style>
<body>
<!-- Login Section -->
<div class="login-section" id="loginSection">
    <div class="login-title">‡¶≤‡¶ó‡¶á‡¶®</div>
    <input type="text" id="userId" class="login-input" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø" autofocus>
    <input type="password" id="password" class="login-input" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
    <button class="login-btn" onclick="login()">‡¶≤‡¶ó‡¶á‡¶®</button>
    <div class="error" id="loginError"></div>
</div>

<!-- Dashboard Section -->
<div class="dashboard-section hidden" id="dashboardSection">
    <div class="user-info" id="userInfo">
        ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®: <span id="userDisplayName"></span>

        <!-- Firebase Sync Button -->
        <button class="btn" onclick="loadAllApplicationsFromFirebase()"
                style="margin-top: 8px; background: #007bff; width: 100%; margin-bottom: 8px;">
            üîÑ Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>

        <!-- In your dashboard action grid -->
        <div class="action-card" onclick="openExcelView()" style="background: #e6ffe6; border: 2px solid #28a745;">
            <h3>üìä Excel View</h3>
            <p>Application List</p>
            <small style="color: #28a745;">Firebase ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶π</small>
        </div>

        <!-- Logout Button -->
        <button class="btn" onclick="logout()"
                style="margin-top: 0; background: #dc3545; width: 100%;">
            ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
        </button>
    </div>

    <div class="dashboard-title" id="dashboardTitle">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</div>

    <div class="action-grid" id="actionGrid">
        <!-- Actions will be populated based on user role -->
    </div>
</div>

<!-- Application Container -->
<div class="application-container hidden" id="applicationContainer">
    <!-- Search Section -->
    <div class="search-section" id="searchSection">
        <!-- Dashboard Navigation Button -->
        <div style="text-align: center; margin-bottom: 15px;">
            <button class="btn" onclick="showDashboard()"
                    style="background: #6c757d; color: white; padding: 10px 20px; width: 100%; margin-bottom: 8px;">
                üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶Ø‡¶æ‡¶®
            </button>
        </div>

        <h2 style="font-size:16px;margin-bottom:8px;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</h2>

        <div class="type-selector">
            <div class="type-btn active" id="prepaidBtn" onclick="selectType('prepaid')">‡¶™‡ßç‡¶∞‡¶ø‡¶™‡ßá‡¶á‡¶°</div>
            <div class="type-btn" id="postpaidBtn" onclick="selectType('postpaid')">‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶™‡ßá‡¶á‡¶°</div>
        </div>

        <div class="search-row">
            <input type="text" id="searchInput" class="search-input" placeholder="‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"
                   autofocus autocapitalize="none" autocorrect="off" inputmode="numeric">
            <button onclick="fetchData()" id="searchBtn" class="search-btn">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
        </div>

        <div class="loading" id="loading">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        <div class="error" id="error"></div>
    </div>

    <!-- Data Collection Section -->
    <div class="data-collection-section hidden" id="dataCollectionSection">
        <div class="title" style="font-size: 18px;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á</div>

        <div style="background: #f0f0f0; padding: 10px; margin-bottom: 12px; border-radius: 4px;">
            <div class="info-line">
                <span class="info-label">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É</span>
                <span class="info-value" id="previewCustomerName"></span>
            </div>
            <div class="info-line">
                <span class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡¶É</span>
                <span class="info-value" id="previewAddress"></span>
            </div>
            <div class="info-line">
                <span class="info-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Ç‡¶É</span>
                <span class="info-value" id="previewMobileNo"></span>
            </div>
        </div>

        <div class="info-line mobile-stack">
            <span class="info-label">‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡¶É</span>
            <select class="editable-field mobile-full-width" id="feederSelect">
                <option value="">-- ‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
                <option value="amb">AMBARI - amb</option>
                <option value="bor">BOROPARA - bor</option>
                <option value="han">Hasannogor - han</option>
                <option value="mlkpur">Mollikpur - mlkpur</option>
                <option value="der">Derai - der</option>
                <option value="shol">Shologor - shol</option>
                <option value="bet">Betgonj - bet</option>
                <option value="tha">Thana - tha</option>
            </select>
        </div>
        <div class="info-line mobile-stack">
            <span class="info-label">‡¶è‡¶®‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç‡¶É</span>
            <input type="text" class="editable-field mobile-full-width" id="nidInput" placeholder="‡¶è‡¶®‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
        </div>

        <div class="info-line mobile-stack">
            <span class="info-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Ç (‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®)‡¶É</span>
            <input type="tel" class="editable-field mobile-full-width" id="mobileInput" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
        </div>

        <div class="info-line mobile-stack" style="background: #e6f7ff; padding: 10px; border-radius: 4px;">
            <span class="info-label" style="font-weight: bold;">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç‡¶É</span>
            <span class="info-value" id="generatedAppNo" style="color: #007bff;">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶≤‡ßá ‡¶®‡¶Ç ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá</span>
        </div>

        <div class="action-buttons">
            <button class="btn mobile-full-width" style="background-color: #28a745; margin-bottom: 8px;" onclick="generateApplication()">‚úÖ ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶™‡¶§‡ßç‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn mobile-full-width" style="background-color: #6c757d;" onclick="showDashboard()">‚Üê ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
        </div>
    </div>

    <!-- Main Form Section -->
    <div class="form-section hidden" id="formSection">
        <!-- PAGE 1: APPLICATION FORM ONLY -->
        <div class="application-form-page">
            <div class="title">‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡¶§‡ßç‡¶∞</div>
            <div class="APPLICATION_NO">
                ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç: <span id="applicationNoDisplay">________</span>
                <span class="status-badge" id="applicationStatusBadge"></span>
            </div>

            <div class="header">
                ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶π‡ßÄ ‡¶™‡ßç‡¶∞‡¶ï‡ßå‡¶∂‡¶≤‡ßÄ<br>
                ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ì ‡¶¨‡¶ø‡¶§‡¶∞‡¶£ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó<br>
                ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶â‡¶®‡ßç‡¶®‡ßü‡¶® ‡¶¨‡ßã‡¶∞‡ßç‡¶°<br>
                ‡¶∏‡ßÅ‡¶®‡¶æ‡¶Æ‡¶ó‡¶û‡ßç‡¶ú
            </div>

            <div class="edit-controls no-print">
                <button class="edit-btn" onclick="toggleEditMode()" id="editToggleBtn">‚úèÔ∏è ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <div class="info-line">
                <span class="info-label">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï/‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É </span>
                <span class="static-value" id="staticCustomerName"></span>
                <input type="text" class="editable-field hidden" id="editableCustomerName" placeholder="‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶™‡¶ø‡¶§‡¶æ/‡¶∏‡ßç‡¶¨‡¶æ‡¶Æ‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶É </span>
                <span class="static-value" id="staticFatherName"></span>
                <input type="text" class="editable-field hidden" id="editableFatherName" placeholder="‡¶™‡¶ø‡¶§‡¶æ/‡¶∏‡ßç‡¶¨‡¶æ‡¶Æ‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡¶É </span>
                <span class="static-value" id="staticAddress"></span>
                <input type="text" class="editable-field hidden" id="editableAddress" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶ü‡ßá‡¶≤‡¶ø‡¶´‡ßã‡¶® ‡¶®‡¶Ç‡¶É </span>
                <span class="static-value" id="staticMobileNo"></span>
                <input type="tel" class="editable-field hidden" id="editableMobileNo" placeholder="‡¶ü‡ßá‡¶≤‡¶ø‡¶´‡ßã‡¶® ‡¶®‡¶Ç">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶è‡¶®‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç‡¶É </span>
                <span class="static-value" id="staticNid"></span>
            </div>

            <div class="info-line">
                <span class="info-label">‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç‡¶É </span>
                <span class="static-value" id="staticMeterNo"></span>
                <input type="text" class="editable-field hidden" id="editableMeterNo" placeholder="‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç">
            </div>

            <div class="info-line">
                <span class="info-label">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç‡¶É </span>
                <span class="static-value" id="staticConsumerNo"></span>
                <input type="text" class="editable-field hidden" id="editableConsumerNo" placeholder="‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç">
                <div class="inline-info-group">
                    <span class="inline-info">‡¶¨‡¶ï‡ßá‡ßü‡¶æ‡¶É</span>
                    <span class="inline-value" id="arrear"></span>
                </div>
            </div>

            <div class="complain-box">‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó</div>

            <div class="content-grid">
                <div class="complaints">
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint1">
                        <label class="complaint-label" for="complaint1">‡ßß. ‡¶≤‡ßã‡¶° ‡¶õ‡¶æ‡ßú‡¶æ‡¶ì ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡ßá / ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡ßá ‡¶®‡¶æ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint2">
                        <label class="complaint-label" for="complaint2">‡ß®. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶ü‡ßÅ‡¶á‡¶∏‡ßç‡¶ü ‡¶∏‡ßÄ‡¶≤/‡¶≤‡ßÄ‡¶°/‡¶™‡ßç‡¶Ø‡¶æ‡¶°‡¶≤‡¶ï ‡¶∏‡ßÄ‡¶≤ ‡¶≠‡¶æ‡¶ô‡ßç‡¶ó‡¶æ / ‡¶ö‡ßÅ‡¶∞‡¶ø</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint3">
                        <label class="complaint-label" for="complaint3">‡ß©. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶≠‡ßá‡¶ô‡ßç‡¶ó‡ßá / ‡¶π‡¶æ‡¶∞‡¶ø‡ßü‡ßá / ‡¶™‡ßÅ‡ßú‡ßá ‡¶ó‡ßá‡¶õ‡ßá</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint4">
                        <label class="complaint-label" for="complaint4">‡ß™. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶®‡ßç‡¶§‡¶∞ / ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶ó‡ßç‡¶∞‡¶π‡ßÄ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint5">
                        <label class="complaint-label" for="complaint5">‡ß´. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá‡¶§‡ßá ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü ‡¶è‡¶≤‡ßã‡¶Æ‡ßá‡¶≤‡ßã</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint6">
                        <label class="complaint-label" for="complaint6">‡ß¨. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶π‡¶æ‡¶∞‡¶ø‡ßü‡ßá‡¶õ‡ßá</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint7">
                        <label class="complaint-label" for="complaint7">‡ß≠. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint8">
                        <label class="complaint-label" for="complaint8">‡ßÆ. ‡¶ü‡¶æ‡¶∞‡ßç‡¶Æ‡¶ø‡¶®‡¶æ‡¶≤ ‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint9">
                        <label class="complaint-label" for="complaint9">‡ßØ. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶®‡ßá‡¶á</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint10">
                        <label class="complaint-label" for="complaint10">‡ßß‡ß¶. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶°‡ßá‡¶ü/‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint11">
                        <label class="complaint-label" for="complaint11">‡ßß‡ßß. ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint12">
                        <label class="complaint-label" for="complaint12">‡ßß‡ß®. ‡¶≤‡ßã‡¶° ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint13">
                        <label class="complaint-label" for="complaint13">‡ßß‡ß©. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø/‡¶≤‡ßã-‡¶≠‡ßã‡¶≤‡ßç‡¶ü‡ßá‡¶ú ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint14">
                        <label class="complaint-label" for="complaint14">‡ßß‡ß™. ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶®‡ßá‡¶á</label>
                    </div>
                    <div class="complaint-item">
                        <input type="checkbox" class="complaint-checkbox" id="complaint15">
                        <label class="complaint-label" for="complaint15">‡ßß‡ß´. ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø------------------------</label>
                        <input type="text" id="otherComplaintInput" class="hidden" placeholder="‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó">
                    </div>
                </div>

                <div id="rechargeSection">
                    <div class="recharge-title">‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶∞‡¶ø‡¶ö‡¶æ‡¶∞‡ßç‡¶ú‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</div>
                    <table class="recharge-table" id="rechargeTable">
                        <tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th></tr>
                        <tr><td id="rechargeDate1">&nbsp;</td><td id="rechargeAmount1">&nbsp;</td></tr>
                        <tr><td id="rechargeDate2">&nbsp;</td><td id="rechargeAmount2">&nbsp;</td></tr>
                        <tr><td id="rechargeDate3">&nbsp;</td><td id="rechargeAmount3">&nbsp;</td></tr>
                    </table>
                </div>
            </div>

            <!-- Action Taken Section in Form -->
            <div id="actionTakenSectionInForm" class="hidden">
                <div class="complain-box" style="margin-top: 15px;">‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™</div>
                <div class="info-line">
                    <span class="info-label">‡¶ï‡¶∞‡ßç‡¶Æ‡¶ö‡¶æ‡¶∞‡ßÄ‡¶É</span>
                    <span class="static-value" id="staticActionTakenBy"></span>
                </div>
                <div class="info-line">
                    <span class="info-label">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡¶É</span>
                    <span class="static-value" id="staticActionTakenDate"></span>
                </div>
                <div class="info-line">
                    <span class="info-label">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡¶É</span>
                    <span class="static-value" id="staticActionTakenDetails"></span>
                </div>
            </div>

            <div class="signature">...........................<br>‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶∏‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</div>
        </div>

        <!-- PAGE BREAK FOR PRINT -->
        <div class="page-break"></div>

        <!-- PAGE 2: WORKFLOW AND ACTIONS -->
        <div class="workflow-page">
            <!-- Workflow History -->
            <div class="workflow-history" id="workflowHistory">
                <div class="workflow-history-title">‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï‡¶´‡ßç‡¶≤‡ßã ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</div>
                <div id="workflowSteps">
                    <!-- Workflow steps will be populated here -->
                </div>
            </div>

            <div class="workflow-actions" id="workflowActions">
                <div class="workflow-title">‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï‡¶´‡ßç‡¶≤‡ßã ‡¶è‡¶ï‡¶∂‡¶®</div>
                <div id="workflowButtons">
                    <!-- Workflow buttons will be populated based on user role and application status -->
                </div>
            </div>

            <!-- SAE Recommendations Section -->
            <div id="billInfoSection" class="sae-recommendations hidden">
                <!-- Will be populated dynamically -->
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons no-print">
                <!-- Firebase Save Button -->
                <button class="btn mobile-full-width" style="background-color: #17a2b8; margin-bottom: 8px;"
                        onclick="saveToFirebase()">
                    üíæ Firebase-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
                <button class="btn mobile-full-width" style="margin-bottom: 8px;" onclick="printApplication()">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                <button class="btn mobile-full-width" style="margin-bottom: 8px;" onclick="saveAsPDF()">üìÑ PDF ‡¶∏‡ßá‡¶≠</button>
                <button class="btn mobile-full-width" onclick="showDashboard()">‚Üê ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
            </div>
        </div>
    </div>

    <!-- Assignment Section -->
    <div class="assignment-section hidden" id="assignmentSection">
        <div class="title" style="font-size: 18px; color: #ffc107;">‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</div>

        <div style="background: #fffbf0; padding: 10px; margin-bottom: 12px; border-radius: 4px; font-size: 14px;">
            <div><strong>‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç:</strong> <span id="assignAppNo"></span></div>
            <div><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="assignCustomerName"></span></div>
            <div><strong>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</strong> <span id="assignCurrentStatus"></span></div>
        </div>

        <div style="margin-bottom: 12px;">
            <span class="info-label">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶É</span>
            <select class="assignee-select" id="assigneeSelect">
                <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
                <!-- Options will be populated based on role -->
            </select>
        </div>

        <div class="action-buttons">
            <button class="btn mobile-full-width" style="background-color: #28a745; margin-bottom: 8px;" onclick="saveAssignment()">‚úÖ Assign ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn mobile-full-width" style="background-color: #6c757d;" onclick="backToApplication()">‚Üê ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- SAE Section - Add this after the radio buttons but before the action buttons -->
    <div class="sae-section hidden" id="saeSection">
        <div class="title" style="font-size: 18px; color: #007bff;">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶ì ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡¶æ‡ßü‡¶® (SAE)</div>

        <div style="background: #e6f7ff; padding: 10px; margin-bottom: 12px; border-radius: 4px; font-size: 14px;">
            <div><strong>‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç:</strong> <span id="saeAppNo"></span></div>
            <div><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="saeCustomerName"></span></div>
        </div>

        <div style="margin-bottom: 12px;">
            <span class="info-label">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶É</span>
            <textarea id="saeReport" placeholder="‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
        </div>

        <!-- Add this NEW SECTION for bill reason checkboxes -->
        <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
        <span class="info-label" style="font-weight: bold; display: block; margin-bottom: 8px;">
            ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡¶æ‡¶¨ ‡¶ï‡¶∞‡ßÅ‡¶®:
        </span>

            <div id="billReasonCheckboxes" style="max-height: 200px; overflow-y: auto;">
                <!-- Bill reasons will be populated here -->
            </div>

            <!-- Custom reason input -->
            <div style="margin-top: 10px; display: none;" id="customBillReasonContainer">
                <span class="info-label">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ï‡¶æ‡¶∞‡¶£:</span>
                <input type="text" class="editable-field mobile-full-width"
                       id="customBillReason" placeholder="‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
            </div>
        </div>

        <div style="margin: 12px 0;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px;">
                <input type="radio" name="saeAction" value="verify" onclick="toggleSaeRejectReason(false)">
                ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶® (Verify)
            </label>
            <label style="display: block; font-size: 14px;">
                <input type="radio" name="saeAction" value="reject" onclick="toggleSaeRejectReason(true)">
                ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (Reject)
            </label>
        </div>

        <div id="saeRejectReason" class="hidden" style="margin-top: 12px;">
            <span class="info-label">‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶æ‡¶∞‡¶£‡¶É</span>
            <input type="text" class="editable-field mobile-full-width" id="saeRejectText" placeholder="‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
        </div>

        <!-- Additional options -->
        <div style="margin: 15px 0; padding: 10px; background: #e6ffe6; border-radius: 6px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: bold;">
                <input type="checkbox" id="freeOfCost" style="transform: scale(1.2); margin-right: 8px;">
                ‡¶´‡ßç‡¶∞‡¶ø/‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶¨‡¶æ (‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®)
            </label>

            <div style="margin-left: 25px; margin-top: 5px;">
                <label style="display: block; margin-bottom: 5px;">
                    <input type="radio" name="freeReason" value="battery_change" style="transform: scale(1.1); margin-right: 6px;">
                    ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®
                </label>
                <label style="display: block; margin-bottom: 5px;">
                    <input type="radio" name="freeReason" value="eeprom_error" style="transform: scale(1.1); margin-right: 6px;">
                    EEPROM ‡¶è‡¶∞‡¶∞/‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø
                </label>
                <label style="display: block; margin-bottom: 5px;">
                    <input type="radio" name="freeReason" value="technical_reason" style="transform: scale(1.1); margin-right: 6px;">
                    ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ï‡¶æ‡¶∞‡¶£
                </label>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn mobile-full-width" style="background-color: #28a745; margin-bottom: 8px;" onclick="saveSaeReport()">üíæ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn mobile-full-width" style="background-color: #6c757d;" onclick="backToApplication()">‚Üê ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- Final Approval Section -->
    <div class="final-approval-section hidden" id="finalApprovalSection">
        <div class="title" style="font-size: 18px; color: #28a745;">‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</div>

        <div style="background: #e3ffe6; padding: 10px; margin-bottom: 12px; border-radius: 4px; font-size: 14px;">
            <div><strong>‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç:</strong> <span id="finalAppNo"></span></div>
            <div><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="finalCustomerName"></span></div>
            <div><strong>‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü:</strong> <span id="finalReport">N/A</span></div>
        </div>

        <div style="margin: 12px 0;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px;">
                <input type="radio" name="finalAction" value="approve" onclick="toggleFinalRejectReason(false)">
                ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (Approve)
            </label>
            <label style="display: block; font-size: 14px;">
                <input type="radio" name="finalAction" value="reject" onclick="toggleFinalRejectReason(true)">
                ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (Reject)
            </label>
        </div>

        <div id="finalRejectReason" class="hidden" style="margin-top: 12px;">
            <span class="info-label">‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶æ‡¶∞‡¶£‡¶É</span>
            <input type="text" class="editable-field mobile-full-width" id="finalRejectText" placeholder="‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
        </div>

        <div class="action-buttons">
            <button class="btn mobile-full-width" style="background-color: #28a745; margin-bottom: 8px;" onclick="saveFinalApproval()">‚úÖ ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn mobile-full-width" style="background-color: #6c757d;" onclick="backToApplication()">‚Üê ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- Action Taken Section -->
    <div class="action-taken-section hidden" id="actionTakenSection">
        <div class="title" style="font-size: 18px; color: #6c757d;">‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™</div>

        <div style="background: #f8f9fa; padding: 10px; margin-bottom: 12px; border-radius: 4px; font-size: 14px;">
            <div><strong>‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡¶Ç:</strong> <span id="actionAppNo"></span></div>
            <div><strong>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</strong> <span id="actionCustomerName"></span></div>
        </div>

        <div style="margin-bottom: 12px;">
            <span class="info-label">‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£‡¶É</span>
            <textarea id="actionTakenDetails" placeholder="‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
        </div>

        <div class="action-buttons">
            <button class="btn mobile-full-width" style="background-color: #28a745; margin-bottom: 8px;" onclick="saveActionTaken()">üíæ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn mobile-full-width" style="background-color: #6c757d;" onclick="backToApplication()">‚Üê ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
</div> <!-- This closes the application-container div -->

<script>
// ==================== USER MANAGEMENT AND ROLES ====================
const USER_ROLES = {
    UDA: { name: 'UDA', canCreate: true, dashboard: ['‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶§‡ßà‡¶∞‡¶ø'] },
    XEN: { name: 'XEN', dashboard: ['‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®', 'AE/SDE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡ßÅ‡¶®'] },
    AE: { name: 'AE/SDE', dashboard: ['‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®', 'SAE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡ßÅ‡¶®', 'SAE ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü Verify ‡¶ï‡¶∞‡ßÅ‡¶®'] },
    SAE: { name: 'SAE', dashboard: ['‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®', '‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®'] }
};

const WORKFLOW_STATUS = {
    CREATED: 'created',
    ASSIGNED_TO_AE: 'assigned_to_ae',
    ASSIGNED_TO_SAE: 'assigned_to_sae',
    FIELD_SURVEY_COMPLETED: 'field_survey_completed',
    VERIFIED_BY_AE: 'verified_by_ae',
    APPROVED_BY_XEN: 'approved_by_xen',
    REJECTED: 'rejected',
    ACTION_TAKEN: 'action_taken',
    COMPLETED: 'completed'
};

// Mock user database
const USERS_DB = {
    'uda': { password: 'pass', role: 'UDA', name: 'UDA', division: 'S&D Sunamganj' },
    'xen': { password: 'pass', role: 'XEN', name: 'XEN', division: 'S&D Sunamganj' },
    'ae1': { password: 'pass', role: 'AE', name: 'AE1', division: 'S&D Sunamganj' },
    'ae2': { password: 'pass', role: 'AE', name: 'AE2', division: 'S&D Sunamganj' },
    'sae1': { password: 'pass', role: 'SAE', name: 'SAE1', division: 'S&D Sunamganj' },
    'sae2': { password: 'pass', role: 'SAE', name: 'SAE2', division: 'S&D Sunamganj' },
    'sae3': { password: 'pass', role: 'SAE', name: 'SAE3', division: 'S&D Sunamganj' }
};

// Global variables
let currentUser = null;
let selectedType = 'prepaid';
let currentCustomerType = 'prepaid';
let currentInputNumber = '';
let applicationData = {};
let isEditMode = false;

// ==================== FIREBASE INTEGRATION FUNCTIONS ====================

// Save application to Firebase
function saveToFirebase() {
    try {
        console.log("Saving to Firebase...");

        if (window.AndroidInterface && AndroidInterface.saveApplication) {
            // Prepare complete application data
            const appJson = {
                application_no: applicationData.application_no,
                customer_name: applicationData.customer_name || '',
                father_name: applicationData.father_name || '',
                address: applicationData.address || '',
                mobile_no: applicationData.mobile_no || '',
                nid: applicationData.nid || '',
                meter_no: applicationData.meter_no || '',
                consumer_no: applicationData.consumer_no || '',
                arrear: applicationData.arrear || '0',
                feeder: applicationData.feeder || '',
                status: applicationData.status || WORKFLOW_STATUS.CREATED,
                complaints: getSelectedComplaints(),
                recharges: applicationData.recharges || [],
                workflowHistory: applicationData.workflowHistory || [],
                createdBy: currentUser ? currentUser.name : 'Unknown',
                createdAt: applicationData.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Call Android interface to save to Firebase
            AndroidInterface.saveApplication(JSON.stringify(appJson), '');

            console.log("Application saved via Firebase");
            showToast("‡¶Ü‡¶¨‡ßá‡¶¶‡¶® Firebase-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
            return true;
        } else {
            console.log("AndroidInterface not available");
            // Fallback to localStorage
            saveApplicationToStorage();
            showToast("‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßã‡¶°: ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
            return false;
        }
    } catch (error) {
        console.error("Firebase save error:", error);
        showToast("‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message);
        return false;
    }
}

// Load all applications from Firebase
function loadAllApplicationsFromFirebase() {
    if (window.AndroidInterface && AndroidInterface.loadApplications) {
        AndroidInterface.loadApplications();
        showToast("Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
        return true;
    } else {
        showToast("Firebase ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á");
        return false;
    }
}

// Callback function for Android to send loaded applications
window.handleLoadedApplications = function(applications) {
    try {
        console.log("Received applications from Firebase:", applications);

        // Store in localStorage for quick access
        if (applications && applications.length > 0) {
            localStorage.setItem('allApplications', JSON.stringify(applications));
            updateDashboardWithApplications(applications);
            showToast(`${applications.length} ‡¶ü‡¶ø ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`);
        } else {
            showToast("‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø");
        }
    } catch (error) {
        console.error("Error processing loaded applications:", error);
        showToast("‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ");
    }
};

// Update dashboard with loaded applications
function updateDashboardWithApplications(apps) {
    const actionGrid = document.getElementById('actionGrid');
    if (!actionGrid) return;

    // Filter applications for current user
    const userApps = apps.filter(app =>
        canUserWorkOnApp(currentUser.role, app.status)
    );

    // Update dashboard with these applications
    populateDashboardWithApps(userApps);
}

// Add workflow step to Firebase
function addWorkflowStepToFirebase(stepDescription) {
    if (!applicationData.application_no) return false;

    if (window.AndroidInterface && AndroidInterface.addWorkflowStep) {
        AndroidInterface.addWorkflowStep(
            applicationData.application_no,
            stepDescription,
            currentUser ? currentUser.name : 'Unknown'
        );
        return true;
    }
    return false;
}

// Get selected complaints for Firebase
function getSelectedComplaints() {
    const complaints = [];
    for (let i = 1; i <= 15; i++) {
        const checkbox = document.getElementById(`complaint${i}`);
        if (checkbox && checkbox.checked) {
            const label = document.querySelector(`label[for="complaint${i}"]`);
            let complaintText = label ? label.textContent.trim() : `Complaint ${i}`;

            if (i === 15) {
                const otherInput = document.getElementById('otherComplaintInput');
                if (otherInput && otherInput.value) {
                    complaintText = `‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø: ${otherInput.value}`;
                }
            }

            complaints.push(complaintText);
        }
    }
    return complaints;
}

// Excel export function
function exportToExcel() {
    const allApplications = JSON.parse(localStorage.getItem('allApplications')) || [];
    if (allApplications.length === 0) {
        alert("‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶§ ‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡ßá‡¶á");
        return;
    }

    if (window.AndroidInterface && AndroidInterface.exportToExcel) {
        AndroidInterface.exportToExcel(JSON.stringify(allApplications));
        showToast("‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
    } else {
        alert("‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡¶Ø‡¶º");
    }
}

// ==================== APPLICATION DATA PERSISTENCE ====================
function saveApplicationToStorage() {
    if (!applicationData.application_no) return;

    let allApplications = JSON.parse(localStorage.getItem('allApplications')) || [];
    const existingIndex = allApplications.findIndex(app => app.application_no === applicationData.application_no);

    if (existingIndex !== -1) {
        allApplications[existingIndex] = applicationData;
    } else {
        allApplications.push(applicationData);
    }

    localStorage.setItem('allApplications', JSON.stringify(allApplications));

    // Now save to Firebase
    saveToFirebase();
}

function loadApplicationFromStorage(appNo) {
    const allApplications = JSON.parse(localStorage.getItem('allApplications')) || [];
    const app = allApplications.find(app => app.application_no === appNo);
    return app || null;
}

function canUserWorkOnApp(userRole, appStatus) {
    switch(userRole) {
        case 'UDA':
            return appStatus === WORKFLOW_STATUS.CREATED;
        case 'XEN':
            return appStatus === WORKFLOW_STATUS.CREATED || appStatus === WORKFLOW_STATUS.VERIFIED_BY_AE || appStatus === WORKFLOW_STATUS.APPROVED_BY_XEN;
        case 'AE':
            return appStatus === WORKFLOW_STATUS.ASSIGNED_TO_AE || appStatus === WORKFLOW_STATUS.FIELD_SURVEY_COMPLETED || appStatus === WORKFLOW_STATUS.VERIFIED_BY_AE || appStatus === WORKFLOW_STATUS.APPROVED_BY_XEN;
        case 'SAE':
            return appStatus === WORKFLOW_STATUS.ASSIGNED_TO_SAE || appStatus === WORKFLOW_STATUS.APPROVED_BY_XEN;
        default:
            return false;
    }
}

// ==================== LOGIN SYSTEM ====================
function login() {
    const userId = document.getElementById('userId').value.trim();
    const password = document.getElementById('password').value.trim();
    const errorDiv = document.getElementById('loginError');

    if (!userId || !password) {
        if (errorDiv) { errorDiv.textContent = '‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®'; errorDiv.style.display = 'block'; }
        return;
    }

    const user = USERS_DB[userId];
    if (user && user.password === password) {
        currentUser = { ...user, id: userId };
        showDashboard();
        // Load applications when user logs in
        setTimeout(() => loadAllApplicationsFromFirebase(), 5000);
    } else {
        if (errorDiv) { errorDiv.textContent = '‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°'; errorDiv.style.display = 'block'; }
    }
}

function logout() {
    currentUser = null;
    const uidEl = document.getElementById('userId');
    const passEl = document.getElementById('password');
    if (uidEl) uidEl.value = '';
    if (passEl) passEl.value = '';
    const err = document.getElementById('loginError');
    if (err) err.style.display = 'none';
    showLogin();
}

function showLogin() {
    hideAllSections();
    document.getElementById('loginSection').classList.remove('hidden');
}

// ==================== DASHBOARD MANAGEMENT ====================
function showDashboard() {
    hideAllSections();
    document.getElementById('dashboardSection').classList.remove('hidden');

    const userDisplayName = document.getElementById('userDisplayName');
    if (userDisplayName) userDisplayName.textContent = `${currentUser.name} (${USER_ROLES[currentUser.role].name})`;

    const dashboardTitle = document.getElementById('dashboardTitle');
    if (dashboardTitle) dashboardTitle.textContent = `${USER_ROLES[currentUser.role].name} ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°`;

    populateDashboard();
}

function populateDashboard() {
    const actionGrid = document.getElementById('actionGrid');
    if (!actionGrid) return;
    actionGrid.innerHTML = '';

    // Show "‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶§‡ßà‡¶∞‡¶ø" for UDA
    if (currentUser.role === 'UDA') {
        const card = document.createElement('div');
        card.className = 'action-card';
        card.onclick = () => {
            showApplicationContainer();
            showSearchSection();
        };
        card.innerHTML = `<h3>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶§‡ßà‡¶∞‡¶ø</h3><p>‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá</p>`;
        actionGrid.appendChild(card);
    }

    // Load applications this user can work on
    const allApplications = JSON.parse(localStorage.getItem('allApplications')) || [];
    const userApplications = allApplications.filter(app => {
        if (!canUserWorkOnApp(currentUser.role, app.status)) return false;

        // For AE: if the app is assigned to AE, only show if assignedTo matches currentUser.id
        if (currentUser.role === 'AE' && app.status === WORKFLOW_STATUS.ASSIGNED_TO_AE) {
            return !app.assignedTo || app.assignedTo === currentUser.id;
        }

        // For SAE: only show assigned SAE tasks when assignedTo matches currentUser.id
        if (currentUser.role === 'SAE' && app.status === WORKFLOW_STATUS.ASSIGNED_TO_SAE) {
            return !app.assignedTo || app.assignedTo === currentUser.id;
        }

        return true;
    });

    userApplications.forEach(app => {
        const card = document.createElement('div');
        card.className = 'action-card';
        card.onclick = () => openApplication(app.application_no);

        card.innerHTML = `
            <h3>${app.application_no}</h3>
            <p>${getStatusText(app.status)}</p>
            <p><small>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï: ${app.customer_name || 'N/A'}</small></p>
            <span class="status-badge ${getStatusClass(app.status)}">${getStatusText(app.status)}</span>
        `;

        actionGrid.appendChild(card);
    });

    // If no applications, show message
    if (userApplications.length === 0 && currentUser.role !== 'UDA') {
        const messageCard = document.createElement('div');
        messageCard.className = 'action-card';
        messageCard.innerHTML = `<h3>‡¶ï‡ßã‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶®‡ßá‡¶á</h3><p>Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</p>`;
        actionGrid.appendChild(messageCard);
    }
}

function openApplication(appNo) {
    const appData = loadApplicationFromStorage(appNo);
    if (appData) {
        applicationData = appData;
        fillFormWithData(applicationData);
        showFormSection();
    } else {
        alert('‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø');
    }
}

// ==================== APPLICATION MANAGEMENT ====================
function showApplicationContainer() {
    hideAllSections();
    document.getElementById('applicationContainer').classList.remove('hidden');
}

function showSearchSection(){
    hideAllSections();
    document.getElementById("applicationContainer").classList.remove('hidden');
    document.getElementById("searchSection").classList.remove('hidden');

    const si = document.getElementById("searchInput");
    if (si) si.value = '';
    const feeder = document.getElementById("feederSelect");
    if (feeder) feeder.value = '';
    const nid = document.getElementById("nidInput");
    if (nid) nid.value = '';
    const mob = document.getElementById("mobileInput");
    if (mob) mob.value = '';
    const gen = document.getElementById("generatedAppNo");
    if (gen) gen.textContent = '‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
    currentInputNumber = '';

    // Reset application data for new search
    applicationData = {};
}

// ==================== SIMPLE FIXED VERSION ====================
async function getNextApplicationNumber(feeder) {
    console.log("Getting next number for feeder:", feeder);

    return new Promise((resolve, reject) => {
        if (!window.AndroidInterface || !AndroidInterface.getNextApplicationNumber) {
            reject(new Error("Android interface not available"));
            return;
        }

        console.log("Calling Android/Firebase...");

        AndroidInterface.getNextApplicationNumber(feeder);

        window.handleNextAppNumber = function(nextNumber) {
            console.log("Got response:", nextNumber);

            // Validate it's correct format
            if (nextNumber && nextNumber.startsWith(feeder + '-')) {
                console.log("Valid number:", nextNumber);
                resolve(nextNumber);
            } else {
                console.error("Invalid response:", nextNumber);
                reject(new Error("Got wrong number: " + nextNumber));
            }
        };

        // Timeout after 5 seconds
        setTimeout(() => {
            reject(new Error("Timeout from Firebase"));
        }, 5000);
    });
}

// ==================== SIMPLE GENERATE APPLICATION ====================
async function generateApplication() {
    const feederEl = document.getElementById("feederSelect");
    const nidEl = document.getElementById("nidInput");
    const mobileEl = document.getElementById("mobileInput");
    const feeder = feederEl ? feederEl.value : '';
    const nid = nidEl ? nidEl.value.trim() : '';
    const mobileNo = mobileEl ? mobileEl.value.trim() : '';

    if (!feeder) {
        alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
    }

    if (!nid) {
        alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶®‡¶Ü‡¶á‡¶°‡¶ø ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
        return;
    }

    try {
        // Show loading
        const gen = document.getElementById("generatedAppNo");
        if (gen) gen.textContent = "Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

        // Get next application number
        const appNo = await getNextApplicationNumber(feeder);

        if (gen) gen.textContent = appNo;

        // Build application data
        applicationData = {
            ...applicationData,
            mobile_no: mobileNo || applicationData.mobile_no,
            feeder: feeder,
            nid: nid,
            application_no: appNo,
            status: WORKFLOW_STATUS.CREATED,
            createdBy: currentUser ? currentUser.name : 'Unknown',
            createdAt: new Date().toISOString(),
            complaints: getSelectedComplaints(),
            workflowHistory: [{
                step: '‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá',
                by: currentUser ? currentUser.name : 'Unknown',
                date: new Date().toLocaleString(),
                status: 'created'
            }]
        };

        // Save to Firebase
        saveApplicationToStorage();
        showToast("‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶® Firebase-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");

        fillFormWithData(applicationData);
        showFormSection();

    } catch (error) {
        console.error("Error:", error);
        alert("Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßá‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + error.message);

        const gen = document.getElementById("generatedAppNo");
        if (gen) gen.textContent = "‡¶´‡¶ø‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®";
    }
}
// ==================== WORKFLOW MANAGEMENT ====================
function updateWorkflowActions() {
    const workflowButtons = document.getElementById('workflowButtons');
    if (!workflowButtons) return;
    workflowButtons.innerHTML = '';

    if (!currentUser) return;

    const actions = getWorkflowActionsForUser();
    actions.forEach(action => {
        const btn = document.createElement('button');
        btn.className = 'btn mobile-full-width';
        btn.style.backgroundColor = getActionColor(action);
        btn.style.marginBottom = '8px';
        btn.textContent = action;
        btn.onclick = () => handleWorkflowAction(action);
        workflowButtons.appendChild(btn);
    });

    // Update workflow history
    updateWorkflowHistory();
}

function getWorkflowActionsForUser() {
    const role = currentUser.role;
    const status = applicationData.status || WORKFLOW_STATUS.CREATED;

    switch(role) {
        case 'UDA':
            if (status === WORKFLOW_STATUS.CREATED) return ['üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü', 'üìÑ PDF ‡¶∏‡ßá‡¶≠'];
            return ['üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü', 'üìÑ PDF ‡¶∏‡ßá‡¶≠', '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®'];
        case 'XEN':
            if (status === WORKFLOW_STATUS.CREATED) return ['AE/SDE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡ßÅ‡¶®'];
            if (status === WORKFLOW_STATUS.VERIFIED_BY_AE) return ['‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', '‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'];
            if (status === WORKFLOW_STATUS.APPROVED_BY_XEN) return ['‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™'];
            return ['‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®'];
        case 'AE':
            if (status === WORKFLOW_STATUS.ASSIGNED_TO_AE) return ['SAE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡ßÅ‡¶®'];
            if (status === WORKFLOW_STATUS.FIELD_SURVEY_COMPLETED) return ['Verify ‡¶ï‡¶∞‡ßÅ‡¶®', '‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'];
            if (status === WORKFLOW_STATUS.APPROVED_BY_XEN) return ['‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™'];
            return ['‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®'];
        case 'SAE':
            if (status === WORKFLOW_STATUS.ASSIGNED_TO_SAE) return ['‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®'];
            if (status === WORKFLOW_STATUS.APPROVED_BY_XEN) return ['‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™'];
            return ['‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®'];
        default:
            return [];
    }
}

function getActionColor(action) {
    const colors = {
        '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®': '#28a745',
        'Verify ‡¶ï‡¶∞‡ßÅ‡¶®': '#17a2b8',
        '‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®': '#dc3545',
        'AE/SDE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡ßÅ‡¶®': '#007bff',
        'SAE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡ßÅ‡¶®': '#007bff',
        '‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®': '#ffc107',
        '‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™': '#6c757d'
    };
    return colors[action] || '#6c757d';
}

function handleWorkflowAction(action) {
    switch(action) {
        case 'AE/SDE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡ßÅ‡¶®':
            showAssignmentSection('AE');
            break;
        case 'SAE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡ßÅ‡¶®':
            showAssignmentSection('SAE');
            break;
        case '‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®':
            showSAESection();
            break;
        case 'Verify ‡¶ï‡¶∞‡ßÅ‡¶®':
            verifyFieldSurvey();
            break;
        case '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®':
            showFinalApprovalSection();
            break;
        case '‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®':
            rejectApplication();
            break;
        case '‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™':
            showActionTakenSection();
            break;
    }
}

function showAssignmentSection(assignToRole) {
    hideAllSections();
    document.getElementById("applicationContainer").classList.remove('hidden');
    document.getElementById("assignmentSection").classList.remove('hidden');

    const assignAppNo = document.getElementById("assignAppNo");
    if (assignAppNo) assignAppNo.textContent = applicationData.application_no || '_________ (N/A)';
    const assignCustomerName = document.getElementById("assignCustomerName");
    if (assignCustomerName) assignCustomerName.textContent = applicationData.customer_name || 'N/A';
    const assignCurrentStatus = document.getElementById("assignCurrentStatus");
    if (assignCurrentStatus) assignCurrentStatus.textContent = getStatusText(applicationData.status);

    // Populate assignee dropdown based on role
    const assigneeSelect = document.getElementById("assigneeSelect");
    if (assigneeSelect) {
        assigneeSelect.innerHTML = '<option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';

        const users = Object.keys(USERS_DB).filter(id => USERS_DB[id].role === assignToRole);
        users.forEach(userId => {
            const user = USERS_DB[userId];
            const option = document.createElement('option');
            option.value = userId;
            option.textContent = `${user.name} (${userId})`;
            assigneeSelect.appendChild(option);
        });
    }
}

function saveAssignment() {
    const assigneeSelect = document.getElementById("assigneeSelect");
    const assigneeId = assigneeSelect ? assigneeSelect.value : '';

    if (!assigneeId) {
        alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
        return;
    }

    const assignee = USERS_DB[assigneeId];
    const assignToRole = assignee.role;

    let newStatus;
    if (assignToRole === 'AE') {
        newStatus = WORKFLOW_STATUS.ASSIGNED_TO_AE;
    } else if (assignToRole === 'SAE') {
        newStatus = WORKFLOW_STATUS.ASSIGNED_TO_SAE;
    }

    applicationData.status = newStatus;
    applicationData.assignedTo = assigneeId;
    applicationData.assignedBy = currentUser.name;
    applicationData.assignedAt = new Date().toLocaleString();

    // Add to workflow history
    if (!applicationData.workflowHistory) {
        applicationData.workflowHistory = [];
    }
    applicationData.workflowHistory.push({
        step: `${assignToRole} ‡¶§‡ßá Assign ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`,
        by: currentUser.name,
        to: assignee.name,
        date: new Date().toLocaleString(),
        status: 'assigned'
    });

    // Save to Firebase
    saveApplicationToStorage();
    if (addWorkflowStepToFirebase(`${assignToRole} ‡¶§‡ßá Assign ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`)) {
        showToast("‚úÖ Assign Firebase-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
    }

    updateApplicationStatus(`${assignToRole} ‡¶§‡ßá Assign ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`, 'status-assigned');
    alert(`${assignee.name} ‡¶ï‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá Assign ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
    backToApplication();
}

function verifyFieldSurvey() {
    applicationData.status = WORKFLOW_STATUS.VERIFIED_BY_AE;
    applicationData.verifiedBy = currentUser.name;
    applicationData.verifiedAt = new Date().toLocaleString();

    if (!applicationData.workflowHistory) {
        applicationData.workflowHistory = [];
    }
    applicationData.workflowHistory.push({
        step: '‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá Verify ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá',
        by: currentUser.name,
        date: new Date().toLocaleString(),
        status: 'verified'
    });

    saveApplicationToStorage();
    if (addWorkflowStepToFirebase('‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá Verify ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá')) {
        showToast("‚úÖ Verify Firebase-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
    }

    updateApplicationStatus('Verify ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá', 'status-verified');
    updateActionTakenInForm();
    alert('‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá Verify ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    backToApplication();
}

function rejectApplication() {
    applicationData.status = WORKFLOW_STATUS.REJECTED;
    applicationData.rejectedBy = currentUser.name;
    applicationData.rejectedAt = new Date().toLocaleString();

    if (!applicationData.workflowHistory) {
        applicationData.workflowHistory = [];
    }
    applicationData.workflowHistory.push({
        step: '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá',
        by: currentUser.name,
        date: new Date().toLocaleString(),
        status: 'rejected'
    });

    saveApplicationToStorage();
    if (addWorkflowStepToFirebase('‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá')) {
        showToast("‚úÖ ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® Firebase-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
    }

    updateApplicationStatus('‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá', 'status-rejected');
    alert('‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    backToApplication();
}

function updateApplicationStatus(statusText, statusClass) {
    const badge = document.getElementById('applicationStatusBadge');
    if (badge) {
        badge.textContent = statusText;
        badge.className = `status-badge ${statusClass}`;
    }
    applicationData.statusText = statusText;
    applicationData.statusClass = statusClass;
}

// ==================== ENHANCED WORKFLOW HISTORY DISPLAY ====================
function updateWorkflowHistory() {
    const workflowSteps = document.getElementById('workflowSteps');
    if (!workflowSteps) return;

    workflowSteps.innerHTML = '';

    if (!applicationData.workflowHistory || applicationData.workflowHistory.length === 0) {
        workflowSteps.innerHTML = '<div class="workflow-step">‡¶ï‡ßã‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á</div>';
        return;
    }

    applicationData.workflowHistory.forEach(step => {
        const stepDiv = document.createElement('div');
        stepDiv.className = `workflow-step ${step.status || ''}`;

        let stepHtml = `<strong>${step.step}</strong><br>`;
        stepHtml += `<small>‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶ï: ${step.by}</small><br>`;
        stepHtml += `<small>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${step.date}</small>`;

        // Show details if available
        if (step.details) {
            stepHtml += `<div style="margin-top: 5px; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                        <strong>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</strong> ${step.details}
                        </div>`;
        }

        // ===== ENHANCEMENT: Show BILL REASONS if available =====
        if (step.billReasons && step.billReasons.length > 0) {
            stepHtml += `<div style="margin-top: 5px; padding: 5px; background: #e6ffe6; border-radius: 4px; border-left: 3px solid #28a745;">
                        <strong>üí∞ ‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡¶æ‡¶¨‡¶ø‡¶§:</strong><br>`;

            // Get bill reason descriptions
            step.billReasons.forEach(code => {
                const reason = BILL_REASONS.find(r => r.code === code);
                if (reason) {
                    stepHtml += `<div style="margin: 3px 0; padding-left: 10px;">
                                <span style="font-weight: bold;">${code}:</span> ${reason.desc}
                                </div>`;
                }
            });

            // Show custom reason if available
            if (step.customBillReason) {
                stepHtml += `<div style="margin: 3px 0; padding-left: 10px;">
                            <span style="font-weight: bold;">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø:</span> ${step.customBillReason}
                            </div>`;
            }

            stepHtml += `</div>`;
        }

        // ===== ENHANCEMENT: Show FREE SERVICE info if available =====
        if (step.freeService === true) {
            let freeReasonText = '';
            switch(step.freeReason) {
                case 'battery_change':
                    freeReasonText = '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®';
                    break;
                case 'eeprom_error':
                    freeReasonText = 'EEPROM ‡¶è‡¶∞‡¶∞/‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø';
                    break;
                case 'technical_reason':
                    freeReasonText = '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ï‡¶æ‡¶∞‡¶£';
                    break;
                default:
                    freeReasonText = step.freeReason || '‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶¨‡¶æ';
            }

            stepHtml += `<div style="margin-top: 5px; padding: 5px; background: #fff3cd; border-radius: 4px; border-left: 3px solid #ffc107;">
                        <strong>üéÅ ‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶¨‡¶æ:</strong> ${freeReasonText}
                        </div>`;
        }

        // Show other step info
        if (step.to) {
            stepHtml += `<br><small>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï: ${step.to}</small>`;
        }

        stepDiv.innerHTML = stepHtml;
        workflowSteps.appendChild(stepDiv);
    });
}

// ==================== BILL REASONS DATA ====================
const BILL_REASONS = [
    { code: "23", desc: "Load Changes Application Fee (Per Meter)" },
    { code: "38", desc: "New Connection Application Fee" },
    { code: "13", desc: "Temporary Connection fee" },
    { code: "40", desc: "Estimated Cost" },
    { code: "34", desc: "Disconnection Charge (DC) For Due Bill" },
    { code: "35", desc: "Reconnection Charge (RC) For Due Bill" },
    { code: "36", desc: "Disconnection Charge (DC) For On Request" },
    { code: "37", desc: "Reconnection Charge (RC) For On Request" },
    { code: "16", desc: "Meter inspection charge for on request" },
    { code: "17", desc: "Meter inspection charge at consumer yard" },
    { code: "27", desc: "Meter / Metering Unit Installation / Change / Relocation Fee On Request" },
    { code: "33", desc: "Service Drop Cable/ Repair/ Change/Transfer On Request" },
    { code: "21", desc: "Fee For Amending The supply Agreement at The Customer's Request" },
    { code: "24", desc: "PrePaid Meter Card Re Issue Fee" },
    { code: "18", desc: "Transformer rental charge" },
    { code: "39", desc: "Revenue loss bill" },
    { code: "22", desc: "Meter Change Inspection On Request" },
    { code: "09", desc: "Others" },
    { code: "15", desc: "Disconnection charge (DC)  Reconnection charge (RC) for on request" },
    { code: "14", desc: "Disconnection charge (DC)  Reconnection charge (RC) for due bill" }
];

// Function to populate bill reasons
function populateBillReasons() {
    const container = document.getElementById('billReasonCheckboxes');
    if (!container) return;

    container.innerHTML = '';

    BILL_REASONS.forEach((reason, index) => {
        const checkboxId = `billReason_${index}`;
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.className = 'complaint-checkbox';
        checkbox.value = reason.code;

        const label = document.createElement('label');
        label.htmlFor = checkboxId;
        label.className = 'complaint-label';
        label.textContent = `${reason.code}: ${reason.desc}`;

        const item = document.createElement('div');
        item.className = 'complaint-item';
        item.appendChild(checkbox);
        item.appendChild(label);

        // Show custom input for "Others"
        if (reason.code === "09") {
            checkbox.addEventListener('change', function() {
                document.getElementById('customBillReasonContainer').style.display =
                    this.checked ? 'block' : 'none';
            });
        }

        container.appendChild(item);
    });
}

// ==================== ENHANCED SAE SECTION ====================


// ==================== ENHANCED SAE REPORT SAVING ====================
function saveSaeReport() {
    const report = document.getElementById("saeReport").value.trim();
    const action = document.querySelector('input[name="saeAction"]:checked');

    if (!report) {
        alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®');
        return;
    }

    if (!action) {
        alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
        return;
    }

    // Collect selected bill reasons
    const selectedBillReasons = [];
    const selectedBillDescriptions = [];

    document.querySelectorAll('#billReasonCheckboxes input[type="checkbox"]:checked').forEach(cb => {
        selectedBillReasons.push(cb.value);

        // Get description for each code
        const reason = BILL_REASONS.find(r => r.code === cb.value);
        if (reason) {
            selectedBillDescriptions.push(`${reason.code}: ${reason.desc}`);
        }
    });

    const customBillReason = document.getElementById('customBillReason').value.trim();

    // Free of cost options
    const freeOfCost = document.getElementById('freeOfCost').checked;
    let freeReason = document.querySelector('input[name="freeReason"]:checked')?.value || '';

    // Convert free reason code to readable text
    let freeReasonText = '';
    if (freeOfCost) {
        switch(freeReason) {
            case 'battery_change':
                freeReasonText = '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®';
                break;
            case 'eeprom_error':
                freeReasonText = 'EEPROM ‡¶è‡¶∞‡¶∞/‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø';
                break;
            case 'technical_reason':
                freeReasonText = '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ï‡¶æ‡¶∞‡¶£';
                break;
            default:
                freeReasonText = '‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶¨‡¶æ';
        }
    }

    if (action.value === 'reject') {
        const rejectReason = document.getElementById("saeRejectText").value.trim();
        if (!rejectReason) {
            alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®');
            return;
        }
        applicationData.saeRejectReason = rejectReason;
        applicationData.status = WORKFLOW_STATUS.REJECTED;
    } else {
        applicationData.saeReport = report;
        applicationData.selectedBillReasons = selectedBillReasons.length > 0 ? selectedBillReasons : null;
        applicationData.selectedBillDescriptions = selectedBillDescriptions; // Store descriptions too
        applicationData.customBillReason = customBillReason || null;
        applicationData.freeOfCost = freeOfCost || false;
        applicationData.freeReason = freeReason || null;
        applicationData.freeReasonText = freeReasonText; // Store readable text
        applicationData.status = WORKFLOW_STATUS.FIELD_SURVEY_COMPLETED;
    }

    // Add to workflow history
    if (!applicationData.workflowHistory) {
        applicationData.workflowHistory = [];
    }

    let workflowStep = action.value === 'verify' ? '‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá' : '‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®';

    // ENHANCED: Create detailed workflow entry
    const workflowEntry = {
        step: workflowStep,
        by: currentUser.name,
        date: new Date().toLocaleString(),
        details: report.substring(0, 200) + (report.length > 200 ? '...' : ''),
        status: action.value === 'verify' ? 'completed' : 'rejected'
    };

    // Add bill reasons info
    if (selectedBillReasons.length > 0) {
        workflowEntry.billReasons = selectedBillReasons;
        workflowEntry.billDescriptions = selectedBillDescriptions;
        workflowStep += ` (‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡¶æ‡¶¨‡¶ø‡¶§: ${selectedBillReasons.length} ‡¶ü‡¶ø)`;
    }

    // Add free service info
    if (freeOfCost) {
        workflowEntry.freeService = true;
        workflowEntry.freeReason = freeReason;
        workflowEntry.freeReasonText = freeReasonText;
        workflowStep += ' | ‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶¨‡¶æ';
    }

    workflowEntry.step = workflowStep;
    applicationData.workflowHistory.push(workflowEntry);

    saveApplicationToStorage();
    if (addWorkflowStepToFirebase(workflowStep)) {
        showToast("‚úÖ SAE ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü Firebase-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
    }

    updateApplicationStatus(
        action.value === 'verify' ? '‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®' : '‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá',
        action.value === 'verify' ? 'status-verified' : 'status-rejected'
    );

    // Also update the form display with bill info
    updateFormWithBillInfo(selectedBillDescriptions, freeReasonText);

    alert('‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    // Add this line in saveSaeReport() function
updateSaeRecommendationsDisplay();
    backToApplication();
}

// ==================== UPDATE FORM WITH BILL INFO ====================
function updateFormWithBillInfo(billDescriptions, freeReasonText) {
    // Create a section in the form to show bill recommendations
    const formSection = document.getElementById('formSection');

    // Remove existing bill info section if exists
    const existingBillInfo = document.getElementById('billInfoSection');
    if (existingBillInfo) {
        existingBillInfo.remove();
    }

    // Only add if there are bill recommendations or free service
    if ((billDescriptions && billDescriptions.length > 0) || freeReasonText) {
        const billInfoSection = document.createElement('div');
        billInfoSection.id = 'billInfoSection';
        billInfoSection.style.margin = '15px 0';
        billInfoSection.style.padding = '12px';
        billInfoSection.style.background = '#f8f9fa';
        billInfoSection.style.borderRadius = '6px';
        billInfoSection.style.borderLeft = '4px solid #28a745';

        let html = '<div style="font-weight: bold; margin-bottom: 8px; color: #28a745;">üí∞ SAE ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶ø‡¶∂:</div>';

        // Add bill recommendations
        if (billDescriptions && billDescriptions.length > 0) {
            html += '<div style="margin-bottom: 10px;">';
            html += '<div style="font-weight: bold; margin-bottom: 5px;">‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡¶æ‡¶¨‡¶ø‡¶§:</div>';
            billDescriptions.forEach(desc => {
                html += `<div style="margin: 3px 0; padding-left: 10px; font-size: 13px;">‚Ä¢ ${desc}</div>`;
            });

            // Add custom reason if exists
            if (applicationData.customBillReason) {
                html += `<div style="margin: 3px 0; padding-left: 10px; font-size: 13px; color: #666;">
                        <strong>‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡¶æ‡¶∞‡¶£:</strong> ${applicationData.customBillReason}
                        </div>`;
            }
            html += '</div>';
        }

        // Add free service info
        if (freeReasonText) {
            html += `<div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 4px;">
                    <div style="font-weight: bold; color: #856404;">üéÅ ‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶¨‡¶æ:</div>
                    <div style="font-size: 13px;">${freeReasonText}</div>
                    </div>`;
        }

        billInfoSection.innerHTML = html;

        // Insert after the workflow actions section
        const workflowActions = document.getElementById('workflowActions');
        if (workflowActions) {
            workflowActions.parentNode.insertBefore(billInfoSection, workflowActions.nextSibling);
        }
    }
}
function showFinalApprovalSection(){
    hideAllSections();
    document.getElementById("applicationContainer").classList.remove('hidden');
    document.getElementById("finalApprovalSection").classList.remove('hidden');

    const finalAppNo = document.getElementById("finalAppNo");
    if (finalAppNo) finalAppNo.textContent = applicationData.application_no || '_________ (N/A)';

    const finalCustomerName = document.getElementById("finalCustomerName");
    if (finalCustomerName) finalCustomerName.textContent = applicationData.customer_name || '_________ (N/A)';

    const finalReport = document.getElementById("finalReport");
    if (finalReport) {
        let reportText = applicationData.saeReport || document.getElementById("saeReport")?.value || 'No Report';

        // ENHANCED: Add bill recommendations to the report display
        if (applicationData.selectedBillDescriptions && applicationData.selectedBillDescriptions.length > 0) {
            reportText += '\n\nüí∞ ‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡¶æ‡¶¨‡¶ø‡¶§:\n';
            applicationData.selectedBillDescriptions.forEach(desc => {
                reportText += `‚Ä¢ ${desc}\n`;
            });

            if (applicationData.customBillReason) {
                reportText += `\n‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡¶æ‡¶∞‡¶£: ${applicationData.customBillReason}\n`;
            }
        }

        // Add free service info
        if (applicationData.freeOfCost && applicationData.freeReasonText) {
            reportText += `\nüéÅ ‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶¨‡¶æ: ${applicationData.freeReasonText}\n`;
        }

        finalReport.textContent = reportText;
        finalReport.style.whiteSpace = 'pre-line'; // Preserve line breaks
    }
}
function saveFinalApproval() {
    const action = document.querySelector('input[name="finalAction"]:checked');

    if (!action) {
        alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
        return;
    }

    if (action.value === 'reject') {
        const rejectReason = document.getElementById("finalRejectText").value.trim();
        if (!rejectReason) {
            alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®');
            return;
        }
        applicationData.finalRejectReason = rejectReason;
        applicationData.status = WORKFLOW_STATUS.REJECTED;
        applicationData.rejectedBy = currentUser.name;
        applicationData.rejectedAt = new Date().toLocaleString();
    } else {
        applicationData.status = WORKFLOW_STATUS.APPROVED_BY_XEN;
        applicationData.approvedBy = currentUser.name;
        applicationData.approvedAt = new Date().toLocaleString();
    }

    // Add to workflow history
    if (!applicationData.workflowHistory) {
        applicationData.workflowHistory = [];
    }

    const workflowStep = action.value === 'approve' ? 'XEN ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®' : 'XEN ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®';
    applicationData.workflowHistory.push({
        step: workflowStep,
        by: currentUser.name,
        date: new Date().toLocaleString(),
        details: action.value === 'reject' ? applicationData.finalRejectReason : '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
        status: action.value === 'approve' ? 'approved' : 'rejected'
    });

    saveApplicationToStorage();

    // Add this line to update the status badge immediately
    updateApplicationStatus(
        action.value === 'approve' ? 'XEN ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®' : '‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá',
        action.value === 'approve' ? 'status-approved' : 'status-rejected'
    );

    alert(action.value === 'approve' ? '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá' : '‡¶Ü‡¶¨‡ßá‡¶¶‡¶® ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    backToApplication();
}

// ==================== ACTION TAKEN SECTION ====================
function showActionTakenSection() {
    hideAllSections();
    document.getElementById("applicationContainer").classList.remove('hidden');
    document.getElementById("actionTakenSection").classList.remove('hidden');

    const actionAppNo = document.getElementById("actionAppNo");
    if (actionAppNo) actionAppNo.textContent = applicationData.application_no || '_________ (N/A)';
    const actionCustomerName = document.getElementById("actionCustomerName");
    if (actionCustomerName) actionCustomerName.textContent = applicationData.customer_name || 'N/A';
}

function saveActionTaken() {
    const actionDetails = document.getElementById("actionTakenDetails").value.trim();

    if (!actionDetails) {
        alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®');
        return;
    }

    applicationData.actionTaken = {
        by: currentUser.name,
        date: new Date().toLocaleString(),
        details: actionDetails
    };
    applicationData.status = WORKFLOW_STATUS.ACTION_TAKEN;

    if (!applicationData.workflowHistory) {
        applicationData.workflowHistory = [];
    }
    applicationData.workflowHistory.push({
        step: '‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá',
        by: currentUser.name,
        date: new Date().toLocaleString(),
        details: actionDetails.substring(0, 100) + (actionDetails.length > 100 ? '...' : ''),
        status: 'action_taken'
    });

    saveApplicationToStorage();
    if (addWorkflowStepToFirebase('‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá')) {
        showToast("‚úÖ ‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™ Firebase-‡¶è ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
    }

    updateApplicationStatus('‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™', 'status-action-taken');

    // Update action taken section in form
    updateActionTakenInForm();

    alert('‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    backToApplication();
}

function updateActionTakenInForm() {
    const actionSection = document.getElementById("actionTakenSectionInForm");
    if (actionSection && applicationData.actionTaken) {
        actionSection.classList.remove('hidden');

        const staticActionTakenBy = document.getElementById("staticActionTakenBy");
        if (staticActionTakenBy) staticActionTakenBy.textContent = applicationData.actionTaken.by;

        const staticActionTakenDate = document.getElementById("staticActionTakenDate");
        if (staticActionTakenDate) staticActionTakenDate.textContent = applicationData.actionTaken.date;

        const staticActionTakenDetails = document.getElementById("staticActionTakenDetails");
        if (staticActionTakenDetails) staticActionTakenDetails.textContent = applicationData.actionTaken.details;
    }
}

function toggleSaeRejectReason(show) {
    const el = document.getElementById("saeRejectReason");
    if (el) el.classList.toggle("hidden", !show);
}

function toggleFinalRejectReason(show) {
    const el = document.getElementById("finalRejectReason");
    if (el) el.classList.toggle("hidden", !show);
}

// ==================== UI MANAGEMENT ====================
function hideAllSections() {
    const sections = [
        'loginSection', 'dashboardSection', 'applicationContainer',
        'searchSection', 'formSection', 'dataCollectionSection',
        'saeSection', 'finalApprovalSection', 'actionTakenSection', 'assignmentSection'
    ];
    sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    });
}

function showDataCollectionSection(){
    hideAllSections();
    document.getElementById("applicationContainer").classList.remove('hidden');
    document.getElementById("dataCollectionSection").classList.remove('hidden');
}
// Function to update SAE recommendations display
function updateSaeRecommendationsDisplay() {
    const billInfoSection = document.getElementById('billInfoSection');
    if (!billInfoSection) return;

    // Clear existing content
    billInfoSection.innerHTML = '';

    // Only show if there are SAE recommendations
    if (applicationData.selectedBillDescriptions && applicationData.selectedBillDescriptions.length > 0) {
        let html = '<div style="font-weight: bold; margin-bottom: 10px; color: #28a745; font-size: 16px;">üí∞ SAE ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶ø‡¶∂‡¶∏‡¶Æ‡ßÇ‡¶π</div>';

        // Add bill recommendations
        if (applicationData.selectedBillDescriptions.length > 0) {
            html += '<div style="margin-bottom: 10px;">';
            html += '<div style="font-weight: bold; margin-bottom: 8px; color: #2c3e50;">‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡¶æ‡¶¨‡¶ø‡¶§:</div>';
            applicationData.selectedBillDescriptions.forEach(desc => {
                html += `<div style="margin: 5px 0; padding: 5px 10px; background: #f8fff8; border-radius: 4px; border-left: 3px solid #28a745;">
                        ${desc}
                        </div>`;
            });

            // Add custom reason if exists
            if (applicationData.customBillReason) {
                html += `<div style="margin: 8px 0; padding: 8px; background: #fff3cd; border-radius: 4px;">
                        <strong>‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡¶æ‡¶∞‡¶£:</strong> ${applicationData.customBillReason}
                        </div>`;
            }
            html += '</div>';
        }

        // Add free service info
        if (applicationData.freeOfCost && applicationData.freeReasonText) {
            html += `<div style="margin-top: 12px; padding: 10px; background: #e6ffe6; border-radius: 6px; border: 1px solid #28a745;">
                    <div style="font-weight: bold; color: #155724;">üéÅ ‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶¨‡¶æ:</div>
                    <div style="margin-top: 5px; font-size: 14px;">${applicationData.freeReasonText}</div>
                    </div>`;
        }

        billInfoSection.innerHTML = html;
        billInfoSection.style.display = 'block';
    } else {
        billInfoSection.style.display = 'none';
    }
}

function showFormSection(){
    hideAllSections();
    document.getElementById("applicationContainer").classList.remove('hidden');
    document.getElementById("formSection").classList.remove('hidden');

    const rechargeSection = document.getElementById("rechargeSection");
    if (rechargeSection) rechargeSection.style.display = 'block';

    updateWorkflowActions();

    if (!applicationData.status) {
        applicationData.status = WORKFLOW_STATUS.CREATED;
    }

    updateApplicationStatus(getStatusText(applicationData.status), getStatusClass(applicationData.status));

    // Update action taken section if exists
    updateActionTakenInForm();

    // +++ ADD THIS LINE +++
    updateSaeRecommendationsDisplay(); // Show SAE recommendations if any
}
function showSAESection(){
    hideAllSections();
    document.getElementById("applicationContainer").classList.remove('hidden');
    document.getElementById("saeSection").classList.remove('hidden');

    const saeAppNo = document.getElementById("saeAppNo");
    if (saeAppNo) saeAppNo.textContent = applicationData.application_no || '_________ (N/A)';
    const saeCustomerName = document.getElementById("saeCustomerName");
    if (saeCustomerName) saeCustomerName.textContent = applicationData.customer_name || 'N/A';

    // ENHANCED: Populate bill reasons
    populateBillReasons();

    // Reset free of cost options
    document.getElementById('freeOfCost').checked = false;
    document.querySelectorAll('input[name="freeReason"]').forEach(radio => radio.checked = false);

    // Load existing data if any
    if (applicationData.saeReport) {
        document.getElementById('saeReport').value = applicationData.saeReport;
    }

    if (applicationData.selectedBillReasons) {
        applicationData.selectedBillReasons.forEach(reasonCode => {
            const checkbox = document.querySelector(`input[value="${reasonCode}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }

    if (applicationData.customBillReason) {
        document.getElementById('customBillReason').value = applicationData.customBillReason;
        document.getElementById('customBillReasonContainer').style.display = 'block';
    }

    if (applicationData.freeOfCost) {
        document.getElementById('freeOfCost').checked = true;
        const freeReason = applicationData.freeReason || 'battery_change';
        document.querySelector(`input[name="freeReason"][value="${freeReason}"]`).checked = true;
    }
}
function showFinalApprovalSection(){
    hideAllSections();
    document.getElementById("applicationContainer").classList.remove('hidden');
    document.getElementById("finalApprovalSection").classList.remove('hidden');

    const finalAppNo = document.getElementById("finalAppNo");
    if (finalAppNo) finalAppNo.textContent = applicationData.application_no || '_________ (N/A)';
    const finalCustomerName = document.getElementById("finalCustomerName");
    if (finalCustomerName) finalCustomerName.textContent = applicationData.customer_name || '_________ (N/A)';
    const finalReport = document.getElementById("finalReport");
    if (finalReport) finalReport.textContent = applicationData.saeReport || document.getElementById("saeReport")?.value || 'No Report';
}

function backToApplication(){
    showFormSection();
    updateWorkflowActions(); // Add this line to refresh buttons
}

function backToSae(){
    showSAESection();
}

// ==================== UTILITY FUNCTIONS ====================
function getStatusText(status){
    switch(status){
        case WORKFLOW_STATUS.CREATED: return '‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶¨‡ßá‡¶¶‡¶®';
        case WORKFLOW_STATUS.ASSIGNED_TO_AE: return 'AE/SDE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá';
        case WORKFLOW_STATUS.ASSIGNED_TO_SAE: return 'SAE ‡¶§‡ßá Assign ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá';
        case WORKFLOW_STATUS.FIELD_SURVEY_COMPLETED: return '‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®';
        case WORKFLOW_STATUS.VERIFIED_BY_AE: return 'AE Verify ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®';
        case WORKFLOW_STATUS.APPROVED_BY_XEN: return 'XEN ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®';
        case WORKFLOW_STATUS.REJECTED: return '‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá';
        case WORKFLOW_STATUS.ACTION_TAKEN: return '‡¶ó‡ßÉ‡¶π‡ßÄ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™';
        case WORKFLOW_STATUS.COMPLETED: return '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®';
        default: return '‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ';
    }
}

function getStatusClass(status){
    switch(status){
        case WORKFLOW_STATUS.CREATED: return 'status-pending';
        case WORKFLOW_STATUS.ASSIGNED_TO_AE:
        case WORKFLOW_STATUS.ASSIGNED_TO_SAE:
            return 'status-assigned';
        case WORKFLOW_STATUS.FIELD_SURVEY_COMPLETED:
        case WORKFLOW_STATUS.VERIFIED_BY_AE:
            return 'status-verified';
        case WORKFLOW_STATUS.APPROVED_BY_XEN:
            return 'status-approved';
        case WORKFLOW_STATUS.REJECTED:
            return 'status-rejected';
        case WORKFLOW_STATUS.ACTION_TAKEN:
            return 'status-action-taken';
        case WORKFLOW_STATUS.COMPLETED:
            return 'status-completed';
        default: return 'status-pending';
    }
}

// ==================== EXISTING FORM FUNCTIONS ====================
function setTextSafe(id, val){
    const el=document.getElementById(id);
    if(!el) return;
    el.textContent = (val || '').toString();
}

function setInputSafe(id, val){
    const el=document.getElementById(id);
    if(!el) return;
    el.value = (val || '').toString();
}

function fillFormWithData(data){
    hideLoading();
    if(!data){ showError("‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á"); return; }
    if(data.error){ showError(data.error); return; }

    console.log("Received data:", data);

    // Set application number
    setTextSafe("applicationNoDisplay", data.application_no || '');

    // Set main fields
    const fields = [
        { static:'staticCustomerName', editable:'editableCustomerName', value: data.customer_name },
        { static:'staticFatherName', editable:'editableFatherName', value: data.father_name },
        { static:'staticAddress', editable:'editableAddress', value: data.address },
        { static:'staticMobileNo', editable:'editableMobileNo', value: data.mobile_no },
        { static:'staticNid', editable:'', value: data.nid }
    ];

    fields.forEach(f => {
        setTextSafe(f.static, f.value || '');
        if (f.editable) setInputSafe(f.editable, f.value || '');
    });

    // Set meter and consumer numbers based on type
    if(currentCustomerType === 'prepaid'){
        setTextSafe("staticMeterNo", currentInputNumber || '');
        setInputSafe("editableMeterNo", currentInputNumber || '');
        setTextSafe("staticConsumerNo", data.consumer_no || '');
        setInputSafe("editableConsumerNo", data.consumer_no || '');
    } else {
        setTextSafe("staticMeterNo", data.meter_no || '');
        setInputSafe("editableMeterNo", data.meter_no || '');
        setTextSafe("staticConsumerNo", currentInputNumber || '');
        setInputSafe("editableConsumerNo", currentInputNumber || '');
    }

    // Set additional fields
    setTextSafe("arrear", (data.arrear && data.arrear!=="0") ? data.arrear : "‡¶ï‡ßã‡¶® ‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶®‡ßá‡¶á");

    // Set recharge data
    const rechargeSection = document.getElementById("rechargeSection");
    if(rechargeSection){
        if(currentCustomerType === 'prepaid'){
            rechargeSection.style.display='block';
            const rechargeData = data.recharges || [];
            for(let i=1;i<=3;i++){
                setTextSafe(`rechargeDate${i}`, "");
                setTextSafe(`rechargeAmount${i}`, "");
            }
            let count=0;
            rechargeData.slice(0,3).forEach(r=>{
                count++;
                setTextSafe(`rechargeDate${count}`, r.Date||"");
                setTextSafe(`rechargeAmount${count}`, r.Amount||"");
            });
            for(let i=count+1;i<=3;i++){
                setTextSafe(`rechargeDate${i}`, "\u00A0");
                setTextSafe(`rechargeAmount${i}`, "\u00A0");
            }
        } else {
            rechargeSection.style.display='none';
        }
    }

    if(isEditMode) toggleEditMode();
    showFormSection();
}

function toggleEditMode(){
    isEditMode = !isEditMode;
    const editBtn = document.getElementById("editToggleBtn");
    if(isEditMode){
        document.querySelectorAll('.static-value').forEach(el=>el.classList.add('hidden'));
        document.querySelectorAll('.editable-field').forEach(el=>el.classList.remove('hidden'));
        if(editBtn) { editBtn.textContent='üíæ ‡¶è‡¶°‡¶ø‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®'; editBtn.style.backgroundColor='#28a745'; }
    } else {
        document.querySelectorAll('.static-value').forEach(el=>{
            const fieldId = el.id.replace('static','editable');
            const input = document.getElementById(fieldId);
            const v = input ? input.value : '';
            el.textContent = v || '';
            el.classList.remove('hidden');
        });
        document.querySelectorAll('.editable-field').forEach(el=>el.classList.add('hidden'));
        if(editBtn){ editBtn.textContent='‚úèÔ∏è ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®'; editBtn.style.backgroundColor='#ffc107'; }
        saveEditedData();
    }
}

function saveEditedData(){
    const editedData = {
        customerName: document.getElementById('editableCustomerName')?.value || '',
        fatherName: document.getElementById('editableFatherName')?.value || '',
        address: document.getElementById('editableAddress')?.value || '',
        mobileNo: document.getElementById('editableMobileNo')?.value || '',
        meterNo: document.getElementById('editableMeterNo')?.value || '',
        consumerNo: document.getElementById('editableConsumerNo')?.value || '',
        inputNumber: currentInputNumber,
        customerType: currentCustomerType
    };

    // Update application data
    applicationData.customer_name = editedData.customerName;
    applicationData.father_name = editedData.fatherName;
    applicationData.address = editedData.address;
    applicationData.mobile_no = editedData.mobileNo;
    applicationData.meter_no = editedData.meterNo;
    applicationData.consumer_no = editedData.consumerNo;

    saveApplicationToStorage();

    if(window.javaApp && typeof javaApp.saveEditedData === 'function'){
        try {
            javaApp.saveEditedData(JSON.stringify(editedData));
            showToast("‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
        } catch(e){
            console.warn("saveEditedData failed:", e);
            showToast("‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
        }
    } else {
        console.log("Edited data (no javaApp):", editedData);
    }
}

// ==================== SEARCH AND DATA FETCHING ====================
function selectType(t){
    selectedType=t;
    document.getElementById("prepaidBtn")?.classList.toggle("active", t==="prepaid");
    document.getElementById("postpaidBtn")?.classList.toggle("active", t==="postpaid");
    const input=document.getElementById("searchInput");
    if(input) input.placeholder = (t==='prepaid') ? '‡ßß‡ß® ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®' : '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®';
}

function showLoading(){
    const ld=document.getElementById("loading");
    if(ld) ld.style.display="block";
    const b=document.getElementById("searchBtn");
    if(b){ b.disabled=true; b.textContent="‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø..."; }
}

function hideLoading(){
    const ld=document.getElementById("loading");
    if(ld) ld.style.display="none";
    const b=document.getElementById("searchBtn");
    if(b){ b.disabled=false; b.textContent="‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®"; }
}

function showError(m){
    const e=document.getElementById("error");
    if(e){ e.textContent=m; e.style.display="block"; }
    hideLoading();
}

function hideError(){
    const e=document.getElementById("error");
    if(e) e.style.display="none";
}

// ==================== FIXED FETCH DATA FUNCTION ====================
async function fetchData() {
    hideError();
    const inputEl = document.getElementById("searchInput");
    if(!inputEl){
        showError("Internal error: search input not found");
        return;
    }

    const input = inputEl.value.trim();
    if(!input){
        showError("‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶®‡¶Ç ‡¶¨‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        return;
    }

    currentInputNumber = input;
    showLoading();

    // CRITICAL FIX: Reset applicationData for new search but preserve essential structure
    const tempAppData = { ...applicationData };
    applicationData = {
        customer_name: tempAppData.customer_name,
        father_name: tempAppData.father_name,
        address: tempAppData.address,
        mobile_no: tempAppData.mobile_no,
        consumer_no: tempAppData.consumer_no,
        meter_no: tempAppData.meter_no,
        arrear: tempAppData.arrear,
        recharges: tempAppData.recharges
    };

    try {
        let result;
        // Use AndroidInterface if available, otherwise use javaApp
        if(window.AndroidInterface && AndroidInterface.fetchDataForApplication){
            result = AndroidInterface.fetchDataForApplication(input, selectedType);
        } else if (window.javaApp && typeof javaApp.fetchDataForApplication === 'function') {
            result = javaApp.fetchDataForApplication(input, selectedType);
        } else {
            // Mock data for testing
            result = JSON.stringify({
                customer_name: "‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï",
                father_name: "‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶ø‡¶§‡¶æ",
                address: "‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ, ‡¶∏‡ßÅ‡¶®‡¶æ‡¶Æ‡¶ó‡¶û‡ßç‡¶ú",
                mobile_no: "017XXXXXXXX",
                consumer_no: selectedType === 'prepaid' ? "CONS123456" : input,
                meter_no: selectedType === 'prepaid' ? input : "MTR789012",
                arrear: "0",
                recharges: [
                    { Date: "2024-01-15", Amount: "500" },
                    { Date: "2024-01-10", Amount: "300" }
                ]
            });
        }

        // FIX: Proper JSON parsing with error handling
        let data;
        try {
            data = JSON.parse(result);
        } catch (parseError) {
            console.error("JSON Parse Error:", parseError);
            showError("‡¶°‡ßá‡¶ü‡¶æ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            hideLoading();
            return;
        }

        // Validate data structure
        if (!data || typeof data !== 'object') {
            showError("‡¶Ö‡¶¨‡ßà‡¶ß ‡¶°‡ßá‡¶ü‡¶æ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü");
            hideLoading();
            return;
        }

        currentCustomerType = selectedType;

        // Merge data properly
        applicationData = { ...applicationData, ...data };

        // Update preview section
        const previewCustomerName = document.getElementById("previewCustomerName");
        if (previewCustomerName) previewCustomerName.textContent = data.customer_name || 'N/A';

        const previewAddress = document.getElementById("previewAddress");
        if (previewAddress) previewAddress.textContent = data.address || 'N/A';

        const previewMobileNo = document.getElementById("previewMobileNo");
        if (previewMobileNo) previewMobileNo.textContent = data.mobile_no || 'N/A';

        const mobileInput = document.getElementById("mobileInput");
        if (mobileInput) mobileInput.value = data.mobile_no || '';

        showDataCollectionSection();

    } catch(err) {
        console.error("Data fetch error:", err);
        showError("‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: " + (err.message || err));
    } finally {
        hideLoading();
    }
}

// ==================== PRINT AND EXPORT ====================
function printApplication() {
    if(window.javaApp && typeof javaApp.printApplication === 'function'){
        try {
            javaApp.printApplication();
        } catch(e){
            console.error("Print failed:", e);
            window.print(); // fallback to browser print
        }
    } else {
        window.print(); // fallback to browser print
    }
}

function saveAsPDF() {
    if (window.AndroidInterface && AndroidInterface.saveAsPDF) {
        AndroidInterface.saveAsPDF();
    } else if (window.javaApp && typeof javaApp.saveAsPDF === 'function') {
        try {
            javaApp.saveAsPDF();
        } catch(e){
            console.error("PDF save failed:", e);
            showToast("PDF ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
        }
    } else {
        showToast("PDF ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡¶Ø‡¶º");
        window.print();
    }
}

function showToast(message) {
    if(window.javaApp && typeof javaApp.showToast === 'function'){
        javaApp.showToast(message);
    } else {
        alert(message);
    }
}

function closeForm(){
    if(window.javaApp && typeof javaApp.closeApplication === 'function'){
        javaApp.closeApplication();
    }
}
function openExcelView() {
    if (window.AndroidInterface && AndroidInterface.openExcelView) {
        AndroidInterface.openExcelView();
    } else {
        // Fallback: Show message
        alert("excel view not working");
    }
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    // Set default values
    window.selectedType = 'prepaid';
    window.currentCustomerType = 'prepaid';
    window.currentInputNumber = '';
    window.isEditMode = false;

    selectType(selectedType);
    showLogin();

    // Wire up events
    const searchInput = document.getElementById("searchInput");
    if(searchInput) searchInput.addEventListener("keypress", function(e){
        if(e.key === "Enter") fetchData();
    });

    const searchBtn = document.getElementById("searchBtn");
    if(searchBtn) searchBtn.addEventListener("click", fetchData);
});
</script>
</body>
</html>
